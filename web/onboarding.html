<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Measurely – Connect to Wi-Fi</title>

<link rel="icon" type="image/svg+xml" href="icons/dave.svg">
<link rel="stylesheet" href="measurely.css">

<style>
/* ======================================================
   MEASURELY CAPTIVE PORTAL (AP MODE)
   ====================================================== */

html, body {
  height: 100%;
  margin: 0;
  background:
    radial-gradient(900px 500px at 15% 10%, rgba(124,92,255,0.35), transparent 60%),
    radial-gradient(800px 600px at 85% 25%, rgba(99,102,241,0.25), transparent 65%),
    radial-gradient(600px 600px at 50% 85%, rgba(45,212,191,0.18), transparent 60%),
    #0b0f1a;
  color: #e5e7eb;
  font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

body {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1.25rem;
}

/* Outer container */
.portal-wrap {
  width: min(520px, 100%);
}

/* Brand header */
.brand {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1.25rem;
}

.brand-logo {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  background: linear-gradient(135deg, #7c5cff, #5b6cff);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 10px 30px rgba(124,92,255,0.45);
}

.brand h1 {
  font-size: 1.45rem;
  margin: 0;
}

.brand p {
  margin: 0;
  font-size: 0.9rem;
  color: rgba(255,255,255,0.65);
}

/* Main card */
.portal-card {
  background:
    linear-gradient(
      180deg,
      rgba(255,255,255,0.08),
      rgba(255,255,255,0.02)
    );
  border-radius: 22px;
  padding: 1.75rem;
  backdrop-filter: blur(18px);
  box-shadow:
    0 40px 90px rgba(0,0,0,0.65),
    inset 0 1px 0 rgba(255,255,255,0.08);
}

/* Inner panel */
.panel {
  background:
    linear-gradient(
      180deg,
      rgba(13,17,35,0.9),
      rgba(13,17,35,0.75)
    );
  border-radius: 16px;
  padding: 1.25rem;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,0.05);
}

/* Inputs */
label {
  font-size: 0.85rem;
  color: rgba(255,255,255,0.65);
}

.input {
  width: 100%;
  padding: 0.8rem 0.9rem;
  margin-top: 0.35rem;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  color: #fff;
}

.input::placeholder {
  color: rgba(255,255,255,0.35);
}

.input:focus {
  outline: none;
  border-color: rgba(124,92,255,0.85);
  box-shadow: 0 0 0 3px rgba(124,92,255,0.35);
}

/* Status pills */
.pill {
  display: inline-flex;
  align-items: center;
  gap: 0.45rem;
  padding: 0.35rem 0.7rem;
  border-radius: 999px;
  font-size: 0.85rem;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
}

.dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255,255,255,0.4);
}

.dot.warn { background: #fbbf24; }
.dot.ok { background: #22c55e; }
.dot.bad { background: #ef4444; }

/* Buttons */
.actions {
  display: flex;
  gap: 0.75rem;
  align-items: center;
  margin-top: 1.25rem;
}

/* Footer text */
.footer {
  margin-top: 1.25rem;
  font-size: 0.85rem;
  color: rgba(255,255,255,0.55);
  line-height: 1.5;
  text-align: center;
}
</style>
</head>

<body>

<div class="portal-wrap">

  <div class="brand">
    <div class="brand-logo">
      <img src="icons/signal.svg" alt="" style="width:22px;">
    </div>
    <div>
      <h1>Connect Measurely to Wi-Fi</h1>
      <p>You’re connected to <strong>MeasurelyConnect</strong></p>
    </div>
  </div>

  <div class="portal-card">

    <div class="panel">

      <div style="display:flex; gap:0.75rem; align-items:center; margin-bottom:1rem;">
        <button id="scanBtn" class="btn btn-secondary">Scan networks</button>
        <span id="scanStatus" class="pill">
          <span class="dot warn"></span>
          <span>Ready</span>
        </span>
      </div>

      <div style="display:grid; gap:0.9rem;">
        <div>
          <label>Wi-Fi network</label>
          <select id="ssidSelect" class="input">
            <option value="">Select a network…</option>
          </select>
        </div>

        <div>
          <label>Password</label>
          <input id="passwordInput" type="password" class="input" placeholder="Wi-Fi password">
        </div>
      </div>

      <div class="actions">
        <button id="connectBtn" class="btn btn-primary">
          Connect & restart
        </button>
        <span id="connectStatus" class="pill">
          <span class="dot warn"></span>
          <span>Waiting</span>
        </span>
      </div>

    </div>

    <div class="footer">
      After connecting, Measurely will restart and this page will disconnect.<br>
      Reconnect on your normal Wi-Fi and visit <strong>measurely.local</strong>.
    </div>

  </div>
</div>

<script>
const scanBtn = document.getElementById('scanBtn');
const connectBtn = document.getElementById('connectBtn');
const ssidSelect = document.getElementById('ssidSelect');
const passwordInput = document.getElementById('passwordInput');

function setPill(id, state, text) {
  const el = document.getElementById(id);
  el.querySelector('.dot').className = 'dot ' + state;
  el.querySelector('span:last-child').textContent = text;
}

async function api(path, opts = {}) {
  const res = await fetch(path, {
    headers: { 'Content-Type': 'application/json' },
    ...opts
  });
  try { return await res.json(); } catch { return {}; }
}

scanBtn.onclick = async () => {
  scanBtn.disabled = true;
  setPill('scanStatus', 'warn', 'Scanning…');

  const data = await api('/api/network/scan');
  ssidSelect.innerHTML = '<option value="">Select a network…</option>';

  if (data.ok && Array.isArray(data.networks)) {
    data.networks.forEach(n => {
      if (!n.ssid) return;
      const o = document.createElement('option');
      o.value = n.ssid;
      o.textContent = n.signal != null ? `${n.ssid} (${n.signal}%)` : n.ssid;
      ssidSelect.appendChild(o);
    });
    setPill('scanStatus', 'ok', `Found ${data.networks.length}`);
  } else {
    setPill('scanStatus', 'bad', 'Scan failed');
  }

  scanBtn.disabled = false;
};

connectBtn.onclick = async () => {
  const ssid = ssidSelect.value;
  const password = passwordInput.value;

  if (!ssid) {
    setPill('connectStatus', 'bad', 'Select a network');
    return;
  }

  connectBtn.disabled = true;
  setPill('connectStatus', 'warn', 'Connecting…');

  const res = await api('/api/network/connect', {
    method: 'POST',
    body: JSON.stringify({ ssid, password })
  });

  if (!res.ok) {
    setPill('connectStatus', 'bad', 'Failed');
    connectBtn.disabled = false;
    return;
  }

  setPill('connectStatus', 'ok', 'Restarting…');
};
</script>

</body>
</html>
