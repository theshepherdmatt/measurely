<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Measurely – Frequency Analysis</title>
  <link rel="stylesheet" href="measurely.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.0.3/plotly.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- same small inline styles as dashboard --- */
    .plot-container { background: transparent !important; }
    .modebar { display: none !important; }
    .card-sky   { background-color: #f0f9ff; }
    .card-amber { background-color: #fffbeb; }

    /* toast notifications */
    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: .75rem 1rem;
      border-radius: .5rem;
      color: #fff;
      font-size: .875rem;
      z-index: 50;
      transition: transform .3s, opacity .3s;
      transform: translateX(120%);
      opacity: 0;
    }
    .toast.show { transform: translateX(0); opacity: 1; }
    .toast.error   { background: #ef4444; }
    .toast.success { background: #10b981; }
    .toast.info    { background: #3b82f6; }
  </style>
</head>

<body class="bg-gray-50">

<!-- =====  MOBILE MENU  ===== -->
<button id="mobile-menu-btn" class="mobile-menu-button fixed top-4 right-4 z-50 p-2 rounded-lg bg-gray-900/80 text-white backdrop-blur-sm">
  <i class="fas fa-bars text-xl"></i>
</button>
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<!-- =====  SIDEBAR  ===== -->
<aside id="sidebar" class="sidebar gradient-bg fixed top-0 right-0 h-full w-64 text-white p-6 z-40">
  <div class="mb-8">
    <h1 class="text-2xl font-bold mb-2">Measurely</h1>
    <p class="text-sm opacity-80">Room Acoustic Analysis</p>
  </div>

  <nav class="space-y-2">
    <a href="index.html" class="nav-item"><i class="fas fa-chart-line mr-3"></i>Dashboard</a>
    <a href="analysis.html" class="nav-item active"><i class="fas fa-wave-square mr-3"></i>Frequency Analysis</a>
    <a href="recommendations.html" class="nav-item"><i class="fas fa-lightbulb mr-3"></i>Recommendations</a>
    <a href="room-setup.html" class="nav-item"><i class="fas fa-home mr-3"></i>Room Setup</a>
    <a href="sessions.html" class="nav-item"><i class="fas fa-history mr-3"></i>Sessions</a>
    <a href="settings.html" class="nav-item"><i class="fas fa-cog mr-3"></i>Settings</a>
  </nav>

  <div class="absolute bottom-6 left-6 right-6">
    <div class="bg-white bg-opacity-20 rounded-lg p-4">
      <div class="flex items-center mb-2">
        <div id="deviceStatusIndicator" class="status-indicator status-good pulse-animation"></div>
        <span id="deviceStatusText" class="text-sm">System Ready</span>
      </div>
      <p class="text-xs opacity-80">Last updated: <span id="lastUpdated">Now</span></p>
    </div>
  </div>
</aside>

<!-- =====  MAIN CONTENT  ===== -->
<div class="main-content ml-64 p-8">
  <div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Frequency Analysis</h2>
    <p class="text-gray-600">Detailed frequency-domain analysis using your latest sweep data</p>
  </div>

  <!-- Charts Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Spectrum -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-chart-area mr-2"></i>Spectrum Analyzer</h3>
      <p class="text-sm text-gray-600 mb-4">Real-time frequency content of your audio signal</p>
      <div id="spectrum-chart" style="height: 300px;"></div>
      <div class="mt-4 text-sm text-gray-600">
        <p><strong>What this shows:</strong> The energy distribution across different frequencies</p>
        <p><strong>Good for:</strong> Identifying noise, checking frequency balance</p>
        <p><strong>Look for:</strong> Balanced response across bass, mid, and treble</p>
      </div>
    </div>

    <!-- THD -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-chart-bar mr-2"></i>THD Analysis</h3>
      <p class="text-sm text-gray-600 mb-4">Total Harmonic Distortion across frequency bands</p>
      <div id="thd-chart" style="height: 300px;"></div>
      <div class="mt-4 text-sm text-gray-600">
        <p><strong>What this shows:</strong> How clean/distorted your audio is</p>
        <p><strong>Good for:</strong> Assessing audio quality, identifying problems</p>
        <p><strong>Look for:</strong> Lower values = cleaner audio (&lt;1% is good)</p>
      </div>
    </div>
  </div>

  <!-- Frequency Band Summary -->
  <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
    <h3 class="text-xl font-semibold text-gray-800 mb-6">Frequency Band Summary</h3>
    <div id="band-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
      <!-- Filled by JS -->
    </div>
    <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-700">
      <strong>Band guide:</strong>
      <span class="mx-2 text-blue-600">Bass 20-200 Hz</span>
      <span class="mx-2 text-green-600">Mid 200-2 kHz</span>
      <span class="mx-2 text-yellow-600">Treble 2-10 kHz</span>
      <span class="mx-2 text-purple-600">Air 10-20 kHz</span>
    </div>
  </div>

  <!-- Reading Guide -->
  <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
    <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-info-circle mr-2"></i>How to Read Your Analysis</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-gray-600">
      <div>
        <h4 class="font-semibold text-gray-800 mb-2">Good Response Characteristics</h4>
        <ul class="space-y-1">
          <li>✓ Relatively flat overall response (±3 dB variation)</li>
          <li>✓ Smooth transitions between frequency bands</li>
          <li>✓ Low THD throughout audible range (&lt;1%)</li>
          <li>✓ No severe peaks or dips (&gt;10 dB)</li>
          <li>✓ Appropriate bass extension for room size</li>
        </ul>
      </div>
      <div>
        <h4 class="font-semibold text-gray-800 mb-2">Common Issues to Look For</h4>
        <ul class="space-y-1">
          <li>⚠ Large bass boost (boomy sound)</li>
          <li>⚠ Midrange dip (dull, unclear sound)</li>
          <li>⚠ Treble peaks (harsh, fatiguing sound)</li>
          <li>⚠ High THD in bass (muddy bass)</li>
          <li>⚠ Room-mode peaks/dips (uneven response)</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="flex flex-wrap gap-4">
    <button id="saveBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center"><i class="fas fa-save mr-2"></i>Save Analysis</button>
    <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center"><i class="fas fa-share mr-2"></i>Export Charts</button>
    <button id="recommendBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center"><i class="fas fa-lightbulb mr-2"></i>Get Recommendations</button>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<!-- =====  SCRIPTS  ===== -->
<script>
/* ----------  Sidebar toggle (same as dashboard) ---------- */
const btn  = document.getElementById('mobile-menu-btn');
const side = document.getElementById('sidebar');
const over = document.getElementById('sidebar-overlay');

function toggleMenu() {
  side.classList.toggle('active');
  over.classList.toggle('active');
  document.body.style.overflow = side.classList.contains('active') ? 'hidden' : '';
}
btn.addEventListener('click', toggleMenu);
over.addEventListener('click', toggleMenu);

document.querySelectorAll('.nav-item').forEach(link => {
  link.addEventListener('click', () => {
    if (window.innerWidth <= 768) {
      side.classList.remove('active');
      over.classList.remove('active');
      document.body.style.overflow = '';
    }
  });
});

/* ----------  Toast notifications ---------- */
function toast(msg, type = 'info') {
  const box = document.createElement('div');
  box.className = `toast ${type}`;
  box.textContent = msg;
  document.getElementById('toast-container').appendChild(box);
  setTimeout(() => box.classList.add('show'), 10);
  setTimeout(() => {
    box.classList.remove('show');
    setTimeout(() => box.remove(), 300);
  }, 3000);
}

/* ----------  Fetch & render ---------- */
let currentData = null;

async function loadData() {
  try {
    const res = await fetch('/api/latest');
    if (!res.ok) throw new Error('Network response was not ok');
    currentData = await res.json();
    renderCharts();
    renderBandSummary();
  } catch (err) {
    console.error(err);
    toast('Could not load measurement data', 'error');
  }
}

/* ----------  Spectrum & THD charts ---------- */
function renderCharts() {
  if (!currentData || !currentData.freq_hz) return;

  // Spectrum
  const spectrumTrace = {
    x: currentData.freq_hz,
    y: currentData.mag_db,
    type: 'scatter',
    mode: 'lines',
    fill: 'tozeroy',
    line: { color: '#3b82f6' },
    name: 'Spectrum'
  };
  const spectrumLayout = {
    xaxis: { title: 'Frequency (Hz)', type: 'log', color: '#111', gridcolor: '#e5e7eb' },
    yaxis: { title: 'Magnitude (dB)', color: '#111', gridcolor: '#e5e7eb' },
    margin: { t: 20, r: 20, b: 60, l: 60 },
    plot_bgcolor: '#fff',
    paper_bgcolor: '#fff',
    font: { color: '#111' },
    displayModeBar: false,
    staticPlot: true
  };
  Plotly.newPlot('spectrum-chart', [spectrumTrace], spectrumLayout, { responsive: true });

  // THD (mock for now – replace with real THD data when available)
  const thdTrace = {
    x: [100, 200, 500, 1000, 2000, 5000],
    y: [0.1, 0.05, 0.02, 0.01, 0.03, 0.08],
    type: 'bar',
    marker: { color: '#10b981' }
  };
  const thdLayout = {
    xaxis: { title: 'Frequency (Hz)' },
    yaxis: { title: 'THD (%)' },
    margin: { t: 20, r: 20, b: 60, l: 60 },
    displayModeBar: false,
    staticPlot: true
  };
  Plotly.newPlot('thd-chart', [thdTrace], thdLayout, { responsive: true });
}

/* ----------  Band summary cards ---------- */
function renderBandSummary() {
  if (!currentData || !currentData.freq_hz) return;

  const { freq_hz, mag_db } = currentData;
  const bands = [
    { name: 'Bass',  range: [20, 200],   color: 'blue'   },
    { name: 'Mid',   range: [200, 2000], color: 'green'  },
    { name: 'Treble',range: [2000, 10000],color: 'yellow' },
    { name: 'Air',   range: [10000, 20000],color: 'purple'}
  ];

  const html = bands.map(b => {
    let sum = 0, cnt = 0;
    for (let i = 0; i < freq_hz.length; i++) {
      const f = freq_hz[i];
      if (f >= b.range[0] && f <= b.range[1]) {
        sum += mag_db[i];
        cnt++;
      }
    }
    const avg = cnt ? (sum / cnt).toFixed(1) : '--';
    const width = Math.max(0, Math.min(100, ((parseFloat(avg) + 20) / 40) * 100));
    const colorMap = { blue: '#3b82f6', green: '#10b981', yellow: '#f59e0b', purple: '#8b5cf6' };
    const bgMap   = { blue: '#dbeafe', green: '#d1fae5', yellow: '#fef3c7', purple: '#ede9fe' };
    return `
      <div class="text-center p-4 rounded-lg" style="background:${bgMap[b.color]}">
        <div class="text-2xl font-bold mb-1" style="color:${colorMap[b.color]}">${avg} dB</div>
        <div class="text-sm text-gray-700 font-semibold">${b.name}</div>
        <div class="text-xs text-gray-500">${b.range[0]}-${b.range[1]} Hz</div>
        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
          <div class="h-2 rounded-full" style="width:${width}%;background:${colorMap[b.color]}"></div>
        </div>
      </div>`;
  }).join('');
  document.getElementById('band-summary').innerHTML = html;
}

/* ----------  Action buttons ---------- */
document.getElementById('saveBtn').addEventListener('click', () => {
  if (!currentData) return toast('No data to save', 'error');
  const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `analysis_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('Analysis saved', 'success');
});

document.getElementById('exportBtn').addEventListener('click', () => {
  toast('Export charts – feature coming soon', 'info');
});

document.getElementById('recommendBtn').addEventListener('click', () => {
  window.location.href = 'recommendations.html';
});

/* ----------  Clock ---------- */
setInterval(() => {
  const el = document.getElementById('lastUpdated');
  if (el) el.textContent = new Date().toLocaleTimeString();
}, 1000);

/* ----------  Init ---------- */
document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>