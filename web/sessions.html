<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Measurely – Sessions</title>

  <link rel="stylesheet" href="measurely.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    .session-card{transition:box-shadow .2s}.session-card:hover{box-shadow:0 10px 15px -3px rgb(0 0 0 / .1),0 4px 6px -4px rgb(0 0 0 / .1)}
    .status-dot{width:.75rem;height:.75rem;border-radius:9999px}
    .status-great{background:#10b981}.status-good{background:#84cc16}.status-ok{background:#f59e0b}.status-poor{background:#ef4444}
    .toast{position:fixed;top:1rem;right:1rem;padding:.75rem 1rem;border-radius:.5rem;color:#fff;font-size:.875rem;z-index:50;transform:translateX(120%);opacity:0;transition:transform .3s,opacity .3s}
    .toast.show{transform:translateX(0);opacity:1}
    .toast.error{background:#ef4444}.toast.success{background:#10b981}.toast.info{background:#3b82f6}
  </style>
</head>

<body class="bg-gray-50 min-h-screen">

<!-- =====  MOBILE MENU  ===== -->
<button id="mobile-menu-btn" class="mobile-menu-button fixed top-4 right-4 z-50 p-2 rounded-lg bg-gray-900/80 text-white backdrop-blur-sm">
  <i class="fas fa-bars text-xl"></i>
</button>
<div id="sidebar-overlay" class="sidebar-overlay"></div>

  <!-- =====  SIDEBAR  ===== -->
  <aside id="sidebar" class="sidebar gradient-bg fixed top-0 right-0 h-full w-64 text-white p-6 z-40">
    <div class="mb-8 flex items-center space-x-3">
      <i class="fas fa-microchip text-3xl opacity-90"></i>
      <div>
        <h1 class="text-2xl font-bold">Measurely</h1>
        <p class="text-sm opacity-80">Room Acoustic Analysis</p>
      </div>
    </div>

    <nav class="space-y-2">
      <a href="index.html" class="nav-item"><i class="fas fa-chart-line mr-3"></i>Dashboard</a>
      <a href="analysis.html" class="nav-item"><i class="fas fa-wave-square mr-3"></i>Frequency Analysis</a>
      <a href="recommendations.html" class="nav-item"><i class="fas fa-lightbulb mr-3"></i>Recommendations</a>
      <a href="room-setup.html" class="nav-item"><i class="fas fa-home mr-3"></i>Room Setup</a>
      <a href="sessions.html" class="nav-item active"><i class="fas fa-history mr-3"></i>Sessions</a>
      <a href="settings.html" class="nav-item"><i class="fas fa-cog mr-3"></i>Settings</a>
    </nav>

    <div class="absolute bottom-6 left-6 right-6">
      <div class="bg-white bg-opacity-20 rounded-lg p-4">
        <div class="flex items-center mb-2">
          <div id="deviceStatusIndicator" class="status-indicator status-good pulse-animation"></div>
          <span id="deviceStatusText" class="text-sm">System Ready</span>
        </div>
        <p class="text-xs opacity-80">Last updated: <span id="lastUpdated">Now</span></p>
      </div>
    </div>
  </aside>

<!-- =====  MAIN CONTENT  ===== -->
<div class="main-content ml-64 p-8">
  <div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Session Management</h2>
    <p class="text-gray-600">Track your measurement sessions and analyse historical data</p>
  </div>

  <!--  LIVE CURRENT SESSION  -->
  <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-gray-800"><i class="fas fa-play-circle mr-2"></i>Current Session</h2>
      <div class="flex space-x-2" id="currentControls">
        <button id="newSessionBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"><i class="fas fa-plus mr-2"></i>New Sweep</button>
        <button id="stopSessionBtn" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg"><i class="fas fa-stop mr-2"></i>Stop</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div class="text-center p-4 bg-gray-50 rounded-lg">
        <div class="text-2xl font-bold text-gray-800" id="session-duration">--:--:--</div>
        <div class="text-sm text-gray-600">Duration</div>
      </div>
      <div class="text-center p-4 bg-gray-50 rounded-lg">
        <div class="text-2xl font-bold text-gray-800" id="measurements-count">0</div>
        <div class="text-sm text-gray-600">Measurements</div>
      </div>
      <div class="text-center p-4 bg-gray-50 rounded-lg">
        <div class="text-2xl font-bold text-gray-600" id="session-status">Idle</div>
        <div class="text-sm text-gray-600">Status</div>
      </div>
    </div>

    <div class="mt-4">
      <div class="flex justify-between text-sm text-gray-600 mb-2">
        <span>Progress</span>
        <span id="progress-pct">0%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progress-bar" class="bg-green-500 h-2 rounded-full" style="width: 0%;"></div>
      </div>
    </div>
  </div>

  <!--  SESSION HISTORY  -->
  <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-history mr-2"></i>Session History</h2>
    <div id="sessions-list" class="space-y-3"><!-- filled by JS --></div>
    <div id="no-sessions" class="hidden text-center py-10 text-gray-500">
      <i class="fas fa-inbox text-4xl mb-3"></i>
      <p>No sessions yet – run your first sweep!</p>
    </div>
  </div>

  <!--  GLOBAL STATS  -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="bg-white rounded-2xl shadow-lg p-4 text-center">
      <div class="text-2xl font-bold text-gray-800" id="total-sessions">0</div>
      <div class="text-sm text-gray-600">Total Sessions</div>
    </div>
    <div class="bg-white rounded-2xl shadow-lg p-4 text-center">
      <div class="text-2xl font-bold text-gray-800" id="total-measurements">0</div>
      <div class="text-sm text-gray-600">Total Measurements</div>
    </div>
    <div class="bg-white rounded-2xl shadow-lg p-4 text-center">
      <div class="text-2xl font-bold text-gray-800" id="total-hours">0</div>
      <div class="text-sm text-gray-600">Hours Analysed</div>
    </div>
    <div class="bg-white rounded-2xl shadow-lg p-4 text-center">
      <div class="text-2xl font-bold text-green-600" id="avg-score">--</div>
      <div class="text-sm text-gray-600">Avg Score</div>
    </div>
  </div>
</div>

<!-- =====  TOAST CONTAINER  ===== -->
<div id="toast-container"></div>

<!-- =====  SCRIPTS  ===== -->
<script>
/* ----------  Sidebar  ---------- */
const btn  = document.getElementById('mobile-menu-btn');
const side = document.getElementById('sidebar');
const over = document.getElementById('sidebar-overlay');
function toggleMenu(){
  side.classList.toggle('active');
  over.classList.toggle('active');
  document.body.style.overflow = side.classList.contains('active') ? 'hidden' : '';
}
btn.addEventListener('click', toggleMenu);
over.addEventListener('click', toggleMenu);
document.querySelectorAll('.nav-item').forEach(link=>
  link.addEventListener('click',()=>{if(window.innerWidth<=768)toggleMenu()}));

/* ----------  Toast  ---------- */
function toast(msg,type='info'){
  const box=document.createElement('div');box.className=`toast ${type}`;box.textContent=msg;
  document.getElementById('toast-container').appendChild(box);
  setTimeout(()=>box.classList.add('show'),10);
  setTimeout(()=>{box.classList.remove('show');setTimeout(()=>box.remove(),300)},3000);
}

/* ----------  Current Session  ---------- */
let sweepPoll=null,sessionStart=null,clockTimer=null;

async function fetchSweepProgress(){
  try{
    const r=await fetch('/api/sweep-progress');if(!r.ok)return;
    const p=await r.json();
    const statusEl=document.getElementById('session-status');
    const durEl=document.getElementById('session-duration');
    const measEl=document.getElementById('measurements-count');
    const bar=document.getElementById('progress-bar');
    const pct=document.getElementById('progress-pct');
    const newBtn=document.getElementById('newSessionBtn');
    const stopBtn=document.getElementById('stopSessionBtn');

    if(p.running){
      if(!sessionStart){sessionStart=Date.now();startClock();}
      statusEl.textContent='Running';statusEl.className='text-2xl font-bold text-green-600';
      bar.style.width=`${p.progress||0}%`;pct.textContent=`${p.progress||0}%`;
      newBtn.classList.add('hidden');stopBtn.classList.remove('hidden');
    }else{
      statusEl.textContent='Idle';statusEl.className='text-2xl font-bold text-gray-600';
      bar.style.width='0%';pct.textContent='0%';
      newBtn.classList.remove('hidden');stopBtn.classList.add('hidden');
      stopClock();sessionStart=null;
      if(p.progress>=100){toast('Sweep completed','success');loadSessions();}
    }
  }catch(e){console.error(e)}
}
function startClock(){
  if(clockTimer)return;
  clockTimer=setInterval(()=>{
    const dur=Date.now()-sessionStart;
    const h=String(Math.floor(dur/3.6e6)).padStart(2,'0');
    const m=String(Math.floor(dur/6e4)%60).padStart(2,'0');
    const s=String(Math.floor(dur/1e3)%60).padStart(2,'0');
    document.getElementById('session-duration').textContent=`${h}:${m}:${s}`;
  },1000);
}
function stopClock(){clearInterval(clockTimer);clockTimer=null;}

/* ----------  Start / Stop Sweep  ---------- */
document.getElementById('newSessionBtn').addEventListener('click',async()=>{
  try{
    const r=await fetch('/api/run-sweep',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})});
    if(!r.ok)throw new Error((await r.json()).error||'Start failed');
    toast('Sweep started','success');
  }catch(e){toast(e.message,'error')}
});
document.getElementById('stopSessionBtn').addEventListener('click',async()=>{
  try{
    const r=await fetch('/api/stop-sweep',{method:'POST'});
    if(!r.ok)throw new Error('Stop failed');
    toast('Sweep stopped','info');
  }catch(e){toast(e.message,'error')}
});

<!-- =====  PASTE INSIDE YOUR EXISTING <script>  ===== -->
/* ----------  REAL ACTION BUTTONS  ---------- */
async function viewSession(id){
  // open detail page in new tab
  window.open(`session-detail.html?session=${encodeURIComponent(id)}`, '_blank');
}

async function loadSession(id){
  if(!confirm(`Load session “${id}” and replace current data?`)) return;
  try{
    const r=await fetch(`/api/session/${encodeURIComponent(id)}/load`,{method:'POST'});
    if(!r.ok) throw new Error((await r.json()).error||'Load failed');
    toast('Session loaded – redirecting…','success');
    location.href='index.html';               // dashboard shows new data
  }catch(e){toast(e.message,'error')}
}

async function deleteSession(id){
  if(!confirm(`Delete session “${id}” permanently?`)) return;
  try{
    const r=await fetch(`/api/session/${encodeURIComponent(id)}`,{method:'DELETE'});
    if(!r.ok) throw new Error((await r.json()).error||'Delete failed');
    toast('Session deleted','success');
    loadSessions();                           // refresh list
  }catch(e){toast(e.message,'error')}
}


/* ----------  Session History  ---------- */
async function loadSessions(){
  try{
    const r=await fetch('/api/sessions');if(!r.ok)throw new Error(r.statusText);
    const list=await r.json();
    renderSessions(list);
  }catch(e){toast('Could not load sessions','error');console.error(e)}
}
function renderSessions(sessions){
  const container=document.getElementById('sessions-list');
  const empty=document.getElementById('no-sessions');
  const totalSes=document.getElementById('total-sessions');
  const totalMeas=document.getElementById('total-measurements');
  const totalHrs=document.getElementById('total-hours');
  const avgScore=document.getElementById('avg-score');

  let totMeas=0,totScore=0,scored=0;

  if(!sessions.length){
    container.innerHTML='';empty.classList.remove('hidden');
    totalSes.textContent='0';totalMeas.textContent='0';totalHrs.textContent='0';avgScore.textContent='--';
    return;
  }
  empty.classList.add('hidden');
  container.innerHTML=sessions.map(s=>{
    const when=new Date(s.timestamp).toLocaleString();
    const room=s.room||'Unknown Room';
    const L=s.length||0,W=s.width||0,H=s.height||0;
    const dims=(L&&W&&H)?`${L.toFixed(1)}×${W.toFixed(1)}×${H.toFixed(1)} m`:'Dims N/A';
    const score=s.overall_score;
    const meas=s.freq_hz?s.freq_hz.length:0;
    const status=s.has_analysis?'Completed':'Paused';
    const dot=scoreColour(score);
    totMeas+=meas;if(typeof score==='number'&&!isNaN(score)){totScore+=score;scored++;}
    return`
      <div class="session-card bg-gray-50 p-4 rounded-lg">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div class="status-dot ${dot} mr-3"></div>
            <div>
              <h3 class="text-gray-800 font-medium">${s.id}</h3>
              <p class="text-gray-600 text-sm">${when}</p>
            </div>
          </div>
          <div class="text-right">
            <div class="text-gray-800 font-semibold">${meas} measurements</div>
            <div class="text-gray-500 text-sm">${status}</div>
          </div>
        </div>
        <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
          <span><i class="fas fa-map-marker-alt mr-2"></i>${room} • ${dims}</span>
          <span><i class="fas fa-chart-line mr-2"></i>${scoreText(score)}</span>
        </div>
        <div class="mt-3 flex items-center justify-end space-x-2">
          <button onclick="viewSession('${s.id}')" class="text-blue-600 hover:underline text-sm">View</button>
          <button onclick="loadSession('${s.id}')" class="text-green-600 hover:underline text-sm">Load</button>
          <button onclick="deleteSession('${s.id}')" class="text-red-600 hover:underline text-sm">Delete</button>
        </div>
      </div>`;
  }).join('');

  totalSes.textContent=sessions.length;
  totalMeas.textContent=totMeas;
  totalHrs.textContent=(totMeas/48000/3600).toFixed(1);
  avgScore.textContent=scored?(totScore/scored).toFixed(1):'--';
}
function scoreColour(score){
  if(typeof score!=='number'||isNaN(score))return'';
  if(score>=8)return'status-great';if(score>=6)return'status-good';if(score>=4)return'status-ok';return'status-poor';
}
function scoreText(score){
  if(typeof score!=='number'||isNaN(score))return'Score N/A';return`Score: ${score.toFixed(1)}/10`;
}

/* ----------  REAL ACTION BUTTONS  ---------- */
async function viewSession(id){
  // same as load but silent: copy session → live data, stay on page
  try{
    const r=await fetch(`/api/session/${encodeURIComponent(id)}/load`,{method:'POST'});
    if(!r.ok) throw new Error((await r.json()).error||'Load failed');
    toast('Session loaded – open Dashboard to see it','success');
  }catch(e){toast(e.message,'error')}
}

async function loadSession(id){
  if(!confirm(`Load session “${id}” and replace current data?`)) return;
  await viewSession(id);          // reuse logic
  location.href='index.html';     // then go to dashboard
}

async function deleteSession(id){
  if(!confirm(`Delete session “${id}” permanently?`)) return;
  try{
    const r=await fetch(`/api/session/${encodeURIComponent(id)}`,{method:'DELETE'});
    if(!r.ok) throw new Error((await r.json()).error||'Delete failed');
    toast('Session deleted','success');
    loadSessions();
  }catch(e){toast(e.message,'error')}
}
/* ----------  END REAL ACTION BUTTONS  ---------- */

/* ----------  Device Status  ---------- */
async function refreshDeviceStatus(){
  try{
    const r=await fetch('/api/status');if(!r.ok)return;
    const d=await r.json();
    const ind=document.getElementById('deviceStatusIndicator');
    const txt=document.getElementById('deviceStatusText');
    if(d.ready){ind.className='status-indicator status-good pulse-animation';txt.textContent='System Ready';}
    else{ind.className='status-indicator status-warning pulse-animation';txt.textContent='Device Check Required';}
  }catch(e){console.error(e)}
}

/* ----------  Init  ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  loadSessions();refreshDeviceStatus();
  sweepPoll=setInterval(fetchSweepProgress,1000);
  setInterval(refreshDeviceStatus,5000);
  setInterval(()=>{
    const el=document.getElementById('lastUpdated');
    if(el)el.textContent=new Date().toLocaleTimeString();
  },1000);
});
</script>
</body>
</html>