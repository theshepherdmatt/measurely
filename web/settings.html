<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Measurely — Settings</title>
  <link rel="icon" type="image/png" href="./favicon.png">
  <link rel="stylesheet" href="./style.css">
  <style>
    /* header alignment (same as index) */
    header { display:flex; align-items:center; justify-content:space-between; }
    .hamburger { display:inline-flex; flex-direction:column; gap:5px; padding:8px; border:0; background:none; cursor:pointer; }
    .hamburger span { display:block; width:26px; height:2px; background:#fff; }
    .menu { position:absolute; top:56px; right:12px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px 0; box-shadow:0 6px 24px rgba(0,0,0,.12); }
    .menu[hidden]{ display:none !important; }
    .menu a { display:block; padding:8px 14px; text-decoration:none; color:#333; }
    .menu a:hover { text-decoration:underline; }

    /* Camilla card preview area */
    #camillaPreview {
      white-space: pre-wrap; word-break: break-word;
      max-height: 320px; overflow: auto;
      border: 1px solid var(--border, #000); border-radius: 10px;
      padding: 10px; background: #fff;
    }
  </style>
</head>

<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <header role="banner">
    <img src="./measurely.svg" alt="Measurely" class="logo">
    <button id="menu-toggle" class="hamburger" aria-label="Open menu" aria-controls="top-menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
    <nav id="top-menu" class="menu" hidden>
      <a href="index.html">Dashboard</a>
      <a href="results.html">Results</a>
      <a href="settings.html" aria-current="page">Settings</a>
    </nav>
  </header>

  <main id="main" class="wrap" role="main" aria-labelledby="page-title">
    <h1 id="page-title" class="visually-hidden">Measurely Settings</h1>

    <!-- Inputs & Outputs -->
    <section class="card" aria-labelledby="io-heading">
      <h2 id="io-heading" class="card-title">Inputs &amp; outputs</h2>
      <p class="small muted io-tip">Tip: plug in your USB mic and DAC; Measurely will detect them.</p>

      <div class="io-grid">
        <section class="io-box">
          <div class="io-head">
            <span class="io-label" id="micHeading">Input: Microphone</span>
            <span id="micStatus" class="status warn" role="status" aria-live="polite">Checking…</span>
          </div>
          <div id="micName" class="io-name" aria-describedby="micHeading"></div>
        </section>

        <section class="io-box">
          <div class="io-head">
            <span class="io-label" id="dacHeading">Output: DAC</span>
            <span id="dacStatus" class="status warn" role="status" aria-live="polite">Checking…</span>
          </div>
          <div id="dacName" class="io-name" aria-describedby="dacHeading"></div>
        </section>
      </div>
    </section>

    <!-- Wi-Fi setup -->
    <section class="card" id="wifiCard" aria-labelledby="wifi-heading">
      <h2 id="wifi-heading" class="card-title">Wi-Fi setup</h2>
      <p class="subhead" id="wifiStatusLine" role="status" aria-live="polite">Status: checking…</p>

      <div class="subsection">
        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <p class="subhead" id="wifiSelHelp">Select your network and connect.</p>
          <button id="wifiScanBtn" aria-describedby="wifiSelHelp">Scan</button>
        </div>
        <label class="visually-hidden" for="wifiSel">Available Wi-Fi networks</label>
        <select id="wifiSel" aria-describedby="wifiSelHelp"></select>
      </div>

      <div class="subsection" id="wifiPwdWrap" style="display:none;">
        <label for="wifiPwd" class="subhead">Password</label>
        <input id="wifiPwd" type="password" placeholder="Wi-Fi password" autocomplete="current-password" inputmode="text">
      </div>

      <div class="actions">
        <button id="wifiConnectBtn" class="primary">Connect</button>
        <button id="hotspotStopBtn" style="margin-left:auto">Stop hotspot</button>
        <span id="wifiMsg" class="small muted" role="status" aria-live="polite"></span>
      </div>

      <p class="small muted" id="wifiHint" style="margin-top:8px;">
        Tip: once connected, open <code>http://measurely.local/</code> on your home network.
      </p>
    </section>

    <!-- Speaker & Room -->
    <section class="card compact" aria-labelledby="room-heading">
      <h2 id="room-heading" class="card-title">Speaker &amp; room</h2>

      <div class="subsection" aria-labelledby="room-measurements-heading">
        <div class="subhead" id="room-measurements-heading">Room measurements</div>
        <div class="grid-3">
          <div class="with-unit">
            <label for="roomL">Room length (metres)</label>
            <input id="roomL" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="roomLUnit">
            <span id="roomLUnit" class="unit">m</span>
          </div>
          <div class="with-unit">
            <label for="roomW">Room width (metres)</label>
            <input id="roomW" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="roomWUnit">
            <span id="roomWUnit" class="unit">m</span>
          </div>
          <div class="with-unit">
            <label for="roomH">Ceiling height (metres)</label>
            <input id="roomH" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="roomHUnit">
            <span id="roomHUnit" class="unit">m</span>
          </div>
        </div>
      </div>

      <div class="rule" role="separator" aria-hidden="true"></div>

      <div class="subsection" aria-labelledby="speaker-placement-heading">
        <div class="subhead" id="speaker-placement-heading">Speaker placement</div>

        <div class="grid-3">
          <div class="with-unit">
            <label for="spkFront">Speaker to front wall (metres)</label>
            <input id="spkFront" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="spkFrontUnit">
            <span id="spkFrontUnit" class="unit">m</span>
          </div>
          <div class="with-unit">
            <label for="lstToSpk">Listener to front wall (metres)</label>
            <input id="lstToSpk" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="lstToSpkUnit">
            <span id="lstToSpkUnit" class="unit">m</span>
          </div>
          <div class="with-unit">
            <label for="spkSpacing">Speaker spacing (metres)</label>
            <input id="spkSpacing" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="spkSpacingUnit">
            <span id="spkSpacingUnit" class="unit">m</span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="saveRoomBtn" class="primary">Save room &amp; placement</button>
        <span id="saveRoomMsg" class="small muted" role="status" aria-live="polite"></span>
      </div>
    </section>

    <!-- CamillaDSP Filters -->
    <section class="card" aria-labelledby="camilla-heading">
      <h2 id="camilla-heading" class="card-title">CamillaDSP filters</h2>
      <p class="small muted">
        Generate a CamillaDSP configuration from your latest analysed sweep. Preview it, then download the YAML.
      </p>
      <div class="actions">
        <button id="camillaGenBtn" class="primary">Generate filters</button>
        <button id="camillaDownloadBtn" disabled>Download YAML</button>
        <span id="camillaMsg" class="small muted" role="status" aria-live="polite"></span>
      </div>
      <div class="subhead" style="margin-top:10px;">Preview</div>
      <pre id="camillaPreview" aria-label="CamillaDSP YAML preview">(none yet)</pre>
    </section>
  </main>

  <script>
    // hamburger toggle
    const btn = document.getElementById('menu-toggle');
    const menu = document.getElementById('top-menu');
    btn.addEventListener('click', () => {
      const open = menu.hasAttribute('hidden');
      if (open) menu.removeAttribute('hidden'); else menu.setAttribute('hidden','');
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
    document.addEventListener('click', (e) => {
      if (!menu.hasAttribute('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.setAttribute('hidden',''); btn.setAttribute('aria-expanded','false');
      }
    });

    // minimal status + settings load/save (works with your Flask API)
    async function refreshStatus(){
      try {
        const r = await fetch('/api/status'); const s = await r.json();
        const mic = s.mic || {}, dac = s.dac || {};
        const micStatus = document.getElementById('micStatus');
        const dacStatus = document.getElementById('dacStatus');
        micStatus.textContent = mic.connected ? 'Connected' : 'Not found';
        dacStatus.textContent = dac.connected ? 'Connected' : 'Not found';
        micStatus.classList.toggle('ok', !!mic.connected);
        micStatus.classList.toggle('warn', !mic.connected);
        dacStatus.classList.toggle('ok', !!dac.connected);
        dacStatus.classList.toggle('warn', !dac.connected);
        document.getElementById('micName').textContent = mic.name || '';
        document.getElementById('dacName').textContent = dac.name || '';
      } catch {}
    }

    async function loadRoom(){
      try {
        const r = await fetch('/api/settings'); const cfg = await r.json();
        const room = (cfg && cfg.room) || {};
        const set = (id,v)=>{ const el = document.getElementById(id); if (el && v != null) el.value = v; };
        set('roomL', room.length_m);
        set('roomW', room.width_m);
        set('roomH', room.height_m);
        set('spkFront', room.spk_front_m);
        set('lstToSpk', room.listener_front_m);
        set('spkSpacing', room.spk_spacing_m);
      } catch {}
    }

    async function saveRoom(){
      const val = (id)=>{ const el = document.getElementById(id); const n = parseFloat(el.value); return isNaN(n)? null : n; };
      const payload = {
        room: {
          length_m: val('roomL'),
          width_m: val('roomW'),
          height_m: val('roomH'),
          spk_front_m: val('spkFront'),
          listener_front_m: val('lstToSpk'),
          spk_spacing_m: val('spkSpacing')
        }
      };
      const msg = document.getElementById('saveRoomMsg');
      msg.textContent = 'Saving…';
      try {
        const r = await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        await r.json().catch(()=>({}));
        msg.textContent = r.ok ? 'Saved.' : 'Failed to save';
      } catch(e){
        msg.textContent = 'Failed to save';
      }
    }

    document.getElementById('saveRoomBtn').addEventListener('click', saveRoom);

    // --- CamillaDSP Filter actions ---
    const camillaGenBtn = document.getElementById('camillaGenBtn');
    const camillaDownloadBtn = document.getElementById('camillaDownloadBtn');
    const camillaMsg = document.getElementById('camillaMsg');
    const camillaPreview = document.getElementById('camillaPreview');

    camillaGenBtn.addEventListener('click', async () => {
      camillaGenBtn.disabled = true;
      camillaDownloadBtn.disabled = true;
      camillaMsg.textContent = 'Generating…';
      camillaPreview.textContent = 'Generating…';

      try {
        // expects server to return { ok: true, yaml: "..." } or { ok:false, error:"..." }
        const r = await fetch('/api/filter', { method:'POST' });
        const j = await r.json();
        if (j && j.ok) {
          camillaPreview.textContent = j.yaml || '(empty YAML)';
          camillaMsg.textContent = 'Generated.';
          camillaDownloadBtn.disabled = false;
        } else {
          camillaPreview.textContent = j?.error || 'Error generating filter.';
          camillaMsg.textContent = 'Failed.';
        }
      } catch (e) {
        camillaPreview.textContent = String(e);
        camillaMsg.textContent = 'Failed.';
      } finally {
        camillaGenBtn.disabled = false;
      }
    });

    camillaDownloadBtn.addEventListener('click', () => {
      // server route should stream the last-generated camilla config
      window.location = '/api/filter/download';
    });

    // initial
    refreshStatus(); loadRoom();
    setInterval(refreshStatus, 5000);
  </script>

  <!-- Reuse your existing module bundle if needed -->
  <script type="module" src="./js/main.js"></script>
</body>
</html>
