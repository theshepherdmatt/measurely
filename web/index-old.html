<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Measurely – Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="icons/dave.svg">
    <link rel="stylesheet" href="css/dashboard/index.css">

    <script src="js/plotly.min.js"></script>

    <script> window.MEASURELY_MODE = "local"; </script>


</head>

<body>

    <div class="app-layout">

        <!-- MOBILE OVERLAY -->
        <div id="sidebar-overlay" aria-hidden="true"
            style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(4px);">
        </div>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="sidebar" aria-label="Primary Navigation">
            <div class="sidebar-logo">
                <img src="icons/mainlogo.svg" alt="" aria-hidden="true" style="height: 46px;">
                <span></span>
            </div>

            <nav aria-label="Main">
                <a href="index.html" class="nav-item active">
                    <img src="icons/home.svg" alt="" aria-hidden="true">
                    Home
                </a>
                <a href="room-setup.html" class="nav-item">
                    <img src="icons/dashboard.svg" alt="" aria-hidden="true">
                    Room Setup
                </a>
                <a href="room-character.html" class="nav-item">
                    <img src="icons/curtains.svg" alt="" aria-hidden="true">
                    Room Behaviour
                </a>
            </nav>

            <div style="margin-top: auto;" aria-hidden="true">
                <div class="glass-panel"
                    style="padding: 1rem; border-radius: 12px; display: flex; flex-direction: column; gap: 0.75rem;">

                    <!-- SYSTEM READY -->
                    <div
                        style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--c-text-muted);">
                        <div id="systemReadyDot" class="status-indicator"
                            style="width: 8px; height: 8px; border-radius: 50%; background: var(--c-excellent);">
                        </div>
                        <span id="systemReadyText">System Ready</span>
                    </div>

                    <!-- DAC STATUS -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div id="dacStatusDot" class="status-indicator"
                            style="width: 10px; height: 10px; border-radius: 50%;">
                        </div>
                        <span id="dacStatusText" style="font-size: 0.8rem; color: var(--c-text-muted);">--</span>
                    </div>

                    <!-- MIC STATUS -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div id="usbStatusDot" class="status-indicator"
                            style="width: 10px; height: 10px; border-radius: 50%;">
                        </div>
                        <span id="usbStatusText" style="font-size: 0.8rem; color: var(--c-text-muted);">--</span>
                    </div>

                    <!-- LAST UPDATED -->
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.3); margin-top: 0.5rem;">
                        Last updated: <span id="lastUpdated">Now</span>
                    </div>
                </div>
            </div>

        </aside>

        <div id="sidebar-toggle"
            aria-label="Toggle sidebar"
            title="Toggle sidebar">
        ‹
        </div>

        <!-- MAIN CONTENT -->
        <main class="main-content">

            <!-- HEADER -->
            <header class="header animate-enter">

                <div class="header-title"
                    style="display: flex; align-items: center; gap: 1rem;">


                    <!-- LEFT: Title -->
                    <div>
                        <h1>Your Room Results</h1>
                        <p><p>What your room is doing to the sound, measured, not guessed.</p>
.</p>
                    </div>

                    <!-- RIGHT: Hamburger (forced to far right) -->
                    <button id="mobile-menu-btn" 
                            class="btn btn-secondary" 
                            style="padding: 0.5rem; display: none; margin-left: auto;"
                            aria-label="Toggle navigation" aria-expanded="false">
                        <img src="icons/bars.svg" style="width: 24px;" alt="">
                    </button>

                </div>

                <!-- Buttons Row -->
                <div class="header-actions">

                    <button id="runSweepBtn" class="btn btn-primary" data-primary-action>
                        <img src="icons/sweep.svg" alt="">
                        Run Sweep
                    </button>

                    <button id="refreshDashboardBtn" class="btn btn-utility">
                        <img src="icons/refresh.svg" alt="">
                        Refresh
                    </button>

                    <!-- Cancel Sweep (hidden until active) -->
                    <button id="cancelSweepBtn" class="btn btn-secondary hidden">
                        <img src="icons/toolbox.svg" alt="">
                        Cancel Sweep
                    </button>

                </div>



            </header>

            <!-- TOP ROW: SCORE & ACTIONS -->
            <div class="grid-3 animate-enter delay-1">

                <!-- OVERALL SCORE CARD -->
                <div class="card glass-panel"
                    style="grid-column: span 2; padding: 2rem; border-radius: 18px;"
                    role="region"
                    aria-labelledby="overallRoomScoreLabel">

                    <!-- Title -->
                    <h2 id="overallRoomScoreLabel"
                        class="card-title"
                        style="display:flex; align-items:center; gap:0.5rem;
                            margin-bottom:1.25rem; font-size:0.95rem; font-weight:500;
                            text-transform:uppercase; letter-spacing:0.5px; opacity:0.85;">
                        <img src="icons/chart-line.svg" style="width:16px; opacity:0.7;" alt="" aria-hidden="true">
                        Overall Room Score (latest)
                    </h2>

                    <!-- SCORE -->
                    <div class="score-display"
                        style="display:flex; align-items:flex-end; margin-bottom:1.5rem;">
                        <span id="overallScore"
                            class="score-value text-gradient-accent"
                            style="font-size:5.5rem; font-weight:700;"
                            data-color-target="overall">--</span>
                        <span class="score-max"
                            style="opacity:0.5; font-size:1rem; margin-left:0.35rem; transform: translateY(-10px);">
                            /10
                        </span>
                    </div>

                    <!-- SUMMARY -->
                    <p id="overallDavePhrase" class="dave-quote">
                        “Run a sweep to get started.”
                    </p>

                    <!-- FOOTER -->
                    <div style="
                        margin-top:1.75rem;
                        padding-top:1rem;
                        border-top:1px solid rgba(255,255,255,0.06);
                        display:flex;
                        justify-content:space-between;
                        align-items:center;
                        gap:1rem;
                        font-size:0.85rem;
                        color:var(--c-text-muted);
                    ">
                        <span style="opacity:0.7;">Based on 6 key acoustic metrics</span>

                        <button id="downloadReportBtn"
                                type="button"
                                class="btn btn-secondary"
                                aria-label="Download report">
                            <img src="icons/arrow-down.svg" style="width:14px;" alt="">
                            Download report
                        </button>
                    </div>

                </div>


                <!-- QUICK ACTIONS / INFO -->
                <!-- LIVE LOGS CARD -->
                <div class="card glass-panel" aria-hidden="true">

                    <!-- LIVE LOGS HEADER -->
                    <h3 class="card-subtitle">Live Logs</h3>

                    <!-- LOG AREA -->
                    <div id="sessionLog"
                        style="display:flex; flex-direction:column; gap:0.5rem;
                            font-size:0.85rem; color:var(--c-text-muted);
                            min-height:40px; border-top:1px solid rgba(255,255,255,0.05);
                            padding-top:0.75rem;">
                        <div style="opacity:0.6;">Logs will appear here once you run a sweep!
                        </div>
                    </div>

                </div>

            </div>

            <!-- METRICS GRID -->
            <div class="grid-3 animate-enter delay-2">

                <!-- Peaks & Dips -->
                <div class="card glass-panel" role="region" aria-labelledby="peaksDipsLabel" aria-label="">
                    <div class="card-header">
                        <h2 class="card-title">Peaks & Dips</h2>
                        <img src="icons/mountain.svg" style="width: 20px;" data-color-icon="peaksDips" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="peaksDipsScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="peaksDips">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Smoothness of bass
                        and lower
                        mids.</p>
                    <span id="peaksDipsDave" class="dave-quote">--</span>
                    <!-- Hidden spans for JS compatibility -->
                    <span id="peaksDipsStatus" class="hidden"></span>
                    <span id="peaksDipsStatusText" class="hidden"></span>
                    <span id="peaksDipsRaw" class="hidden"></span>
                    <span id="peaksDipsSummary" class="hidden"></span>
                </div>

                <!-- Reflections -->
                <div class="card glass-panel" 
                     role="region" 
                     aria-labelledby="reflectionsLabel" 
                     aria-label="">
                    <div class="card-header">
                        <h2 class="card-title">Reflections</h2>
                        <img src="icons/square-caret-left.svg" style="width: 20px;" data-color-icon="reflections"
                            alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="reflectionsScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="reflections">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Early wall/floor
                        bounce
                        coloring sound.</p>
                    <span id="reflectionsDave" class="dave-quote">--</span>
                    <span id="reflectionsStatus" class="hidden"></span>
                    <span id="reflectionsStatusText" class="hidden"></span>
                    <span id="reflectionsRaw" class="hidden"></span>
                </div>

                <!-- Bandwidth -->
                <div class="card glass-panel"
                     role="region"
                     aria-labelledby="bandwidthLabel"
                     aria-label="">
                    <div class="card-header">
                        <h2 class="card-title">Bandwidth</h2>
                        <img src="icons/signal.svg" style="width: 20px;" data-color-icon="bandwidth" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="bandwidthScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="bandwidth">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">How wide your
                        system plays
                        (Bass to Air).</p>
                    <span id="bandwidthDave" class="dave-quote">--</span>
                    <span id="bandwidthStatus" class="hidden"></span>
                    <span id="bandwidthStatusText" class="hidden"></span>
                    <span id="bandwidthRaw" class="hidden"></span>
                    <span id="bandwidthSummary" class="hidden"></span>
                </div>

                <!-- Balance -->
                <div class="card glass-panel"
                     role="region"
                     aria-labelledby="balanceLabel"
                     aria-label="">
                    <div class="card-header">
                        <h2 class="card-title">Balance</h2>
                        <img src="icons/balance-scale.svg" style="width: 20px;" data-color-icon="balance" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="balanceScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="balance">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Tonal tilt (Warm vs
                        Bright).</p>
                    <span id="balanceDave" class="dave-quote">--</span>
                    <span id="balanceStatus" class="hidden"></span>
                    <span id="balanceStatusText" class="hidden"></span>
                    <span id="balanceRaw" class="hidden"></span>
                </div>

                <!-- Smoothness -->
                <div class="card glass-panel"
                     role="region"
                     aria-labelledby="smoothnessLabel"
                     aria-label="">
                    <div class="card-header">
                        <h2 class="card-title">Smoothness</h2>
                        <img src="icons/wave-square.svg" style="width: 20px;" data-color-icon="smoothness" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="smoothnessScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="smoothness">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Fine-grain
                        consistency across
                        spectrum.</p>
                    <span id="smoothnessDave" class="dave-quote">--</span>
                    <span id="smoothnessStatus" class="hidden"></span>
                    <span id="smoothnessStatusText" class="hidden"></span>
                    <span id="smoothnessRaw" class="hidden"></span>
                </div>

                <!-- Clarity -->
                <div class="card glass-panel"
                    role="region"
                    aria-labelledby="clarityLabel"
                    aria-label="">
                    <div class="card-header">
                        <h2 class="card-title" style="margin:0;">Clarity</h2>
                        <img src="icons/clock.svg" style="width: 20px;"
                            data-color-icon="clarity" alt="">
                    </div>

                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="clarityScore"
                            class="score-value"
                            style="font-size: 2.5rem;"
                            data-color-target="clarity">--</span>
                    </div>

                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">
                        How clearly the direct sound reaches you before reflections interfere.
                    </p>
                    <span id="clarityDave" class="dave-quote">--</span>
                    <!-- Hidden spans for JS compatibility -->
                    <span id="clarityStatus" class="hidden"></span>
                    <span id="clarityStatusText" class="hidden"></span>
                    <span id="clarityRaw" class="hidden"></span>
                </div>


            </div>

            <!-- NERDS CORNER -->
            <div class="card glass-panel animate-enter delay-3"
                role="region"
                aria-labelledby="nerdsCornerLabel">

                <!-- HEADER -->
                <h2 id="nerdsCornerLabel" class="card-title">
                    Nerds Corner
                </h2>

                <p class="card-description">
                    Deep dive analysis and raw curves.
                </p>

                <!-- SWEEP NAV (DO NOT MOVE / DO NOT RENAME) -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">

                    <div id="sweepNav" class="sweep-nav">
                        <button class="btn btn-utility session-btn session-active" data-sweep="0">Latest</button>
                        <button class="btn btn-utility session-btn" data-sweep="1">Previous</button>
                        <button class="btn btn-utility session-btn" data-sweep="2">Earlier</button>
                        <button class="btn btn-utility session-btn" data-sweep="3">Oldest</button>
                    </div>

                    <div class="band-levels">
                        <div class="band-pill"><span>Bass</span><span id="bandBass">— dB</span></div>
                        <div class="band-pill"><span>Mid</span><span id="bandMid">— dB</span></div>
                        <div class="band-pill"><span>Treble</span><span id="bandTreble">— dB</span></div>
                        <div class="band-pill"><span>Air</span><span id="bandAir">— dB</span></div>
                    </div>

                </div>

                <!-- CHART -->
                <div class="chart-container">
                    <div id="frequencyChart"
                        class="chart-responsive"
                        style="width: 100%; height: 320px;"
                        role="img"
                        aria-live="polite"
                        aria-describedby="frequencyChartDescription">
                    </div>

                    <p id="frequencyChartDescription"
                    class="hidden"
                    aria-hidden="true"></p>
                </div>

                <!-- SWEEP HISTORY -->
                <section class="sweep-history-wrapper">

                    <!-- SECTION HEADER -->
                    <h2 class="card-title" style="margin-bottom:0.75rem;">
                        Sweep History
                    </h2>

                    <p class="card-description">
                        Compare your last four sweeps at a glance
                    </p>

                    <!-- SWEEP GRID -->
                    <div id="sweepHistoryGrid">

                        <!-- SWEEP 1 -->
                        <div class="sweep-card sweep-item" data-index="0">
                            <h3 class="sweep-title"><span class="sweep-tag">Latest</span></h3>
                            <div class="sweep-time">—</div>
                            <div class="sweep-score">--</div>

                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>


                            <!-- AI COMPARISON -->
                            <div class="sweep-ai-summary hidden">
                                <p class="ai-text" data-ai-compare></p>
                            </div>

                            <div class="sweep-footer">
                                <button class="notes-btn" data-sweep-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this sweep</span>
                                </div>
                            </div>
                        </div>

                        <!-- SWEEP 2 -->
                        <div class="sweep-card sweep-item" data-index="1">
                            <h3 class="sweep-title"><span class="sweep-tag">Previous</span></h3>
                            <div class="sweep-time">—</div>
                            <div class="sweep-score">--</div>

                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>

                            <!-- AI COMPARISON -->
                            <div class="sweep-ai-summary hidden">
                                <span class="ai-label">Compared to previous</span>
                                <p class="ai-text" data-ai-compare></p>
                            </div>

                            <div class="sweep-footer">
                                <button class="notes-btn" data-sweep-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this sweep</span>
                                </div>
                            </div>
                        </div>

                        <!-- SWEEP 3 -->
                        <div class="sweep-card sweep-item" data-index="2">
                            <h3 class="sweep-title"><span class="sweep-tag">Earlier</span></h3>
                            <div class="sweep-time">—</div>
                            <div class="sweep-score">--</div>

                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>

                            <!-- AI COMPARISON -->
                            <div class="sweep-ai-summary hidden">
                                <span class="ai-label">Compared to previous</span>
                                <p class="ai-text" data-ai-compare></p>
                            </div>

                            <div class="sweep-footer">
                                <button class="notes-btn" data-sweep-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this sweep</span>
                                </div>
                            </div>
                        </div>

                        <!-- SWEEP 4 -->
                        <div class="sweep-card sweep-item" data-index="3">
                            <h3 class="sweep-title"><span class="sweep-tag">Oldest</span></h3>
                            <div class="sweep-time">—</div>
                            <div class="sweep-score">--</div>

                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>

                            <!-- AI COMPARISON (will remain hidden – no previous sweep) -->
                            <div class="sweep-ai-summary hidden">
                                <span class="ai-label">Compared to previous</span>
                                <p class="ai-text" data-ai-compare></p>
                            </div>

                            <div class="sweep-footer">
                                <button class="notes-btn" data-sweep-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this sweep</span>
                                </div>
                            </div>
                        </div>

                     </div>
                    </section>

            </div>

        </main>
    </div>
    <script type="module">
    import { initSpeakers } from './js/speakers.js';
    window.initSpeakers = initSpeakers;
    initSpeakers();
    </script>

    <script>
        function toast(msg, type = 'info') {
            const box = document.createElement('div');
            box.style.cssText = `
                position:fixed;
                top:1rem;
                right:1rem;
                padding:0.75rem 1rem;
                border-radius:8px;
                color:white;
                font-size:0.9rem;
                z-index:9999;
                transition:opacity 0.3s;
                background:${type === 'error'
                    ? '#ef4444'
                    : type === 'success'
                        ? '#10b981'
                        : '#3b82f6'};
            `;
            box.textContent = msg;
            document.body.appendChild(box);

            setTimeout(() => { box.style.opacity = '0'; }, 6000);
            setTimeout(() => { box.remove(); }, 8300);

        }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.getElementById('sidebar');
        const main = document.querySelector('.main-content');
        const toggle = document.getElementById('sidebar-toggle');
        const chart = document.getElementById('frequencyChart');

        if (!sidebar || !main || !toggle) {
            console.warn('Sidebar toggle: missing element(s)', { sidebar, main, toggle });
            return;
        }

        const applyState = (isCollapsed) => {
            sidebar.classList.toggle('collapsed', isCollapsed);
            main.classList.toggle('sidebar-collapsed', isCollapsed);
            toggle.classList.toggle('collapsed', isCollapsed);
            toggle.textContent = isCollapsed ? '›' : '‹';
            localStorage.setItem('measurelySidebarCollapsed', String(isCollapsed));

            // Resize Plotly after layout settles
            setTimeout(() => {
                if (window.Plotly && chart) Plotly.Plots.resize(chart);
            }, 300);
        };

        // Restore saved state (desktop only)
        if (window.innerWidth >= 1025) {
            const collapsed = localStorage.getItem('measurelySidebarCollapsed') === 'true';
            applyState(collapsed);
        }

        toggle.addEventListener('click', () => {
            if (window.innerWidth < 1025) return; // desktop only
            const isCollapsed = !sidebar.classList.contains('collapsed');
            applyState(isCollapsed);
        });
    });

    </script>


    <script src="js/dashboard.js"></script>


    <script>


        document.getElementById("refreshDashboardBtn").addEventListener("click", async () => {
            console.log("Refreshing dashboard…");

            if (!window.dashboard) {
                console.error("Dashboard not initialised");
                return;
            }

            try {
                // 1. Load new sweep/session data
                await window.dashboard.loadData();

                // 2. Fully redraw dashboard UI
                window.dashboard.updateDashboard();

                updateAllMetricAria();

                // 3. Update nerd metrics
                window.dashboard.updateCompareSessionMetrics();

                // 5. Optional toast
                window.dashboard.showSuccess("Dashboard refreshed");

            } catch (err) {
                console.error("Refresh failed:", err);
                window.dashboard.showError("Refresh failed");
            }
        });


        function formatTimestamp(isoString) {
            if (!isoString) return "No Data";
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch { return isoString; }
        }
  
        let firstDrawDone = false;


        document.addEventListener('DOMContentLoaded', () => {
            if (typeof MeasurelyDashboard === 'undefined') return;

            window.dashboard = new MeasurelyDashboard();

            // SweepNav wiring (LOCAL = same as WEB)
            document.querySelectorAll("#sweepNav .session-btn").forEach((btn, index) => {
                btn.addEventListener("click", () => {
                    window.dashboard.loadNthSession(index);
                });
            });
        });


        const btn = document.getElementById('mobile-menu-btn');
        const side = document.getElementById('sidebar');
        const over = document.getElementById('sidebar-overlay');
        function toggleMenu() {
            side.classList.toggle("active");
            over.classList.toggle("active");
            document.body.style.overflow = side.classList.contains("active") ? "hidden" : "";
        }
        if (btn) btn.addEventListener('click', toggleMenu);
        if (over) over.addEventListener('click', toggleMenu);

        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    side.classList.remove('active');
                    over.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        });

        setInterval(() => {
            const el = document.getElementById('lastUpdated');
            if (el) el.textContent = new Date().toLocaleTimeString();
        }, 1000);
    </script>

<!-- NOTES MODAL (GLOBAL POPUP) -->
<div id="notesModal" class="notes-modal" aria-hidden="true">
    <div class="notes-modal-backdrop"></div>

    <div class="notes-modal-content">
        <div class="notes-modal-header">
            <h3 id="notesModalTitle">Sweep Notes</h3>
            <button class="notes-modal-close" aria-label="Close notes">&times;</button>
        </div>

        <div class="notes-modal-body">
            <textarea id="notesTextarea" 
                      class="notes-textarea" 
                      placeholder="Write your notes here…"></textarea>
        </div>

        <div class="notes-modal-footer">
            <button id="saveNotesBtn" class="btn btn-primary">Save</button>
        </div>
    </div>
</div>

<script>

// ========================
// NOTES MODAL LOGIC
// ========================

let currentSweepIndex = null;

// FORCE modal closed on page load
document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("notesModal");
    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden", "true");
});


// OPEN modal
function openNotesModal(index) {
    currentSweepIndex = index;

    const modal = document.getElementById("notesModal");
    const textarea = document.getElementById("notesTextarea");

    textarea.value = localStorage.getItem(`sweepNote_${index}`) || "";

    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden", "false");
}

// CLOSE modal
function closeNotesModal() {
    const modal = document.getElementById("notesModal");
    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden", "true");
}

// OPEN BUTTONS
document.querySelectorAll("[data-sweep-note]").forEach((btn, i) => {
    btn.addEventListener("click", () => openNotesModal(i));
});

// SAVE
document.getElementById("saveNotesBtn").addEventListener("click", () => {
    const textarea = document.getElementById("notesTextarea");

    localStorage.setItem(`sweepNote_${currentSweepIndex}`, textarea.value);

    const preview = document.querySelector(
        `.sweep-card[data-index="${currentSweepIndex}"] [data-note-preview]`
    );
    preview.textContent = textarea.value || "—";

    closeNotesModal();
});

// CLOSE (X)
document.querySelector(".notes-modal-close")
    .addEventListener("click", closeNotesModal);

// BACKDROP
document.querySelector(".notes-modal-backdrop")
    .addEventListener("click", closeNotesModal);
</script>

</body>

</html>