<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Measurely â€“ Room Setup</title>
  <link rel="icon" type="image/svg+xml" href="icons/dave.svg">
  <link rel="stylesheet" href="measurely.css">
  <script src="js/plotly.min.js"></script>
</head>

<body>

  <div class="app-layout">

    <!-- MOBILE OVERLAY -->
    <div id="sidebar-overlay" aria-hidden="true"
      style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(4px);">
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar" role="complementary">
      <div class="sidebar-logo">
        <img src="icons/mainlogo.svg" alt="Measurely" style="height: 46px;">
        <span></span>
      </div>

      <nav aria-label="Main">
        <a href="index.html" class="nav-item">
          <img src="icons/dashboard.svg" alt="">
          Dashboard
        </a>
        <a href="room-setup.html" class="nav-item active">
          <img src="icons/home.svg" alt="">
          Room Setup
        </a>
        <a href="tipsandtweaks.html" class="nav-item">
          <img src="icons/lightbulb.svg" alt="">
          Tips & Tweaks
        </a>
      </nav>

      <div style="margin-top: auto;">
        <div class="glass-panel" style="padding: 1rem; border-radius: 12px;">
          <div
            style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--c-text-muted);">
            <div id="systemReadyDot" class="status-indicator"
              style="width: 8px; height: 8px; border-radius: 50%; background: var(--c-excellent);"></div>
            <span id="systemReadyText" aria-live="polite">System Ready</span>
          </div>
          <div style="font-size: 0.75rem; color: rgba(255,255,255,0.3);">
            Last updated: <span id="lastUpdated">Now</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content" role="main">

      <!-- HEADER -->
      <header class="header animate-enter" role="banner">
        <div class="header-title" style="display: flex; align-items: center; gap: 1rem;">
          <button id="mobile-menu-btn" class="btn btn-secondary" style="padding: 0.5rem; display: none;"
            aria-label="Toggle navigation" aria-expanded="false">
            <img src="icons/bars.svg" style="width: 24px;" alt="">
          </button>
          <div>
            <h1>Set Your Room Up With Dave</h1>
            <p>Accurate inputs mean tighter bass predictions and smarter reflection modelling.</p>
          </div>
        </div>
      </header>

      <!-- SECTION 1: DIMENSIONS -->
      <section class="card glass-panel animate-enter delay-1" style="margin-bottom: 2rem;">
        <div
          style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 1rem;">
          <div
            style="width: 32px; height: 32px; background: rgba(99, 102, 241, 0.2); color: #818cf8; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700;">
            1</div>
          <h2 style="margin: 0; font-size: 1.25rem;">Room Dimensions</h2>
        </div>

        <div class="grid-3">
          <div>
            <label for="room-length">Length (m)</label>
            <input type="number" id="room-length" step="0.01" placeholder="4.9">
            <p style="font-size: 0.8rem; color: var(--c-text-muted); margin-top: 0.5rem;">Front to rear wall.</p>
          </div>
          <div>
            <label for="room-width">Width (m)</label>
            <input type="number" id="room-width" step="0.01" placeholder="3.7">
            <p style="font-size: 0.8rem; color: var(--c-text-muted); margin-top: 0.5rem;">Side to side.</p>
          </div>
          <div>
            <label for="room-height">Height (m)</label>
            <input type="number" id="room-height" step="0.01" placeholder="2.4">
            <p style="font-size: 0.8rem; color: var(--c-text-muted); margin-top: 0.5rem;">Floor to ceiling.</p>
          </div>
        </div>

        <div
          style="background: rgba(99, 102, 241, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.1);">
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <label for="room-echo" style="margin:0; color: white;">How "Live" is the room?</label>
            <span id="roomEchoValue" style="color: var(--c-accent); font-weight: 700;">20%</span>
          </div>
          <input type="range" id="room-echo" min="0" max="100" step="5">
          <div
            style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--c-text-muted); margin-top: 0.5rem;">
            <span>Dry (Studio)</span>
            <span>Normal Living Room</span>
            <span>Echoey (Empty Hall)</span>
          </div>
        </div>
      </section>

      <!-- SECTION 2: MATERIALS -->
      <section class="card glass-panel animate-enter delay-2" style="margin-bottom: 2rem;">
        <div
          style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 1rem;">
          <div
            style="width: 32px; height: 32px; background: rgba(168, 85, 247, 0.2); color: #c084fc; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700;">
            2</div>
          <h2 style="margin: 0; font-size: 1.25rem;">Materials & Furnishings</h2>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
          <div>
            <label for="floor-material">Base Floor Surface</label>
            <select id="floor-material">
              <option value="hard">Hardwood / Tile / Laminate</option>
              <option value="carpet">Wall-to-Wall Carpet</option>
            </select>
            <p style="font-size: 0.8rem; color: var(--c-text-muted); margin-top: 0.5rem;">Hard floors create stronger
              early reflections.</p>
          </div>

          <div>
            <label id="room-contents-label">Room Contents</label>
            <div role="group" aria-labelledby="room-contents-label"
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">

              <label class="checkbox-group">
                <input type="checkbox" id="opt-area-rug">
                <div>
                  <div style="color: white; font-weight: 500;">Area Rug</div>
                  <div style="font-size: 0.75rem; color: var(--c-text-muted); font-weight: 400;">Between speakers & seat
                  </div>
                </div>
              </label>

              <label class="checkbox-group">
                <input type="checkbox" id="opt-curtains">
                <div>
                  <div style="color: white; font-weight: 500;">Curtains / Blinds</div>
                  <div style="font-size: 0.75rem; color: var(--c-text-muted); font-weight: 400;">Covering windows</div>
                </div>
              </label>

              <label class="checkbox-group">
                <input type="checkbox" id="opt-sofa">
                <div>
                  <div style="color: white; font-weight: 500;">Large Sofa</div>
                  <div style="font-size: 0.75rem; color: var(--c-text-muted); font-weight: 400;">Fabric/Soft furnishings
                  </div>
                </div>
              </label>

              <label class="checkbox-group">
                <input type="checkbox" id="opt-wallart">
                <div>
                  <div style="color: white; font-weight: 500;">Wall Art / Shelves</div>
                  <div style="font-size: 0.75rem; color: var(--c-text-muted); font-weight: 400;">Diffusers or books
                  </div>
                </div>
              </label>

              <label class="checkbox-group" style="grid-column: span 2;">
                <input type="checkbox" id="opt-barewalls">
                <div>
                  <div style="color: white; font-weight: 500;">Mostly Bare Walls</div>
                  <div style="font-size: 0.75rem; color: var(--c-text-muted); font-weight: 400;">Minimal furniture, hard
                    surfaces dominating</div>
                </div>
              </label>

            </div>
          </div>
        </div>
      </section>

      <!-- SECTION 3: SPEAKER PROFILE -->
      <section class="card glass-panel animate-enter delay-3" style="margin-bottom: 2rem;">
        <div
          style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 1rem;">
          <div
            style="width: 32px; height: 32px; background: rgba(249, 115, 22, 0.2); color: #fdba74; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700;">
            3</div>
          <h2 style="margin: 0; font-size: 1.25rem;">Speaker Profile</h2>
        </div>

        <div>
          <label for="speakerSel" class="sr-only"
            style="position:absolute; width:1px; height:1px; overflow:hidden;">Select Speaker Model</label>
          <select id="speakerSel" style="font-size: 1.1rem; padding: 1rem;"></select>
          <p id="speakerHint"
            style="font-size: 0.9rem; color: var(--c-text-muted); margin-top: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="width: 6px; height: 6px; background: var(--c-text-muted); border-radius: 50%;"></span>
            Select your model to load frequency limits and target curves.
          </p>
        </div>
      </section>

      <!-- SECTION 4: POSITIONING -->
      <section class="card glass-panel animate-enter delay-3" style="margin-bottom: 2rem;">
        <div
          style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 1rem;">
          <div
            style="width: 32px; height: 32px; background: rgba(20, 184, 166, 0.2); color: #5eead4; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700;">
            4</div>
          <h2 style="margin: 0; font-size: 1.25rem;">Positioning</h2>
        </div>

        <div class="grid-3">
          <div>
            <label for="speaker-type">Design Type</label>
            <select id="speaker-type">
              <option value="sealed">Sealed / Infinite Baffle</option>
              <option value="port_front">Ported (Front-Firing)</option>
              <option value="port_rear">Ported (Rear-Firing)</option>
              <option value="dipole">Dipole / Open Baffle</option>
            </select>
          </div>
          <div>
            <label for="speaker-distance">Dist. From Front Wall (m)</label>
            <input type="number" id="speaker-distance" step="0.01">
          </div>
          <div>
            <label for="speaker-width">Speaker Spacing (m)</label>
            <input type="number" id="speaker-width" step="0.01">
          </div>
          <div>
            <label for="toe-angle">Toe-in Angle (deg)</label>
            <input type="number" id="toe-angle" step="1">
          </div>
          <div>
            <label for="listening-distance">Listening Distance (m)</label>
            <input type="number" id="listening-distance" step="0.01">
          </div>
        </div>
      </section>

      <!-- DAVE'S CHECKLIST -->
      <section class="card glass-panel animate-enter delay-3" style="position: relative; overflow: hidden;">
        <div
          style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; filter: blur(60px);">
        </div>

        <div style="position: relative; z-index: 10;">
          <h2 style="margin: 0 0 1.5rem 0; font-size: 1.5rem; display: flex; align-items: center; gap: 1rem;">
            <div
              style="width: 48px; height: 48px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
              ðŸ¤–</div>
            Daveâ€™s Pre-Flight Checklist
          </h2>

          <div id="recommendations-list" style="min-height: 100px;">
            <div
              style="display: flex; align-items: center; gap: 0.5rem; color: var(--c-text-muted); font-style: italic;">
              <span class="status-indicator"
                style="background: var(--c-text-muted); animation: pulse 2s infinite;"></span>
              Waiting for room data to generate advice...
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script src="/js/dashboard.js"></script>
  <script type="module" src="/js/devices.js"></script>
  <script type="module">
    import { initSpeakers } from '/js/speakers.js';
    document.addEventListener('DOMContentLoaded', async () => {
      await initSpeakers();
    });
  </script>

  <script>
    /* ---------- Sidebar toggle ---------- */
    const btn = document.getElementById('mobile-menu-btn');
    const side = document.getElementById('sidebar');
    const over = document.getElementById('sidebar-overlay');
    function toggleMenu() {
      side.classList.toggle('active');
      over.classList.toggle('active');
      const isActive = side.classList.contains('active');
      btn.setAttribute('aria-expanded', isActive);
      document.body.style.overflow = isActive ? 'hidden' : '';
    }
    if (btn) btn.addEventListener('click', toggleMenu);
    if (over) over.addEventListener('click', toggleMenu);

    document.querySelectorAll('.nav-item').forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth <= 1024) {
          side.classList.remove('active');
          over.classList.remove('active');
          btn.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }
      });
    });

    /* ---------- Toast ---------- */
    function toast(msg, type = 'info') {
      const box = document.createElement('div');
      // Using inline styles for toast since I didn't add toast classes to CSS
      box.style.cssText = `
      position: fixed; top: 1rem; right: 1rem; padding: 0.75rem 1rem; border-radius: 8px;
      color: white; font-size: 0.9rem; z-index: 100; transition: all 0.3s;
      background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
      box.textContent = msg;
      document.body.appendChild(box);
      setTimeout(() => box.style.opacity = '0', 2000);
      setTimeout(() => box.remove(), 2300);
    }

    /* ---------- Dynamic Checklist Generation ---------- */
    // Helper to replace bold markdown
    const replaceBoldHtml = (text) =>
      text.replace(/\*\*(.*?)\*\*/g, '<strong style="color:white;">$1</strong>');


    function generateChecklist(roomConfig) {
      const listEl = document.getElementById('recommendations-list');
      listEl.innerHTML = '';

      const {
        length_m, spk_spacing_m, floor_material, opt_area_rug,
        opt_curtains, speaker_type, listener_front_m
      } = roomConfig;

      const listItems = [];

      listItems.push({
        icon: 'ðŸ§°',
        title: 'Grab a tape measure',
        text: 'Accurate distances make a huge difference to the sweep results.'
      });
      listItems.push({
        icon: 'ðŸŽ¯',
        title: 'Mic Placement is Everything',
        text: 'Ear height, centred, in your normal listening spot â€” not â€œnear itâ€.'
      });

      if (floor_material === 'hard' && !opt_area_rug) {
        listItems.push({
          icon: 'ðŸ’¥',
          title: 'Action: Floor Reflection Warning',
          text: 'Your **hard floor** and lack of a rug is the biggest risk for harsh, early reflections. This is your **number one item to fix**.'
        });
      } else if (floor_material === 'hard' && opt_area_rug) {
        listItems.push({
          icon: 'âœ…',
          title: 'Floor Coverage is Good',
          text: 'You have a hard floor, but your rug is a **strong defense** against vertical reflections. Nice work.'
        });
      }

      if (speaker_type === 'port_rear' && length_m) {
        const minDistance = 0.4;
        listItems.push({
          icon: 'ðŸ”Š',
          title: 'Rear-Ported Speaker Minimum Distance',
          text: `Since you have rear-ported speakers, ensure they are pulled out at least **${minDistance}m** from the front wall to avoid bass boom.`
        });
      }

      if (length_m) {
        const targetDistance = (length_m * 0.38).toFixed(2);
        listItems.push({
          icon: 'ðŸ”',
          title: 'Ideal Seating Start Point',
          text: `For your ${length_m}m long room, a great starting distance from the front wall is **${targetDistance}m**. Check your current position against this number.`
        });
      }

      if (!opt_curtains) {
        listItems.push({
          icon: 'ðŸªŸ',
          title: 'Tip: Tame Windows',
          text: 'Curtains or heavy blinds are a simple way to instantly reduce reflections and make the room sound tighter.'
        });
      }

      const listHtml = listItems.map(item => `
          <li style="margin-bottom: 1rem;">
              <div style="font-weight: 600; color: white; display: flex; align-items: center; gap: 0.5rem;">
                <span>${item.icon}</span> ${item.title}
              </div>
              <div style="color: var(--c-text-muted); font-size: 0.9rem; margin-top: 0.25rem; padding-left: 1.75rem;">
                ${replaceBold(item.text)}
              </div>
          </li>
      `).join('');

      listEl.innerHTML = `
          <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem; display: flex; gap: 1rem; align-items: start;">
              <img src="icons/dave.svg" alt="Dave" style="width: 48px; opacity: 0.9;">
              <div>
                  <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: white;">Daveâ€™s Setup Checklist</h3>
                  <ul style="list-style: none; padding: 0; margin: 0;">
                      ${listHtml}
                  </ul>
              </div>
          </div>
          <div style="margin-top: 1.5rem;">
            <button id="save-all-btn" class="btn btn-primary" style="width: 100%; justify-content: center;">
              Save Setup
            </button>
          </div>
      `;

      document.getElementById('save-all-btn').addEventListener('click', saveAllSetup);
    }

    /* ---------- Save / Load ---------- */
    const SESSION = 'latest';
    const API = '/api/room';

    async function saveAllSetup() {
      const payload = {
        length_m: parseFloat(document.getElementById('room-length').value),
        width_m: parseFloat(document.getElementById('room-width').value),
        height_m: parseFloat(document.getElementById('room-height').value),
        echo_pct: parseInt(document.getElementById('room-echo').value),
        floor_material: document.getElementById('floor-material').value,
        opt_area_rug: document.getElementById('opt-area-rug').checked,
        opt_barewalls: document.getElementById('opt-barewalls').checked,
        opt_wallart: document.getElementById('opt-wallart').checked,
        opt_curtains: document.getElementById('opt-curtains').checked,
        opt_sofa: document.getElementById('opt-sofa').checked,
        spk_front_m: parseFloat(document.getElementById('speaker-distance').value),
        spk_spacing_m: parseFloat(document.getElementById('speaker-width').value),
        toe_in_deg: parseFloat(document.getElementById('toe-angle').value),
        listener_front_m: parseFloat(document.getElementById('listening-distance').value),
        speaker_type: document.getElementById('speaker-type').value,
        speaker_key: document.getElementById('speakerSel').value,
        layout: 'stereo'
      };

      console.log("ðŸ’¾ Saving all:", payload);

      const res = await fetch('/api/room/latest', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        toast('Save failed', 'error');
      } else {
        toast('Room & speakers saved', 'success');
        loadRoomSetup();
      }
    }

    async function loadRoomSetup() {
      const res = await fetch(`${API}/${SESSION}`);
      const roomConfig = {
        length_m: 4.0, listener_front_m: 2.5, spk_front_m: 0.6,
        floor_material: 'hard', opt_area_rug: false, opt_curtains: false,
        speaker_type: 'sealed'
      };

      if (!res.ok) {
        generateChecklist(roomConfig);
        return;
      }
      const j = await res.json();

      const loadNumeric = (jsonKey, inputId) => {
        if (j[jsonKey] != null) {
          const el = document.getElementById(inputId);
          if (el) {
            el.value = j[jsonKey];
            roomConfig[jsonKey] = parseFloat(j[jsonKey]);
          }
        }
      };

      loadNumeric('length_m', 'room-length');
      loadNumeric('width_m', 'room-width');
      loadNumeric('height_m', 'room-height');
      loadNumeric('spk_front_m', 'speaker-distance');
      loadNumeric('spk_spacing_m', 'speaker-width');
      loadNumeric('toe_in_deg', 'toe-angle');
      loadNumeric('listener_front_m', 'listening-distance');

      if (j.echo_pct != null) {
        document.getElementById('room-echo').value = j.echo_pct;
        document.getElementById('roomEchoValue').textContent = j.echo_pct + '%';
      }

      if (j.floor_material) {
        document.getElementById('floor-material').value = j.floor_material;
        roomConfig.floor_material = j.floor_material;
      }
      if (j.speaker_type) {
        document.getElementById('speaker-type').value = j.speaker_type;
        roomConfig.speaker_type = j.speaker_type;
      }
      document.getElementById('speakerSel').value = j.speaker_key || '';

      const loadBoolean = (jsonKey, inputId) => {
        const isChecked = !!j[jsonKey];
        const el = document.getElementById(inputId);
        if (el) el.checked = isChecked;
        roomConfig[jsonKey] = isChecked;
      };

      loadBoolean('opt_area_rug', 'opt-area-rug');
      loadBoolean('opt_barewalls', 'opt-barewalls');
      loadBoolean('opt_wallart', 'opt-wallart');
      loadBoolean('opt_curtains', 'opt-curtains');
      loadBoolean('opt_sofa', 'opt-sofa');

      generateChecklist(roomConfig);
    }

    setInterval(() => {
      const el = document.getElementById('lastUpdated');
      if (el) el.textContent = new Date().toLocaleTimeString();
    }, 1000);

    document.addEventListener('DOMContentLoaded', () => {
      if (typeof MeasurelyDashboard !== 'undefined' && !window.dashboard) {
        window.dashboard = new MeasurelyDashboard();
      }
      loadRoomSetup();
    });
  </script>

</body>

</html>