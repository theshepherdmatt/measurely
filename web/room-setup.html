<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Measurely â€“ RoomSetup</title>
  <link rel="icon" type="image/svg+xml" href="icons/favicon.svg">
  <link rel="alternate icon" href="favicon.ico">
  <link rel="stylesheet" href="measurely.css">
  <script src="tailwind.js"></script>
  <script src="js/plotly.min.js"></script>
  <link rel="stylesheet" href="fonts/inter/interweb/inter.css">

  <style>
  </style>

<base target="_blank">
</head>

<body class="bg-gray-300">
<div class="mobile-banner md:hidden fixed top-0 left-0 right-0 h-14 backdrop-blur-sm
            flex items-center justify-between px-4 z-50">
  <div class="flex items-center space-x-2">
    <img src="icons/mainlogo.svg"
        class="max-h-10 w-auto object-contain"
        alt="Measurely Logo">


  </div>
  <button id="mobile-menu-btn" class="p-2 rounded-lg text-white hover:bg-white/10 transition">
    <img src="icons/bars.svg" class="w-6 h-6" alt="">
  </button>
</div>

<div id="sidebar-overlay" class="sidebar-overlay"></div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-logo mb-8 flex items-center space-x-3">
    <img src="icons/mainlogo.svg" class="w-15 h-15" alt="Measurely">
    <div>
    </div>
  </div>
    <nav class="space-y-2">

      <a href="index.html" class="nav-item">
        <img src="icons/dashboard.svg" class="w-5 h-5 mr-3 inline-block" />
        Dashboard
      </a>

      <a href="room-setup.html" class="nav-item">
        <img src="icons/home.svg" class="w-5 h-5 mr-3 inline-block" />
        Room Setup
      </a>

      <a href="tipsandtweaks.html" class="nav-item">
        <img src="icons/lightbulb.svg" class="w-5 h-5 mr-3 inline-block" />
        Tips & Tweaks
      </a>

    </nav>
<div class="absolute bottom-6 left-6 right-6">

  <div class="bg-white/20 backdrop-blur-md rounded-lg p-4 space-y-3">

    <div class="flex items-center">
      <div id="systemReadyDot" class="status-indicator status-good pulse-animation"></div>
      <span id="systemReadyText" class="text-sm">System Ready</span>
    </div>

    <div class="flex items-center">
      <div id="dacStatusDot" class="status-indicator bg-yellow-400"></div>
      <span id="dacStatusText" class="text-sm">DAC: Not Found</span>
    </div>

    <div class="flex items-center">
      <div id="usbStatusDot" class="status-indicator bg-red-400"></div>
      <span id="usbStatusText" class="text-sm">USB Mic: Not Connected</span>
    </div>

    <p class="text-xs opacity-80">
      Last updated: <span id="lastUpdated">Now</span>
    </p>

  </div>

</div>

</aside>

<div class="main-content md:ml-64 p-6 md:p-10 max-w-6xl mx-auto font-sans text-slate-800">

  <header class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-4">
    <div>
      <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-slate-900 mb-3">
        Set Your Room Up With Dave
      </h1>
      <p class="text-lg text-slate-600 leading-relaxed max-w-2xl">
        Accurate inputs mean tighter bass predictions and smarter reflection modelling. 
        Help Dave see your room clearly.
      </p>
    </div>
    <div class="hidden md:block">
        </div>
  </header>

  <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8 hover:shadow-md transition-shadow duration-300">
    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-bold">1</div>
      <h2 class="text-lg font-semibold text-slate-800">Room Dimensions</h2>
    </div>

    <div class="p-6 md:p-8">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
        
        <div class="group">
          <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Length</label>
          <div class="relative">
            <input type="number" id="room-length" step="0.01" placeholder="4.9"
                   class="block w-full pl-4 pr-10 py-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all font-medium text-slate-900 placeholder-slate-300">
            <span class="absolute right-4 top-3.5 text-slate-400 text-sm font-medium pointer-events-none">m</span>
          </div>
          <p class="mt-2 text-xs text-slate-500">Front wall to rear wall.</p>
        </div>

        <div class="group">
          <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Width</label>
          <div class="relative">
            <input type="number" id="room-width" step="0.01" placeholder="3.7"
                   class="block w-full pl-4 pr-10 py-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all font-medium text-slate-900 placeholder-slate-300">
            <span class="absolute right-4 top-3.5 text-slate-400 text-sm font-medium pointer-events-none">m</span>
          </div>
          <p class="mt-2 text-xs text-slate-500">Side to side.</p>
        </div>

        <div class="group">
          <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Height</label>
          <div class="relative">
            <input type="number" id="room-height" step="0.01" placeholder="2.4"
                   class="block w-full pl-4 pr-10 py-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all font-medium text-slate-900 placeholder-slate-300">
            <span class="absolute right-4 top-3.5 text-slate-400 text-sm font-medium pointer-events-none">m</span>
          </div>
          <p class="mt-2 text-xs text-slate-500">Floor to ceiling.</p>
        </div>

      </div>

      <div class="bg-blue-50/50 rounded-xl p-5 border border-blue-100">
        <div class="flex justify-between items-center mb-4">
          <label class="text-sm font-semibold text-slate-700">How "Live" is the room?</label>
          <span id="roomEchoValue" class="text-blue-600 font-bold bg-white px-2 py-1 rounded shadow-sm text-sm border border-blue-100">20%</span>
        </div>
        
        <input type="range" id="room-echo" min="0" max="100" step="5"
               class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600 hover:accent-blue-500 transition-colors">
        
        <div class="flex justify-between text-xs text-slate-500 mt-2 font-medium">
          <span>Dry (Studio)</span>
          <span>Normal Living Room</span>
          <span>Echoey (Empty Hall)</span>
        </div>
      </div>
    </div>
  </section>

  <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8 hover:shadow-md transition-shadow duration-300">
    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center text-sm font-bold">2</div>
      <h2 class="text-lg font-semibold text-slate-800">Materials & Furnishings</h2>
    </div>

    <div class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <div class="lg:col-span-4">
        <label class="block text-sm font-medium text-slate-700 mb-2">Base Floor Surface</label>
        <div class="relative">
            <select id="floor-material" class="block w-full pl-4 pr-10 py-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 appearance-none text-slate-900 transition-shadow">
            <option value="hard">Hardwood / Tile / Laminate</option>
            <option value="carpet">Wall-to-Wall Carpet</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </div>
        </div>
        <p class="mt-2 text-xs text-slate-500">Hard floors create stronger early reflections.</p>
      </div>

      <div class="lg:col-span-8">
        <label class="block text-sm font-medium text-slate-700 mb-2">Room Contents</label>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          
          <label class="relative flex items-start p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors">
            <div class="flex items-center h-5">
              <input type="checkbox" id="opt-area-rug" class="h-5 w-5 text-purple-600 border-slate-300 rounded focus:ring-purple-500">
            </div>
            <div class="ml-3 text-sm">
              <span class="font-medium text-slate-800">Area Rug</span>
              <p class="text-slate-500 text-xs">Between speakers & seat</p>
            </div>
          </label>

          <label class="relative flex items-start p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors">
            <div class="flex items-center h-5">
              <input type="checkbox" id="opt-curtains" class="h-5 w-5 text-purple-600 border-slate-300 rounded focus:ring-purple-500">
            </div>
            <div class="ml-3 text-sm">
              <span class="font-medium text-slate-800">Curtains / Blinds</span>
              <p class="text-slate-500 text-xs">Covering windows</p>
            </div>
          </label>

          <label class="relative flex items-start p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors">
            <div class="flex items-center h-5">
              <input type="checkbox" id="opt-sofa" class="h-5 w-5 text-purple-600 border-slate-300 rounded focus:ring-purple-500">
            </div>
            <div class="ml-3 text-sm">
              <span class="font-medium text-slate-800">Large Sofa</span>
              <p class="text-slate-500 text-xs">Fabric/Soft furnishings</p>
            </div>
          </label>

          <label class="relative flex items-start p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors">
            <div class="flex items-center h-5">
              <input type="checkbox" id="opt-wallart" class="h-5 w-5 text-purple-600 border-slate-300 rounded focus:ring-purple-500">
            </div>
            <div class="ml-3 text-sm">
              <span class="font-medium text-slate-800">Wall Art / Shelves</span>
              <p class="text-slate-500 text-xs">Diffusers or books</p>
            </div>
          </label>

          <label class="relative flex items-start p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors sm:col-span-2">
             <div class="flex items-center h-5">
               <input type="checkbox" id="opt-barewalls" class="h-5 w-5 text-purple-600 border-slate-300 rounded focus:ring-purple-500">
             </div>
             <div class="ml-3 text-sm">
               <span class="font-medium text-slate-800">Mostly Bare Walls</span>
               <p class="text-slate-500 text-xs">Minimal furniture, hard surfaces dominating</p>
             </div>
           </label>

        </div>
      </div>
    </div>
  </section>

  <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8 hover:shadow-md transition-shadow duration-300">
    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center text-sm font-bold">3</div>
      <h2 class="text-lg font-semibold text-slate-800">Speaker Profile</h2>
    </div>

    <div class="p-6 md:p-8">
      <div class="relative">
        <select id="speakerSel" class="block w-full pl-4 pr-10 py-4 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-slate-900 text-lg transition-shadow">
            </select>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
             <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        </div>
      </div>
      <p id="speakerHint" class="mt-3 text-sm text-slate-500 flex items-center gap-2">
        <span class="inline-block w-2 h-2 rounded-full bg-slate-400"></span>
        Select your model to load frequency limits and target curves.
      </p>
    </div>
  </section>

  <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-12 hover:shadow-md transition-shadow duration-300">
    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-teal-100 text-teal-600 flex items-center justify-center text-sm font-bold">4</div>
      <h2 class="text-lg font-semibold text-slate-800">Positioning</h2>
    </div>

    <div class="p-6 md:p-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

        <div class="group">
          <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Design Type</label>
          <div class="relative">
            <select id="speaker-type" class="block w-full pl-4 pr-10 py-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 appearance-none text-slate-900">
              <option value="sealed">Sealed / Infinite Baffle</option>
              <option value="port_front">Ported (Front-Firing)</option>
              <option value="port_rear">Ported (Rear-Firing)</option>
              <option value="dipole">Dipole / Open Baffle</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </div>
          </div>
        </div>

        <div class="group">
          <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Dist. From Front Wall</label>
          <div class="relative">
            <input type="number" id="speaker-distance" step="0.01" class="block w-full pl-4 pr-10 py-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-slate-900">
            <span class="absolute right-4 top-3.5 text-slate-400 text-sm font-medium pointer-events-none">m</span>
          </div>
        </div>

        <div class="group">
          <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Speaker Spacing</label>
          <div class="relative">
            <input type="number" id="speaker-width" step="0.01" class="block w-full pl-4 pr-10 py-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-slate-900">
            <span class="absolute right-4 top-3.5 text-slate-400 text-sm font-medium pointer-events-none">m</span>
          </div>
        </div>

        <div class="group">
          <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Toe-in Angle</label>
          <div class="relative">
            <input type="number" id="toe-angle" step="1" class="block w-full pl-4 pr-10 py-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-slate-900">
            <span class="absolute right-4 top-3.5 text-slate-400 text-sm font-medium pointer-events-none">deg</span>
          </div>
        </div>

        <div class="group">
          <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Listening Distance</label>
          <div class="relative">
            <input type="number" id="listening-distance" step="0.01" class="block w-full pl-4 pr-10 py-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-slate-900">
            <span class="absolute right-4 top-3.5 text-slate-400 text-sm font-medium pointer-events-none">m</span>
          </div>
        </div>

      </div>
    </div>
  </section>


<div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 text-slate-900 relative overflow-hidden">
  
  <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-indigo-600 opacity-5 rounded-full blur-3xl"></div>
  
  <div class="relative z-10">
    <h2 class="text-2xl font-bold mb-6 flex items-center gap-4">
      <div class="w-12 h-12 rounded-xl bg-indigo-50 flex items-center justify-center text-2xl border border-indigo-100 shadow-sm">
        ðŸ¤–
      </div>
      <span class="text-slate-900">Daveâ€™s Pre-Flight Checklist</span>
    </h2>
    
    <div id="recommendations-list" class="space-y-4 mb-8 min-h-[100px]">
      <div class="flex items-center gap-2 text-slate-400 text-sm italic">
        <span class="w-2 h-2 rounded-full bg-slate-300 animate-pulse"></span>
        Waiting for room data to generate advice...
      </div>
    </div>
  </div>


</div>



<script src="/js/dashboard.js"></script>
<script type="module" src="/js/devices.js"></script>
<script type="module">
  import { initSpeakers } from '/js/speakers.js';
  document.addEventListener('DOMContentLoaded', async () => {
    await initSpeakers();
  });
</script>

<script>
/* ---------- Sidebar toggle ---------- */
const btn = document.getElementById('mobile-menu-btn');
const side = document.getElementById('sidebar');
const over = document.getElementById('sidebar-overlay');
function toggleMenu(){
  side.classList.toggle('active');
  over.classList.toggle('active');
  document.body.style.overflow = side.classList.contains('active') ? 'hidden' : '';
}
btn.addEventListener('click', toggleMenu);
over.addEventListener('click', toggleMenu);

/* ---------- Toast ---------- */
function toast(msg,type='info'){
  const box=document.createElement('div');
  box.className = `fixed top-4 right-4 p-3 rounded text-white text-sm z-50 transition-all duration-300 ${
    type==='error'?'bg-red-600':type==='success'?'bg-green-600':'bg-blue-600'
  }`;
  box.textContent=msg;
  document.body.appendChild(box);
  setTimeout(()=>box.classList.add('opacity-0'),10);
  setTimeout(()=>box.remove(),1000);
}

/* ---------- Dynamic Checklist Generation (relies on global replaceBold) ---------- */

function generateChecklist(roomConfig) {
    const listEl = document.getElementById('recommendations-list');
    listEl.innerHTML = ''; // Clear previous content

    const { 
        length_m, 
        spk_spacing_m, 
        floor_material, 
        opt_area_rug, 
        opt_curtains, 
        speaker_type,
        listener_front_m
    } = roomConfig;

    const listItems = [];
    
    // --- 1. CORE MEASUREMENT ACCURACY ---
    listItems.push({
        icon: 'ðŸ§°',
        title: 'Grab a tape measure',
        text: 'Accurate distances make a huge difference to the sweep results.'
    });
    listItems.push({
        icon: 'ðŸŽ¯',
        title: 'Mic Placement is Everything',
        text: 'Ear height, centred, in your normal listening spot â€” not â€œnear itâ€.'
    });

    // --- 2. DYNAMIC ADVICE BASED ON INPUT ---
    
    // **A. Floor/Rug Advice**
    if (floor_material === 'hard' && !opt_area_rug) {
        listItems.push({
            icon: 'ðŸ’¥',
            title: 'Action: Floor Reflection Warning',
            text: 'Your **hard floor** and lack of a rug is the biggest risk for harsh, early reflections. This is your **number one item to fix**.'
        });
    } else if (floor_material === 'hard' && opt_area_rug) {
        listItems.push({
            icon: 'âœ…',
            title: 'Floor Coverage is Good',
            text: 'You have a hard floor, but your rug is a **strong defense** against vertical reflections. Nice work.'
        });
    }

    // **B. Speaker Type Placement Warning**
    if (speaker_type === 'port_rear' && length_m) {
        const minDistance = 0.4; // Common audiophile minimum for rear ports
        listItems.push({
            icon: 'ðŸ”Š',
            title: 'Rear-Ported Speaker Minimum Distance',
            text: `Since you have rear-ported speakers, ensure they are pulled out at least **${minDistance}m** from the front wall to avoid bass boom.`
        });
    }

    // **C. Seating Position Suggestion (Calculated)**
    if (length_m) {
        const targetDistance = (length_m * 0.38).toFixed(2); // Golden ratio start point
        listItems.push({
            icon: 'ðŸ”',
            title: 'Ideal Seating Start Point',
            text: `For your ${length_m}m long room, a great starting distance from the front wall is **${targetDistance}m**. Check your current position against this number.`
        });
    }
    
    // **D. Liveness/Reverb Check**
    if (!opt_curtains) {
        listItems.push({
            icon: 'ðŸªŸ',
            title: 'Tip: Tame Windows',
            text: 'Curtains or heavy blinds are a simple way to instantly reduce reflections and make the room sound tighter.'
        });
    }

    // --- 3. RENDERING THE LIST ---
    const listHtml = listItems.map(item => `
        <li>
            <span class="font-semibold">${item.icon} ${item.title}</span><br>
            ${replaceBold(item.text)}
        </li>
    `).join('');

    // Wrap the dynamic list in the Dave box format
    listEl.innerHTML = `
        <div class="buddy-box mt-2 flex gap-4 items-start">
            <img src="icons/dave.svg" alt="Dave" class="w-15 h-15 mt-1 opacity-90">
            <div class="text-sm leading-relaxed">
                <h3 class="font-semibold text-gray-900 mb-3">Daveâ€™s Setup Checklist</h3>
                <ul class="space-y-3 text-gray-800">
                    ${listHtml}
                </ul>
            </div>
        </div>
        <div class="mt-6">
          <button id="save-all-btn"
                  class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">
            <i class="fas fa-save mr-2"></i>Save Setup
          </button>
        </div>
    `;
    
    // Re-attach the save button event listener
    document.getElementById('save-all-btn').addEventListener('click', saveAllSetup);
}

/* ---------- Save / Load ---------- */
const SESSION='latest';
const API='/api/room';

// NOTE: The event listener for 'save-all-btn' is now attached inside generateChecklist 
// to ensure it works after the element is dynamically created.

async function saveAllSetup(){
  const payload = {

    /* Room dims */
    length_m: parseFloat(document.getElementById('room-length').value),
    width_m:  parseFloat(document.getElementById('room-width').value),
    height_m: parseFloat(document.getElementById('room-height').value),

    /* Echo slider */
    echo_pct: parseInt(document.getElementById('room-echo').value),

    /* Furnishings (UPDATED KEYS) */
    floor_material: document.getElementById('floor-material').value,
    opt_area_rug:   document.getElementById('opt-area-rug').checked,
    opt_barewalls: document.getElementById('opt-barewalls').checked,
    opt_wallart:   document.getElementById('opt-wallart').checked,
    opt_curtains:  document.getElementById('opt-curtains').checked,
    opt_sofa:      document.getElementById('opt-sofa').checked,

    /* Speaker placement */
    spk_front_m:      parseFloat(document.getElementById('speaker-distance').value),
    spk_spacing_m:    parseFloat(document.getElementById('speaker-width').value),
    toe_in_deg:       parseFloat(document.getElementById('toe-angle').value),
    listener_front_m: parseFloat(document.getElementById('listening-distance').value),
    
    /* Speaker Type (NEW KEY) */
    speaker_type: document.getElementById('speaker-type').value,

    /* Profile */
    speaker_key: document.getElementById('speakerSel').value,
    layout: 'stereo'
  };

  console.log("ðŸ’¾ Saving all:", payload);

  const res = await fetch('/api/room/latest',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });

  if(!res.ok){
    toast('Save failed','error');
  } else {
    toast('Room & speakers saved','success');
    // After successful save, refresh the checklist to reflect new data
    loadRoomSetup();
  }
}

async function loadRoomSetup(){
  const res=await fetch(`${API}/${SESSION}`);
  
  // Define roomConfig for checklist generation, using default/fallback values
  const roomConfig = {
    length_m: 4.0, listener_front_m: 2.5, spk_front_m: 0.6,
    floor_material: 'hard', opt_area_rug: false, opt_curtains: false,
    speaker_type: 'sealed'
  };

  if(!res.ok) {
    // If loading fails, generate a checklist with default values
    generateChecklist(roomConfig); 
    return;
  }
  const j=await res.json();
  
  // Helper for loading numeric/float values
  const loadNumeric = (jsonKey, inputId) => {
    if(j[jsonKey] != null){
      const el=document.getElementById(inputId);
      if(el) {
          el.value=j[jsonKey];
          roomConfig[jsonKey] = parseFloat(j[jsonKey]);
      }
    }
  };

  // 1. Load numeric data
  loadNumeric('length_m','room-length');
  loadNumeric('width_m','room-width');
  loadNumeric('height_m','room-height');
  loadNumeric('spk_front_m','speaker-distance');
  loadNumeric('spk_spacing_m','speaker-width');
  loadNumeric('toe_in_deg','toe-angle');
  loadNumeric('listener_front_m','listening-distance');

  /* Load echo */
  if(j.echo_pct != null){
    document.getElementById('room-echo').value = j.echo_pct;
    document.getElementById('roomEchoValue').textContent = j.echo_pct + '%';
  }

  // 2. Load string/select values
  if (j.floor_material) {
      document.getElementById('floor-material').value = j.floor_material;
      roomConfig.floor_material = j.floor_material;
  }
  if (j.speaker_type) {
      document.getElementById('speaker-type').value = j.speaker_type;
      roomConfig.speaker_type = j.speaker_type;
  }
  document.getElementById('speakerSel').value = j.speaker_key || '';


  // 3. Load boolean/checkbox flags
  const loadBoolean = (jsonKey, inputId) => {
      const isChecked = !!j[jsonKey];
      const el = document.getElementById(inputId);
      if(el) el.checked = isChecked;
      roomConfig[jsonKey] = isChecked;
  };
  
  loadBoolean('opt_area_rug', 'opt-area-rug');
  loadBoolean('opt_barewalls', 'opt-barewalls');
  loadBoolean('opt_wallart', 'opt-wallart');
  loadBoolean('opt_curtains', 'opt-curtains');
  loadBoolean('opt_sofa', 'opt-sofa');

  // Now call the checklist generation with the collected data
  generateChecklist(roomConfig);
}

/* ---------- Clock ---------- */
setInterval(()=>{
  const el=document.getElementById('lastUpdated');
  if(el) el.textContent=new Date().toLocaleTimeString();
},1000);

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  // This initializes the status bar polling and loads the room data/checklist
  if (typeof MeasurelyDashboard !== 'undefined' && !window.dashboard) {
      window.dashboard = new MeasurelyDashboard(); 
  }
  loadRoomSetup();
});
</script>

</body>
</html>