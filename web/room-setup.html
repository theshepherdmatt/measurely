<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Measurely â€“ Room Setup</title>

    <link rel="icon" type="image/svg+xml" href="icons/dave.svg">
    <link rel="stylesheet" href="measurely.css">
    <script src="js/plotly.min.js"></script>
</head>

<body>

    <div class="app-layout">

        <!-- MOBILE OVERLAY -->
        <div id="sidebar-overlay"
            style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(4px);">
        </div>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-logo">
                <img src="icons/mainlogo.svg" alt="Measurely logo" style="height: 46px;">
            </div>

            <nav>
                <a href="index.html" class="nav-item">
                    <img src="icons/dashboard.svg" alt="">Dashboard
                </a>

                <a href="room-setup.html" class="nav-item active">
                    <img src="icons/home.svg" alt="">Room Setup
                </a>

            </nav>
        </aside>

          <!-- MAIN CONTENT -->
          <main id="main-content" class="main-content">

          <header class="header animate-enter">

              <!-- FIRST ROW (title + hamburger) -->
              <div class="header-title"
                  style="display:flex; align-items:center; gap:1rem; width:100%;">
                  <div>
                      <h1>Set Your Room Up</h1>
                      <p>Accurate inputs mean tighter predictions.</p>
                  </div>

                  <button id="mobile-menu-btn" class="btn btn-secondary"
                          style="padding:0.5rem; display:none; margin-left:auto;">
                      <img src="icons/bars.svg" style="width:24px;">
                  </button>
              </div>

              <!-- SECOND ROW (EMPTY) â€” this is the missing piece -->
              <div style="height:1px;"></div>

          </header>


            <section class="card glass-panel animate-enter delay-1 room-layout-section">


                <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem;
                    border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:1rem;">
                    <div style="width:32px; height:32px; background:rgba(59,130,246,0.2); color:#93c5fd;
                        border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700;">
                        1
                    </div>
                    <h2 style="margin:0; font-size:1.25rem;">Measure Your Listening Room</h2>
                </div>



                <div class="room-layout-grid-new">

                    <!-- TOP ROW â€” INPUTS (TWO COLUMNS) -->
                    <!-- NEW â€” ONE CLEAN CARD LAYOUT -->
                    <div class="room-setup-grid">

                        <!-- â­ DIAGRAM ALWAYS FIRST -->
                        <div class="diagram-container">
                            <svg id="room-diagram" viewBox="0 0 600 450" preserveAspectRatio="xMidYMid meet">
                                <rect id="room-rect" x="0" y="0" width="600" height="450"
                                    fill="rgba(30,41,59,0.25)"
                                    stroke="rgba(129,140,248,0.7)"
                                    stroke-width="3"
                                    stroke-dasharray="8 6" />

                                <!-- Speakers -->
                                <image id="left-speaker" class="plan-object" href="icons/spl.svg" width="40" height="40"/>
                                <image id="right-speaker" class="plan-object" href="icons/spr.svg" width="40" height="40"/>

                                <!-- Sofa -->
                                <image id="sofa-icon" class="plan-object" href="icons/sofa.svg" width="200" height="120"/>

                                <!-- Toe-in -->
                                <line id="left-toe-line" class="toe-line"/>
                                <line id="right-toe-line" class="toe-line"/>

                                <text id="listening-pos-label" text-anchor="middle"></text>
                            </svg>

                            <div class="explainer-inline">
                                <span><strong>Room:</strong>
                                    <span id="explainer-width">â€”</span> Ã—
                                    <span id="explainer-length">â€”</span> m
                                </span>
                                <span><strong>Speakers:</strong>
                                    <span id="explainer-spacing">â€”</span> m apart
                                </span>
                                <span><strong>Listening:</strong>
                                    <span id="explainer-listen">â€”</span> m
                                </span>
                                <span><strong>Toe-in:</strong>
                                    <span id="explainer-ideal-toe">â€”</span>Â°
                                </span>
                            </div>


                        </div>
                        </div>

                        <!-- ðŸŽ› SLIDERS + NUMBER INPUTS -->
                        <!-- ðŸŽ› CONTROLS GRID (Sliders + Spin Boxes for Mobile) -->
                        <div class="controls-grid">

                            <!-- Row 1 -->
                            <div class="ctrl-block">
                                <label>Width (m): <span id="room-width-val">â€”</span></label>
                                <input type="range" id="room-width" min="2" max="10" step="0.05">
                                <input type="number" id="room-width-num" min="2" max="10" step="0.05">
                            </div>

                            <div class="ctrl-block">
                                <label>Length (m): <span id="room-length-val">â€”</span></label>
                                <input type="range" id="room-length" min="2" max="10" step="0.05">
                                <input type="number" id="room-length-num" min="2" max="10" step="0.05">
                            </div>

                            <div class="ctrl-block">
                                <label>Height (m): <span id="room-height-val">â€”</span></label>
                                <input type="range" id="room-height" min="2" max="3.5" step="0.01">
                                <input type="number" id="room-height-num" min="2" max="3.5" step="0.01">
                            </div>

                            <!-- Row 2 -->
                            <div class="ctrl-block">
                                <label>Speaker Distance (m): <span id="speaker-distance-val">â€”</span></label>
                                <input type="range" id="speaker-distance" min="0" max="3" step="0.05">
                                <input type="number" id="speaker-distance-num" min="0" max="3" step="0.05">
                            </div>

                            <div class="ctrl-block">
                                <label>Speaker Spacing (m): <span id="speaker-width-val">â€”</span></label>
                                <input type="range" id="speaker-width" min="0.5" max="4" step="0.05">
                                <input type="number" id="speaker-width-num" min="0.5" max="4" step="0.05">
                            </div>

                            <div class="ctrl-block">
                                <label>Listening Distance (m): <span id="listening-distance-val">â€”</span></label>
                                <input type="range" id="listening-distance" min="0.5" max="5" step="0.05">
                                <input type="number" id="listening-distance-num" min="0.5" max="5" step="0.05">
                            </div>

                            <!-- Row 3 -->
                            <div class="ctrl-block">
                                <label>Toe-In Angle (Â°): <span id="toe-angle-val">â€”</span></label>
                                <input type="number" id="toe-angle" step="0.1">
                            </div>

                            <div class="ctrl-block">
                                <label>Design Type</label>
                                <select id="speaker-type">
                                    <option value="sealed">Sealed / Infinite Baffle</option>
                                    <option value="port_front">Ported (Front)</option>
                                    <option value="port_rear">Ported (Rear)</option>
                                    <option value="dipole">Dipole / Open Baffle</option>
                                </select>
                            </div>

                            <div class="ctrl-block"></div>

                        </div>


                    </div>

            </section>

            <!-- ===================================================== -->
            <!-- CARD 2 â€” SPEAKER PROFILE -->
            <!-- ===================================================== -->
            <section class="card glass-panel animate-enter delay-2" style="margin-bottom:2rem;">

                <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem;
                  border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:1rem;">
                    <div style="width:32px; height:32px; background:rgba(249,115,22,0.2); color:#fdba74;
                    border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700;">
                        2
                    </div>
                    <h2 style="margin:0; font-size:1.25rem;">Speaker Profile</h2>
                </div>

                <label for="speakerSel">Select Speaker Model</label>
                <select id="speakerSel" style="font-size:1.1rem; padding:1rem;"></select>

                <p id="speakerHint" style="font-size:0.9rem; color:var(--c-text-muted); margin-top:0.75rem;">
                    Select your model to load frequency limits and target behaviour.
                </p>
            </section>

            <!-- ===================================================== -->
            <!-- CARD 3 â€” DAVE OVERVIEW (Dashboard-style consistency) -->
            <!-- ===================================================== -->
            <!-- ===================================================== -->
            <!-- CARD 3 â€” ROOM SUMMARY -->
            <!-- ===================================================== -->
            <section id="room-summary-card" class="card glass-panel animate-enter delay-3" style="margin-bottom:2rem;">

                <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem;
                    border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:1rem;">
                    <div style="width:32px; height:32px; background:rgba(52,211,153,0.25); color:#6ee7b7;
                        border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700;">
                        3
                    </div>
                    <h2 style="margin:0; font-size:1.25rem;">Room Summary</h2>
                </div>

                <div id="room-summary-content" style="display:grid; gap:0.75rem;">

                    <!-- ðŸ  ROOM -->
                    <div>
                        <strong>Room:</strong>
                        <span id="sum-room-size">â€”</span> (approx <span id="sum-room-volume">â€”</span> mÂ³)
                        <br>
                        <span id="sum-room-shape" style="color:var(--c-text-muted); font-size:0.85rem;">â€”</span>
                    </div>

                    <!-- ðŸ”Š SPEAKERS -->
                    <div>
                        <strong>Speakers:</strong>
                        <span id="sum-speaker-model">â€”</span>
                        <br>
                        <span id="sum-speaker-spacing">â€”</span> apart, <span id="sum-speaker-distance">â€”</span> from wall
                        <br>
                        <span id="sum-triangle" style="color:var(--c-text-muted); font-size:0.85rem;">â€”</span>
                    </div>

                    <!-- ðŸŽ¯ TOE-IN -->
                    <div>
                        <strong>Toe-in:</strong>
                        <span id="sum-toe-angle">â€”</span>
                        <br>
                        <span id="sum-toe-comment" style="color:var(--c-text-muted); font-size:0.85rem;">â€”</span>
                    </div>

                </div>

            </section>

            <!-- ===================================================== -->
            <!-- CARD 4 â€” MATERIALS & FURNISHINGS -->
            <!-- ===================================================== -->
            <section class="card glass-panel animate-enter delay-3" style="margin-bottom:2rem;">

                <div class="card-title" style="display:flex; align-items:center; gap:1rem;">
                    <div style="width:32px; height:32px; background:rgba(168,85,247,0.2); color:#c084fc;
                    border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700;">
                        4
                    </div>
                    <h2 style="margin:0;">Materials & Furnishings</h2>
                </div>

                <div class="materials-stack" style="display:flex; flex-direction:column; gap:1.5rem;">

                    <!-- Floor -->
                    <div>
                        <label for="floor-material">Base Floor Surface</label>
                        <select id="floor-material">
                            <option value="hard">Hardwood / Tile / Laminate</option>
                            <option value="carpet">Wall-to-Wall Carpet</option>
                        </select>
                    </div>

                    <!-- Room Liveliness -->
                    <div>
                        <label for="room-echo">Room Liveliness</label>
                        <select id="room-echo">
                            <option value="10">Dry / Dead</option>
                            <option value="25">Slightly Live</option>
                            <option value="50" selected>Normal</option>
                            <option value="75">Live</option>
                            <option value="90">Very Echoey</option>
                        </select>
                    </div>

                    <!-- Contents -->
                    <div>
                        <label>Room Contents</label>
                        <div class="grid-2 room-contents" style="gap:1rem;">
                            <label class="checkbox-group">
                                <input type="checkbox" id="opt-area-rug">
                                <span>Area Rug</span>
                            </label>
                            <label class="checkbox-group">
                                <input type="checkbox" id="opt-curtains">
                                <span>Curtains / Blinds</span>
                            </label>
                            <label class="checkbox-group">
                                <input type="checkbox" id="opt-sofa">
                                <span>Large Sofa</span>
                            </label>
                            <label class="checkbox-group">
                                <input type="checkbox" id="opt-wallart">
                                <span>Wall Art / Shelves</span>
                            </label>
                            <label class="checkbox-group">
                                <input type="checkbox" id="opt-barewalls">
                                <span>Mostly Bare Walls</span>
                            </label>

                        </div>
                    </div>

                </div>
            </section>

            <!-- ===================================================== -->
            <!-- SAVE BUTTON -->
            <!-- ===================================================== -->
            <section style="margin-bottom:3rem;">
                <button id="save-all-btn" class="btn btn-primary" style="width:100%; padding:1rem; font-size:1.1rem;">
                    Save Setup
                </button>
            </section>

        </main>
    </div>

    <!-- ====================================================================== -->
    <!-- SCRIPTS -->
    <!-- ====================================================================== -->

    <script src="/js/dashboard.js"></script>
    <script type="module" src="/js/devices.js"></script>
    <script type="module" src="js/room.js"></script>
    <script src="js/room-diagram.js"></script>

    <script>
    document.getElementById('save-all-btn').addEventListener('click', () => {
    if (window.saveRoom) saveRoom();
    });
    document.addEventListener('DOMContentLoaded', () => {
    if (window.loadRoomSetup) loadRoomSetup();
    });
    </script>

    <script>
    async function loadSpeakers() {
        const dropdown = document.getElementById('speakerSel');
        dropdown.innerHTML = `<option>Loadingâ€¦</option>`;

        try {
            const res = await fetch('/api/speakers');
            const data = await res.json();

            dropdown.innerHTML = '';

            data.list.forEach(spk => {
                const opt = document.createElement('option');
                opt.value = spk.key;
                opt.textContent = spk.name;
                dropdown.appendChild(opt);
            });

            if (data.current?.key) {
                dropdown.value = data.current.key;
            }

        } catch (err) {
            console.error("Speaker API failed", err);
            dropdown.innerHTML = `<option value="unknown">Unknown</option>`;
        }
    }

    // Run speaker loader when page ready
    document.addEventListener('DOMContentLoaded', loadSpeakers);
    </script>


    <script>
        /* ============================================================
           TOAST
        ============================================================ */
        function toast(msg, type = 'info') {
            const box = document.createElement('div');
            box.style.cssText = `
    position:fixed; top:1rem; right:1rem;
    padding:0.75rem 1rem;
    border-radius:8px;
    color:white;
    font-size:0.9rem;
    z-index:200;
    transition:all 0.3s;
    background:${type === 'error'
                    ? '#ef4444'
                    : type === 'success'
                        ? '#10b981'
                        : '#3b82f6'};
  `;
            box.textContent = msg;
            document.body.appendChild(box);

            setTimeout(() => box.style.opacity = '0', 2000);
            setTimeout(() => box.remove(), 2400);
        }

    function updateValue(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const valSpan = document.getElementById(id + '-val');
        if (!valSpan) return;

        let unit = id === 'toe-angle' ? 'Â°' : 'm';
        valSpan.textContent = parseFloat(el.value).toFixed(2) + unit;

        // Hook into your current update flow:
        if (window.diagram && diagram.update) diagram.update();
    }


        /* ============================================================
           MOBILE MENU TOGGLE
        ============================================================ */
        const btn = document.getElementById('mobile-menu-btn');
        const side = document.getElementById('sidebar');
        const over = document.getElementById('sidebar-overlay');

        function toggleMenu() {
            side.classList.toggle("active");
            over.classList.toggle("active");
            document.body.style.overflow = side.classList.contains("active") ? "hidden" : "";
        }

        if (btn) btn.addEventListener('click', toggleMenu);
        if (over) over.addEventListener('click', toggleMenu);

        // Close menu when clicking a nav item on mobile
        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 1024) {
                    side.classList.remove('active');
                    over.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        });


        document.addEventListener('DOMContentLoaded', () => {
            // Bind live updates to EVERY control that has a -val element
            const ids = [
                'room-width',
                'room-length',
                'room-height',
                'speaker-distance',
                'speaker-width',
                'listening-distance',
                'toe-angle'
            ];

            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', () => updateValue(id));
                el.addEventListener('change', () => updateValue(id));
                
                // Run once on load so it doesn't show "â€”"
                updateValue(id);
            });
        });

    </script>

</body>

</html>