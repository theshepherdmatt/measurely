<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Measurely â€“ RoomSetup</title>
  <link rel="icon" type="image/svg+xml" href="icons/favicon.svg">
  <link rel="alternate icon" href="favicon.ico">
  <link rel="stylesheet" href="measurely.css">
  <script src="tailwind.js"></script>
  <script src="js/plotly.min.js"></script>
  <link rel="stylesheet" href="fonts/inter/interweb/inter.css">

  <style>
  </style>

<base target="_blank">
</head>

<body class="bg-gray-300">
<div class="mobile-banner md:hidden fixed top-0 left-0 right-0 h-14 backdrop-blur-sm
            flex items-center justify-between px-4 z-50">
  <div class="flex items-center space-x-2">
    <img src="icons/mainlogo.svg"
        class="max-h-10 w-auto object-contain"
        alt="Measurely Logo">


  </div>
  <button id="mobile-menu-btn" class="p-2 rounded-lg text-white hover:bg-white/10 transition">
    <img src="icons/bars.svg" class="w-6 h-6" alt="">
  </button>
</div>

<div id="sidebar-overlay" class="sidebar-overlay"></div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-logo mb-8 flex items-center space-x-3">
    <img src="icons/mainlogo2.svg" class="w-15 h-15" alt="Measurely Buddy">
    <div>
    </div>
  </div>
    <nav class="space-y-2">

      <a href="index.html" class="nav-item">
        <img src="icons/dashboard.svg" class="w-5 h-5 mr-3 inline-block" />
        Dashboard
      </a>

      <a href="room-setup.html" class="nav-item">
        <img src="icons/home.svg" class="w-5 h-5 mr-3 inline-block" />
        Room Setup
      </a>

      <a href="tipsandtweaks.html" class="nav-item">
        <img src="icons/lightbulb.svg" class="w-5 h-5 mr-3 inline-block" />
        Tips and Tweaks
      </a>

    </nav>
<div class="absolute bottom-6 left-6 right-6">

  <div class="bg-white/20 backdrop-blur-md rounded-lg p-4 space-y-3">

    <div class="flex items-center">
      <div id="systemReadyDot" class="status-indicator status-good pulse-animation"></div>
      <span id="systemReadyText" class="text-sm">System Ready</span>
    </div>

    <div class="flex items-center">
      <div id="dacStatusDot" class="status-indicator bg-yellow-400"></div>
      <span id="dacStatusText" class="text-sm">DAC: Not Found</span>
    </div>

    <div class="flex items-center">
      <div id="usbStatusDot" class="status-indicator bg-red-400"></div>
      <span id="usbStatusText" class="text-sm">USB Mic: Not Connected</span>
    </div>

    <p class="text-xs opacity-80">
      Last updated: <span id="lastUpdated">Now</span>
    </p>

  </div>

</div>

</aside>

<div class="main-content md:ml-64 p-8">

    <div class="page-title-block">
        <h1 class="page-title">Set Your Room Up With Dave</h1>
        <p class="page-subtitle">We need precise details on your room and gear, accurate numbers mean cleaner sweeps and smarter fixes.</p>
    </div>

    <div class="card mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-ruler-combined mr-2"></i>Dave Needs a Few Room Details
        </h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">

            <div class="inner-card">
                <label class="text-sm font-semibold text-gray-700">Length (m)</label>
                <input type="number" id="room-length" class="input-field w-full mt-2"
                       placeholder="4.9" value="4.9" step="0.01">
            </div>

            <div class="inner-card">
                <label class="text-sm font-semibold text-gray-700">Width (m)</label>
                <input type="number" id="room-width" class="input-field w-full mt-2"
                       placeholder="3.7" value="3.7" step="0.01">
            </div>

            <div class="inner-card">
                <label class="text-sm font-semibold text-gray-700">Height (m)</label>
                <input type="number" id="room-height" class="input-field w-full mt-2"
                       placeholder="2.4" value="2.4" step="0.01">
            </div>

            <div class="inner-card">
                <label class="text-sm font-semibold text-gray-700">
                    Room Echo-y-ness (%)
                </label>

                <input
                  type="range"
                  id="room-echo"
                  min="0"
                  max="100"
                  step="5"
                  value="20"
                  class="w-full mt-3 accent-indigo-600"
                  oninput="roomEchoValue.textContent = this.value + '%'"
                >

                <div class="flex justify-between text-xs text-gray-600 mt-2">
                    <span>Dry</span>
                    <span id="roomEchoValue">20%</span>
                    <span>Echoey</span>
                </div>

                <p class="text-xs text-gray-500 mt-2">
                    Your subjective rating of how lively or reflective the room feels.
                </p>
            </div>

        </div>
    </div>

    <div class="card mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-couch mr-2 text-indigo-600"></i>Whatâ€™s Your Room Made Of?
        </h3>

        <p class="text-sm text-gray-600 mb-4">
            These help Dave understand the baseline absorption and reflection points.
        </p>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">

            <div class="inner-card p-3 rounded-lg border border-gray-200">
                <label class="text-sm font-semibold text-gray-700 block mb-2">Base Floor Surface</label>
                <select id="floor-material" class="input-field w-full">
                    <option value="hard">Hardwood / Laminate / Tile</option>
                    <option value="carpet">Wall-to-Wall Carpet</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">The primary floor covering.</p>
            </div>
            
            <label class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <input type="checkbox" id="opt-area-rug" class="h-4 w-4">
                <span class="text-sm text-gray-800">Thick Area Rug (between speakers & seat)</span>
            </label>

            <label class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <input type="checkbox" id="opt-barewalls" class="h-4 w-4">
                <span class="text-sm text-gray-800">Mostly bare walls</span>
            </label>

            <label class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <input type="checkbox" id="opt-wallart" class="h-4 w-4">
                <span class="text-sm text-gray-800">Wall art / shelves / diffusers</span>
            </label>

            <label class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <input type="checkbox" id="opt-curtains" class="h-4 w-4">
                <span class="text-sm text-gray-800">Curtains / blinds</span>
            </label>

            <label class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <input type="checkbox" id="opt-sofa" class="h-4 w-4">
                <span class="text-sm text-gray-800">Large sofa / soft furnishings</span>
            </label>

        </div>
    </div>

    <div class="card mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-microchip mr-2 text-indigo-600"></i>Tell Dave What Speakers Youâ€™re Using
        </h3>

        <label class="block text-sm font-medium text-gray-700 mb-2">
            Choose profile for sweep limits & target curve
        </label>

        <select id="speakerSel" class="input-field w-full"></select>
        <p id="speakerHint" class="text-xs text-gray-500 mt-2">Loading profilesâ€¦</p>
    </div>

    <div class="card mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-volume-up mr-2"></i>Where Are Your Speakers Right Now?
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="inner-card">
                <label class="text-sm font-semibold text-gray-700">Speaker Porting/Design</label>
                <select id="speaker-type" class="input-field w-full mt-2">
                    <option value="sealed">Sealed Box / Infinite Baffle</option>
                    <option value="port_front">Ported (Front-Firing)</option>
                    <option value="port_rear">Ported (Rear-Firing)</option>
                    <option value="dipole">Dipole / Open Baffle</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Crucial for bass behavior near walls.</p>
            </div>

            <div class="inner-card">
                <label class="text-sm font-semibold text-gray-700">Distance from Front Wall (m)</label>
                <input type="number" id="speaker-distance" class="input-field w-full mt-2"
                       placeholder="0.6" value="0.6" step="0.01">
            </div>

            <div class="inner-card">
                <label class="text-sm font-semibold text-gray-700">Speaker Spacing (m)</label>
                <input type="number" id="speaker-width" class="input-field w-full mt-2"
                       placeholder="1.5" value="1.5" step="0.01">
            </div>

            <div class="inner-card">
                <label class="text-sm font-semibold text-gray-700">Toe-in Angle (degrees)</label>
                <input type="number" id="toe-angle" class="input-field w-full mt-2"
                       placeholder="30" value="30" step="1">
            </div>

            <div class="inner-card">
                <label class="text-sm font-semibold text-gray-700">Listening Distance (m)</label>
                <input type="number" id="listening-distance" class="input-field w-full mt-2"
                       placeholder="2.5" value="2.5" step="0.01">
            </div>

        </div>
    </div>

    <div class="card mb-8">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">
        <i class="fas fa-lightbulb mr-2"></i>Daveâ€™s Room Setup Checklist
      </h2>
      <div class="space-y-4" id="recommendations-list">
        </div>
    </div>

</div>

<script src="/js/dashboard.js"></script>
<script type="module" src="/js/devices.js"></script>
<script type="module">
  import { initSpeakers } from '/js/speakers.js';
  document.addEventListener('DOMContentLoaded', async () => {
    await initSpeakers();
  });
</script>

<script>
/* ---------- Sidebar toggle ---------- */
const btn = document.getElementById('mobile-menu-btn');
const side = document.getElementById('sidebar');
const over = document.getElementById('sidebar-overlay');
function toggleMenu(){
  side.classList.toggle('active');
  over.classList.toggle('active');
  document.body.style.overflow = side.classList.contains('active') ? 'hidden' : '';
}
btn.addEventListener('click', toggleMenu);
over.addEventListener('click', toggleMenu);

/* ---------- Toast ---------- */
function toast(msg,type='info'){
  const box=document.createElement('div');
  box.className = `fixed top-4 right-4 p-3 rounded text-white text-sm z-50 transition-all duration-300 ${
    type==='error'?'bg-red-600':type==='success'?'bg-green-600':'bg-blue-600'
  }`;
  box.textContent=msg;
  document.body.appendChild(box);
  setTimeout(()=>box.classList.add('opacity-0'),10);
  setTimeout(()=>box.remove(),1000);
}

/* ---------- Dynamic Checklist Generation (relies on global replaceBold) ---------- */

function generateChecklist(roomConfig) {
    const listEl = document.getElementById('recommendations-list');
    listEl.innerHTML = ''; // Clear previous content

    const { 
        length_m, 
        spk_spacing_m, 
        floor_material, 
        opt_area_rug, 
        opt_curtains, 
        speaker_type,
        listener_front_m
    } = roomConfig;

    const listItems = [];
    
    // --- 1. CORE MEASUREMENT ACCURACY ---
    listItems.push({
        icon: 'ðŸ§°',
        title: 'Grab a tape measure',
        text: 'Accurate distances make a huge difference to the sweep results.'
    });
    listItems.push({
        icon: 'ðŸŽ¯',
        title: 'Mic Placement is Everything',
        text: 'Ear height, centred, in your normal listening spot â€” not â€œnear itâ€.'
    });

    // --- 2. DYNAMIC ADVICE BASED ON INPUT ---
    
    // **A. Floor/Rug Advice**
    if (floor_material === 'hard' && !opt_area_rug) {
        listItems.push({
            icon: 'ðŸ’¥',
            title: 'Action: Floor Reflection Warning',
            text: 'Your **hard floor** and lack of a rug is the biggest risk for harsh, early reflections. This is your **number one item to fix**.'
        });
    } else if (floor_material === 'hard' && opt_area_rug) {
        listItems.push({
            icon: 'âœ…',
            title: 'Floor Coverage is Good',
            text: 'You have a hard floor, but your rug is a **strong defense** against vertical reflections. Nice work.'
        });
    }

    // **B. Speaker Type Placement Warning**
    if (speaker_type === 'port_rear' && length_m) {
        const minDistance = 0.4; // Common audiophile minimum for rear ports
        listItems.push({
            icon: 'ðŸ”Š',
            title: 'Rear-Ported Speaker Minimum Distance',
            text: `Since you have rear-ported speakers, ensure they are pulled out at least **${minDistance}m** from the front wall to avoid bass boom.`
        });
    }

    // **C. Seating Position Suggestion (Calculated)**
    if (length_m) {
        const targetDistance = (length_m * 0.38).toFixed(2); // Golden ratio start point
        listItems.push({
            icon: 'ðŸ”',
            title: 'Ideal Seating Start Point',
            text: `For your ${length_m}m long room, a great starting distance from the front wall is **${targetDistance}m**. Check your current position against this number.`
        });
    }
    
    // **D. Liveness/Reverb Check**
    if (!opt_curtains) {
        listItems.push({
            icon: 'ðŸªŸ',
            title: 'Tip: Tame Windows',
            text: 'Curtains or heavy blinds are a simple way to instantly reduce reflections and make the room sound tighter.'
        });
    }

    // --- 3. RENDERING THE LIST ---
    const listHtml = listItems.map(item => `
        <li>
            <span class="font-semibold">${item.icon} ${item.title}</span><br>
            ${replaceBold(item.text)}
        </li>
    `).join('');

    // Wrap the dynamic list in the Dave box format
    listEl.innerHTML = `
        <div class="buddy-box mt-2 flex gap-4 items-start">
            <img src="icons/dave.svg" alt="Dave" class="w-15 h-15 mt-1 opacity-90">
            <div class="text-sm leading-relaxed">
                <h3 class="font-semibold text-gray-900 mb-3">Daveâ€™s Setup Checklist</h3>
                <ul class="space-y-3 text-gray-800">
                    ${listHtml}
                </ul>
            </div>
        </div>
        <div class="mt-6">
          <button id="save-all-btn"
                  class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">
            <i class="fas fa-save mr-2"></i>Save Setup
          </button>
        </div>
    `;
    
    // Re-attach the save button event listener
    document.getElementById('save-all-btn').addEventListener('click', saveAllSetup);
}

/* ---------- Save / Load ---------- */
const SESSION='latest';
const API='/api/room';

// NOTE: The event listener for 'save-all-btn' is now attached inside generateChecklist 
// to ensure it works after the element is dynamically created.

async function saveAllSetup(){
  const payload = {

    /* Room dims */
    length_m: parseFloat(document.getElementById('room-length').value),
    width_m:  parseFloat(document.getElementById('room-width').value),
    height_m: parseFloat(document.getElementById('room-height').value),

    /* Echo slider */
    echo_pct: parseInt(document.getElementById('room-echo').value),

    /* Furnishings (UPDATED KEYS) */
    floor_material: document.getElementById('floor-material').value,
    opt_area_rug:   document.getElementById('opt-area-rug').checked,
    opt_barewalls: document.getElementById('opt-barewalls').checked,
    opt_wallart:   document.getElementById('opt-wallart').checked,
    opt_curtains:  document.getElementById('opt-curtains').checked,
    opt_sofa:      document.getElementById('opt-sofa').checked,

    /* Speaker placement */
    spk_front_m:      parseFloat(document.getElementById('speaker-distance').value),
    spk_spacing_m:    parseFloat(document.getElementById('speaker-width').value),
    toe_in_deg:       parseFloat(document.getElementById('toe-angle').value),
    listener_front_m: parseFloat(document.getElementById('listening-distance').value),
    
    /* Speaker Type (NEW KEY) */
    speaker_type: document.getElementById('speaker-type').value,

    /* Profile */
    speaker_key: document.getElementById('speakerSel').value,
    layout: 'stereo'
  };

  console.log("ðŸ’¾ Saving all:", payload);

  const res = await fetch('/api/room/latest',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });

  if(!res.ok){
    toast('Save failed','error');
  } else {
    toast('Room & speakers saved','success');
    // After successful save, refresh the checklist to reflect new data
    loadRoomSetup();
  }
}

async function loadRoomSetup(){
  const res=await fetch(`${API}/${SESSION}`);
  
  // Define roomConfig for checklist generation, using default/fallback values
  const roomConfig = {
    length_m: 4.0, listener_front_m: 2.5, spk_front_m: 0.6,
    floor_material: 'hard', opt_area_rug: false, opt_curtains: false,
    speaker_type: 'sealed'
  };

  if(!res.ok) {
    // If loading fails, generate a checklist with default values
    generateChecklist(roomConfig); 
    return;
  }
  const j=await res.json();
  
  // Helper for loading numeric/float values
  const loadNumeric = (jsonKey, inputId) => {
    if(j[jsonKey] != null){
      const el=document.getElementById(inputId);
      if(el) {
          el.value=j[jsonKey];
          roomConfig[jsonKey] = parseFloat(j[jsonKey]);
      }
    }
  };

  // 1. Load numeric data
  loadNumeric('length_m','room-length');
  loadNumeric('width_m','room-width');
  loadNumeric('height_m','room-height');
  loadNumeric('spk_front_m','speaker-distance');
  loadNumeric('spk_spacing_m','speaker-width');
  loadNumeric('toe_in_deg','toe-angle');
  loadNumeric('listener_front_m','listening-distance');

  /* Load echo */
  if(j.echo_pct != null){
    document.getElementById('room-echo').value = j.echo_pct;
    document.getElementById('roomEchoValue').textContent = j.echo_pct + '%';
  }

  // 2. Load string/select values
  if (j.floor_material) {
      document.getElementById('floor-material').value = j.floor_material;
      roomConfig.floor_material = j.floor_material;
  }
  if (j.speaker_type) {
      document.getElementById('speaker-type').value = j.speaker_type;
      roomConfig.speaker_type = j.speaker_type;
  }
  document.getElementById('speakerSel').value = j.speaker_key || '';


  // 3. Load boolean/checkbox flags
  const loadBoolean = (jsonKey, inputId) => {
      const isChecked = !!j[jsonKey];
      const el = document.getElementById(inputId);
      if(el) el.checked = isChecked;
      roomConfig[jsonKey] = isChecked;
  };
  
  loadBoolean('opt_area_rug', 'opt-area-rug');
  loadBoolean('opt_barewalls', 'opt-barewalls');
  loadBoolean('opt_wallart', 'opt-wallart');
  loadBoolean('opt_curtains', 'opt-curtains');
  loadBoolean('opt_sofa', 'opt-sofa');

  // Now call the checklist generation with the collected data
  generateChecklist(roomConfig);
}

/* ---------- Clock ---------- */
setInterval(()=>{
  const el=document.getElementById('lastUpdated');
  if(el) el.textContent=new Date().toLocaleTimeString();
},1000);

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  // This initializes the status bar polling and loads the room data/checklist
  if (typeof MeasurelyDashboard !== 'undefined' && !window.dashboard) {
      window.dashboard = new MeasurelyDashboard(); 
  }
  loadRoomSetup();
});
</script>

</body>
</html>