<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Measurely</title>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <header role="banner">
    <img src="./measurely.svg" alt="Measurely" class="logo">
  </header>

  <main id="main" class="wrap" role="main" aria-labelledby="page-title">
    <h1 id="page-title" class="visually-hidden">Measurely setup and room analysis</h1>

    <!-- Global polite announcer -->
    <div id="sr-announcer" class="visually-hidden" aria-live="polite"></div>

    <!-- Welcome -->
    <section class="card" aria-labelledby="welcome-heading">
      <h2 id="welcome-heading" class="card-title">Welcome to Measurely</h2>
      <p class="subhead">Plug in your USB microphone and connect the DAC to your amplifier. Join Wi-Fi if needed, enter a few room details, then run a sweep. Results appear below with simple advice and geek details.</p>
    </section>

    <!-- Devices -->
    <section class="card" aria-labelledby="io-heading">
      <h2 id="io-heading" class="card-title">Inputs &amp; outputs</h2>
      <p class="small muted io-tip">Tip: Measurely checks devices every few seconds. If your mic or DAC doesn’t show “Connected”, plug it in and wait a moment. Use a USB mic and connect DAC RCA to your amp’s line input.</p>

      <div class="io-grid">
        <section class="io-box">
          <div class="io-head">
            <span class="io-label" id="micHeading">Input: Microphone</span>
            <span id="micStatus" class="status warn" role="status" aria-live="polite">Not found</span>
          </div>
          <div id="micName" class="io-name" aria-describedby="micHeading"></div>
        </section>

        <section class="io-box">
          <div class="io-head">
            <span class="io-label" id="dacHeading">Output: DAC</span>
            <span id="dacStatus" class="status warn" role="status" aria-live="polite">Not found</span>
          </div>
          <div id="dacName" class="io-name" aria-describedby="dacHeading"></div>
        </section>
      </div>
    </section>

    <!-- Wi-Fi -->
    <section class="card" id="wifiCard" aria-labelledby="wifi-heading">
      <h2 id="wifi-heading" class="card-title">Wi-Fi setup</h2>
      <p class="subhead" id="wifiStatusLine" role="status" aria-live="polite">Status: checking…</p>

      <div class="subsection">
        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <p class="subhead" id="wifiSelHelp">Select your network and connect.</p>
          <button id="wifiScanBtn" aria-describedby="wifiSelHelp">Scan</button>
        </div>
        <label class="visually-hidden" for="wifiSel">Available Wi-Fi networks</label>
        <select id="wifiSel" aria-describedby="wifiSelHelp"></select>
      </div>

      <div class="subsection" id="wifiPwdWrap" style="display:none;">
        <label for="wifiPwd" class="subhead">Password</label>
        <input id="wifiPwd" type="password" placeholder="Wi-Fi password" autocomplete="current-password" inputmode="text">
      </div>

      <div class="actions">
        <button id="wifiConnectBtn" class="primary">Connect</button>
        <button id="hotspotStopBtn" style="margin-left:auto">Stop hotspot</button>
        <span id="wifiMsg" class="small muted" role="status" aria-live="polite"></span>
      </div>

      <p class="small muted" id="wifiHint" style="margin-top:8px;">
        Tip: once connected, open <code>http://measurely.local/</code> on your home network.
      </p>
    </section>

    <!-- Room & placement -->
    <section class="card compact" aria-labelledby="room-heading">
      <h2 id="room-heading" class="card-title">Room &amp; placement</h2>

      <details class="hint">
        <summary>Quick tip</summary>
        <p class="small muted">These measurements help tailor advice for your space. Use metres (m). Nearest 5–10&nbsp;cm is fine.</p>
      </details>

      <div class="subsection" aria-labelledby="room-measurements-heading">
        <div class="subhead" id="room-measurements-heading">Room measurements</div>
        <div class="grid-3">
          <div class="with-unit">
            <label for="roomL">Room length (metres)</label>
            <input id="roomL" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="roomLUnit">
            <span id="roomLUnit" class="unit">m</span>
          </div>
          <div class="with-unit">
            <label for="roomW">Room width (metres)</label>
            <input id="roomW" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="roomWUnit">
            <span id="roomWUnit" class="unit">m</span>
          </div>
          <div class="with-unit">
            <label for="roomH">Ceiling height (metres)</label>
            <input id="roomH" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="roomHUnit">
            <span id="roomHUnit" class="unit">m</span>
          </div>
        </div>
      </div>

      <div class="rule" role="separator" aria-hidden="true"></div>

      <div class="subsection" aria-labelledby="speaker-placement-heading">
        <div class="subhead" id="speaker-placement-heading">Speaker placement</div>

        <details class="hint">
          <summary>Guidelines</summary>
          <p class="small muted">
            Start with speakers <b>0.4–0.8&nbsp;m</b> from the front wall, listener centred,
            and <b>speaker spacing ≈ 0.8–1.0×</b> the listener distance. Enter your current positions—we’ll suggest tweaks after the sweep.
          </p>
        </details>

        <div class="grid-3">
          <div class="with-unit">
            <label for="spkFront">Speaker to front wall (metres)</label>
            <input id="spkFront" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="spkFrontUnit">
            <span id="spkFrontUnit" class="unit">m</span>
          </div>
          <div class="with-unit">
            <label for="lstToSpk">Listener to front wall (metres)</label>
            <input id="lstToSpk" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="lstToSpkUnit">
            <span id="lstToSpkUnit" class="unit">m</span>
          </div>
          <div class="with-unit">
            <label for="spkSpacing">Speaker spacing (metres)</label>
            <input id="spkSpacing" type="number" step="0.01" min="0" inputmode="decimal" aria-describedby="spkSpacingUnit">
            <span id="spkSpacingUnit" class="unit">m</span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="saveRoomBtn">Save room &amp; placement</button>
        <span id="saveRoomMsg" class="small muted" role="status" aria-live="polite"></span>
      </div>
    </section>

    <!-- Sweep -->
    <section class="card" aria-labelledby="sweep-heading">
      <h2 id="sweep-heading" class="card-title">Sweep</h2>
      <div class="hero">
        <button id="runBtn" class="primary" disabled aria-disabled="true" aria-describedby="hint">Run room sweep</button>
        <span id="hint" class="small muted" role="status" aria-live="polite">Checking devices…</span>
      </div>
      <p class="small muted" style="margin-top:8px;">Tip: Keep the room quiet. Place the mic at ear height at your main seat. Set volume to a comfortable level (not loud), then press <b>Run room sweep</b>.</p>
      <div class="subhead" style="margin-top:12px;">Logs</div>
      <pre id="logs" role="log" aria-live="polite" aria-relevant="additions text">Press “Run room sweep”.</pre>
    </section>

    <!-- Results -->
    <section class="card" id="resultCard" aria-labelledby="results-heading" style="display:none;">
      <h2 id="results-heading" class="card-title">Results</h2>
      <p class="small muted">You’ll see an overall score plus section scores and clear actions to improve your sound.</p>

      <!-- Structured results -->
      <div id="results-structured" class="results-grid"></div>

      <div class="rule" role="separator" aria-hidden="true"></div>

      <!-- Pretty graph UI -->
      <div class="subhead" style="margin-top:4px;">Graphs</div>
      <div id="graphs-pretty" class="graph-wrap" hidden>
        <div class="graph-toolbar">
          <label for="smoothSel">Smoothing:</label>
          <select id="smoothSel">
            <option value="none">None</option>
            <option value="12">1/12 octave</option>
            <option value="6" selected>1/6 octave</option>
            <option value="3">1/3 octave</option>
          </select>

          <label for="bandSel">Target band:</label>
          <select id="bandSel">
            <option value="0">Off</option>
            <option value="2">±2 dB</option>
            <option value="3" selected>±3 dB</option>
            <option value="5">±5 dB</option>
          </select>

          <span class="badge" id="cursorReadout" aria-live="polite">— Hz, — dB</span>
        </div>

        <div class="graph-legend" id="graphLegend"></div>
        <div class="svg-host" id="graphHost" role="img" aria-label="Frequency response graph"></div>
        <p class="graph-tip">Tip: Click legend items to show/hide sweeps. Drag to pan, wheel to zoom. Double-click to reset.</p>
      </div>

      <!-- Geek details + empty placeholder -->
      <details class="mly-details" id="mly-geek">
        <summary class="mly-link" role="button" aria-controls="mly-geek-box">Show Geek Details</summary>
        <div id="mly-geek-box">
          <pre id="mly-geek-json" class="mly-pre" aria-live="polite"></pre>
        </div>
      </details>
      <div class="mly-empty" id="mly-empty" hidden>(no recent analysis found)</div>

      <!-- Raw summary & PNG fallback -->
      <div class="subhead" style="margin-top:10px;">Summary (raw)</div>
      <pre id="summary" aria-label="Analysis summary">(no result yet)</pre>
      <div id="graphs" class="muted" role="region" aria-label="Analysis graphs">(none)</div>
    </section>

    <!-- Section Scores (separate full-width card; placed above sessions) -->
    <section class="card" id="sectionScoresCard" aria-labelledby="section-scores-heading" style="display:none;">
      <h2 id="section-scores-heading" class="card-title">Section scores</h2>
      <div id="sectionScoresGrid" class="mly-grid"></div>
    </section>

    <!-- Sessions -->
    <section class="card" aria-labelledby="sessions-heading">
      <h2 id="sessions-heading" class="card-title">Past sessions</h2>
      <div id="sessions" class="muted" role="region" aria-live="polite">(none)</div>
    </section>

  </main>

  <!-- App entry (ES module that imports your split files) -->
  <script type="module" src="./js/main.js"></script>
  <noscript><p style="padding:1rem">JavaScript is required to run Measurely.</p></noscript>
</body>
</html>
