<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Measurely – Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="icons/dave.svg">
    <link rel="stylesheet" href="measurely.css">
    <script src="js/plotly.min.js"></script>
</head>

<body>

    <div class="app-layout">

        <!-- MOBILE OVERLAY -->
        <div id="sidebar-overlay" aria-hidden="true"
            style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(4px);">
        </div>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="sidebar" aria-label="Primary Navigation">
            <div class="sidebar-logo">
                <img src="icons/mainlogo.svg" alt="" aria-hidden="true" style="height: 46px;">
                <span></span>
            </div>

            <nav aria-label="Main">
                <a href="index.html" class="nav-item active">
                    <img src="icons/dashboard.svg" alt="" aria-hidden="true">
                    Dashboard
                </a>
                <a href="room-setup.html" class="nav-item">
                    <img src="icons/home.svg" alt="" aria-hidden="true">
                    Room Setup
                </a>
                <a href="tipsandtweaks.html" class="nav-item">
                    <img src="icons/lightbulb.svg" alt="" aria-hidden="true">
                    Tips & Tweaks
                </a>
            </nav>

            <div style="margin-top: auto;" aria-hidden="true">
                <div class="glass-panel"
                    style="padding: 1rem; border-radius: 12px; display: flex; flex-direction: column; gap: 0.75rem;">

                    <!-- SYSTEM READY -->
                    <div
                        style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--c-text-muted);">
                        <div id="systemReadyDot" class="status-indicator"
                            style="width: 8px; height: 8px; border-radius: 50%; background: var(--c-excellent);">
                        </div>
                        <span id="systemReadyText">System Ready</span>
                    </div>

                    <!-- DAC STATUS -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div id="dacStatusDot" class="status-indicator"
                            style="width: 10px; height: 10px; border-radius: 50%;">
                        </div>
                        <span id="dacStatusText" style="font-size: 0.8rem; color: var(--c-text-muted);">--</span>
                    </div>

                    <!-- MIC STATUS -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div id="usbStatusDot" class="status-indicator"
                            style="width: 10px; height: 10px; border-radius: 50%;">
                        </div>
                        <span id="usbStatusText" style="font-size: 0.8rem; color: var(--c-text-muted);">--</span>
                    </div>

                    <!-- LAST UPDATED -->
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.3); margin-top: 0.5rem;">
                        Last updated: <span id="lastUpdated">Now</span>
                    </div>
                </div>
            </div>

        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">

            <!-- HEADER -->
            <header class="header animate-enter">

                <div class="header-title" 
                    style="display: flex; align-items: center; gap: 1rem; width: 100%;">

                    <!-- LEFT: Title -->
                    <div>
                        <h1>Your Room Results</h1>
                        <p>Acoustic analysis and optimization insights.</p>
                    </div>

                    <!-- RIGHT: Hamburger (forced to far right) -->
                    <button id="mobile-menu-btn" 
                            class="btn btn-secondary" 
                            style="padding: 0.5rem; display: none; margin-left: auto;"
                            aria-label="Toggle navigation" aria-expanded="false">
                        <img src="icons/bars.svg" style="width: 24px;" alt="">
                    </button>

                </div>

                <!-- Buttons Row -->
                <div style="display: flex; gap: 1rem;">
                    <button id="runSweepBtn" class="btn btn-primary">
                        <img src="icons/sweep.svg" style="width: 18px; filter: brightness(100);" alt="">
                        Run Sweep
                    </button>
                    <button id="refreshDashboardBtn" class="btn btn-secondary" aria-label="Refresh Dashboard">
                        <img src="icons/refresh.svg" style="width: 16px;" alt="">
                    </button>
                </div>

            </header>



            <!-- TOP ROW: SCORE & ACTIONS -->
            <div class="grid-3 animate-enter delay-1">

                <!-- OVERALL SCORE CARD -->
                <div class="card glass-panel" style="grid-column: span 2; padding: 1.75rem; border-radius: 18px;"
     role="region"
     aria-labelledby="overallRoomScoreLabel"
     aria-label="">


                    <!-- Title -->
                    <h2 class="card-title"
                        style="display:flex; align-items:center; gap:0.5rem; margin-bottom:1rem; font-size:1rem; font-weight:normal;">
                        <img src="icons/chart-line.svg" style="width:16px; opacity:0.7;" alt="" aria-hidden="true">
                        <span id="overallRoomScoreLabel"
                            style="text-transform:uppercase; letter-spacing:0.5px;">Overall Room Score</span>
                    </h2>

                    <!-- SCORE LEFT + DAVE RIGHT -->
                    <div class="overall-score-row" style="
            display:flex;
            justify-content:space-between;
            align-items:flex-start;
            gap:2rem;
            flex-wrap:wrap;
          ">

                        <!-- SCORE -->
                        <div class="score-display" style="display:flex; align-items:flex-end;">
                            <span id="overallScore" class="score-value text-gradient-accent"
                                style="font-size:5.25rem; font-weight:700;" data-color-target="overall">--</span>
                            <span class="score-max"
                                style="opacity:0.5; font-size:1rem; margin-left:0.25rem; transform: translateY(-8px);">/
                                10</span>
                        </div>

                        <!-- DAVE SAYS -->
                        <div class="dave-box"
                            style="max-width:260px; text-align:left; display:flex; flex-direction:column;">

                            <!-- ICON + TITLE LEFT -->
                            <div class="dave-badge" style="margin-bottom:0.4rem; align-self:flex-start;">
                                <img src="icons/dave.svg" style="width:20px;" alt="" aria-hidden="true">
                                <span>DAVE SAYS</span>
                            </div>

                            <!-- PHRASE STARTS DIRECTLY UNDER THE ICON -->
                            <p id="overallBuddyPhrase" class="dave-quote"
                                style="margin:0; font-style:italic; font-size:0.95rem; line-height:1.45; color:var(--c-text-main);">
                                “Run a sweep to get started.”
                            </p>

                        </div>


                    </div>

                    <!-- VERDICT -->
                    <div style="
            margin-top:1.5rem;
            padding-top:1rem;
            border-top:1px solid rgba(255,255,255,0.06);
            display:flex;
            align-items:center;
            gap:0.75rem;
            font-size:0.95rem;
            color:var(--c-text-main);
          ">
                        <span id="overallStatus" class="status-indicator"
                            style="width:10px; height:10px; border-radius:50%; background:#6B7280;" aria-hidden="true"></span>

                        <span id="overallStatusText" style="font-weight:600;" aria-live="polite">
                            Verdict: --
                        </span>

                        <span style="opacity:0.4;">•</span>

                        <span style="opacity:0.6;">Based on 6 key acoustic metrics</span>
                    </div>

                </div>

                <!-- QUICK ACTIONS / INFO -->
                <!-- SESSION INFO -->
                <div class="card glass-panel" aria-hidden="true">
                    <h2 class="card-title" style="display: flex; align-items: center; gap: 0.5rem;">
                        <img src="icons/sessions.svg" style="width: 20px;" data-color-icon="peaksDips" alt="">
                        Session Info
                    </h2>

                    <div style="display: flex; flex-direction: column; gap: 1rem;">

                        <!-- LIVE LOGS HEADER -->
                        <div
                            style="display:flex; justify-content: space-between; align-items:center; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div style="display:flex; align-items:center; gap:0.5rem;">
                                <img src="icons/dave.svg" style="width:16px;">
                                <span style="color: var(--c-text-muted);">Live Logs</span>
                            </div>
                            <span style="font-weight:600; color:var(--c-text-main);">Active</span>
                        </div>

                        <!-- LOG AREA -->
                        <div id="sessionLog"
                            style="display:flex; flex-direction:column; gap:0.5rem; font-size:0.85rem; color:var(--c-text-muted); min-height:40px;">
                            <div>Logs will appear here once you run a sweep!</div>
                        </div>

                    </div>
                </div>
            </div>


            <!-- METRICS GRID -->
            <div class="grid-3 animate-enter delay-2">

                <!-- Peaks & Dips -->
                <div class="card glass-panel" role="region" aria-labelledby="peaksDipsLabel" aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="peaksDipsLabel" class="card-title" style="margin:0;">Peaks & Dips</h2>
                        <img src="icons/mountain.svg" style="width: 20px;" data-color-icon="peaksDips" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="peaksDipsScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="peaksDips">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Smoothness of bass
                        and lower
                        mids.</p>
                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">DAVE SAYS</span>
                    </div>
                    <span id="peaksDipsBuddy" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>
                    <!-- Hidden spans for JS compatibility -->
                    <span id="peaksDipsStatus" class="hidden"></span>
                    <span id="peaksDipsStatusText" class="hidden"></span>
                    <span id="peaksDipsRaw" class="hidden"></span>
                    <span id="peaksDipsSummary" class="hidden"></span>
                </div>

                <!-- Reflections -->
                <div class="card glass-panel" 
                     role="region" 
                     aria-labelledby="reflectionsLabel" 
                     aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="reflectionsLabel" class="card-title" style="margin:0;">Reflections</h2>
                        <img src="icons/square-caret-left.svg" style="width: 20px;" data-color-icon="reflections"
                            alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="reflectionsScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="reflections">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Early wall/floor
                        bounce
                        coloring sound.</p>
                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">DAVE SAYS</span>
                    </div>
                    <span id="reflectionsBuddy" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>
                    <span id="reflectionsStatus" class="hidden"></span>
                    <span id="reflectionsStatusText" class="hidden"></span>
                    <span id="reflectionsRaw" class="hidden"></span>
                </div>

                <!-- Bandwidth -->
                <div class="card glass-panel"
                     role="region"
                     aria-labelledby="bandwidthLabel"
                     aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="bandwidthLabel" class="card-title" style="margin:0;">Bandwidth</h2>
                        <img src="icons/signal.svg" style="width: 20px;" data-color-icon="bandwidth" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="bandwidthScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="bandwidth">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">How wide your
                        system plays
                        (Bass to Air).</p>
                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">DAVE SAYS</span>
                    </div>
                    <span id="bandwidthBuddy" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>
                    <span id="bandwidthStatus" class="hidden"></span>
                    <span id="bandwidthStatusText" class="hidden"></span>
                    <span id="bandwidthRaw" class="hidden"></span>
                    <span id="bandwidthSummary" class="hidden"></span>
                </div>

                <!-- Balance -->
                <div class="card glass-panel"
                     role="region"
                     aria-labelledby="balanceLabel"
                     aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="balanceLabel" class="card-title" style="margin:0;">Balance</h2>
                        <img src="icons/balance-scale.svg" style="width: 20px;" data-color-icon="balance" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="balanceScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="balance">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Tonal tilt (Warm vs
                        Bright).</p>
                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">DAVE SAYS</span>
                    </div>
                    <span id="balanceBuddy" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>
                    <span id="balanceStatus" class="hidden"></span>
                    <span id="balanceStatusText" class="hidden"></span>
                    <span id="balanceRaw" class="hidden"></span>
                </div>

                <!-- Smoothness -->
                <div class="card glass-panel"
                     role="region"
                     aria-labelledby="smoothnessLabel"
                     aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="smoothnessLabel" class="card-title" style="margin:0;">Smoothness</h2>
                        <img src="icons/wave-square.svg" style="width: 20px;" data-color-icon="smoothness" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="smoothnessScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="smoothness">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Fine-grain
                        consistency across
                        spectrum.</p>
                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">DAVE SAYS</span>
                    </div>
                    <span id="smoothnessBuddy" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>
                    <span id="smoothnessStatus" class="hidden"></span>
                    <span id="smoothnessStatusText" class="hidden"></span>
                    <span id="smoothnessRaw" class="hidden"></span>
                </div>

                <!-- Reverb -->
                <div class="card glass-panel"
                     role="region"
                     aria-labelledby="reverbLabel"
                     aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="reverbLabel" class="card-title" style="margin:0;">Reverb</h2>
                        <img src="icons/clock.svg" style="width: 20px;" data-color-icon="reverb" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="reverbScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="reverb">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">How long the room
                        holds onto
                        sound.</p>
                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">DAVE SAYS</span>
                    </div>
                    <span id="reverbBuddy" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>
                    <span id="reverbStatus" class="hidden"></span>
                    <span id="reverbStatusText" class="hidden"></span>
                    <span id="reverbRaw" class="hidden"></span>
                </div>

            </div>

            <!-- NERDS CORNER -->
            <div class="card glass-panel animate-enter delay-3" 
                 role="region" 
                 aria-labelledby="nerdsCornerLabel" 
                 aria-label="">
                 
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="background: rgba(255,255,255,0.05); padding: 0.5rem; border-radius: 8px;">
                            <img src="icons/dave.svg" style="width: 24px;" alt="">
                        </div>
                        <div>
                            <h2 id="nerdsCornerLabel" style="margin: 0; font-size: 1.25rem; font-weight: 700;">Nerds Corner</h2>
                            <p style="margin: 0; color: var(--c-text-muted); font-size: 0.9rem;">Deep dive analysis and raw curves.</p>
                        </div>
                    </div>

                    <div style="background: rgba(0,0,0,0.2); padding: 0.25rem; border-radius: 8px; display: flex; gap: 0.25rem;">
                        <button id="leftChannelBtn" data-channel="left" class="btn btn-secondary"
                                aria-pressed="false"
                                style="padding: 0.4rem 1rem; font-size: 0.85rem;">Left</button>

                        <button id="rightChannelBtn" data-channel="right" class="btn btn-secondary"
                                aria-pressed="false"
                                style="padding: 0.4rem 1rem; font-size: 0.85rem;">Right</button>

                        <button id="bothChannelsBtn" data-channel="both" class="btn btn-primary"
                                aria-pressed="true"
                                style="padding: 0.4rem 1rem; font-size: 0.85rem;">Both</button>
                    </div>
                </div>

                <div class="chart-container">
                    <div id="frequencyChart" 
                         class="chart-responsive" 
                         style="width: 100%; height: 400px;" 
                         role="img"
                         aria-live="polite"
                         aria-label=""
                         aria-describedby="frequencyChartDescription"></div>

                    <!-- Invisible text summary for screen readers -->
                    <p id="frequencyChartDescription" class="hidden" aria-hidden="true"></p>
                </div>

                <!-- Session History Buttons (Replaced with Sweep Navigation) -->
                <h3 class="card-title" style="display:flex; align-items:center; gap:0.5rem; margin-top:2rem;">
                    <img src="icons/dave.svg" style="width:18px; opacity:0.9;">
                    Sweeps
                </h3>

                <div id="sweepNav" style="display:flex; gap:0.5rem; margin-bottom:1.5rem;">
                    <button class="session-btn session-active" data-sweep="0">Sweep 1</button>
                    <button class="session-btn" data-sweep="1">Sweep 2</button>
                    <button class="session-btn" data-sweep="2">Sweep 3</button>
                    <button class="session-btn" data-sweep="3">Sweep 4</button>
                </div>

                <!-- Hidden metrics container for JS -->
                <div id="sessionMetrics" class="hidden">
                    <span id="sessOverallScore"></span><span id="sessOverallStatus"></span>
                    <span id="sessPeaksDips"></span><span id="sessReflections"></span>
                    <span id="sessBandwidth"></span><span id="sessBalance"></span>
                    <span id="sessSmoothness"></span><span id="sessReverb"></span>
                    <span id="sessBass"></span><span id="sessMid"></span>
                    <span id="sessTreble"></span><span id="sessAir"></span>

                    <!-- Extra band IDs -->
                    <span id="bassLevel"></span><span id="midLevel"></span>
                    <span id="trebleLevel"></span><span id="airLevel"></span>

                    <div id="bassBar"></div>
                    <div id="midBar"></div>
                    <div id="trebleBar"></div>
                    <div id="airBar"></div>
                </div>


                <!-- SWEEP HISTORY – BAKED IN -->
                <div class="card glass-panel animate-enter delay-4" style="margin-top: 2rem;">
                    <h2 style="margin-bottom: 1rem; display:flex; align-items:center; gap:0.5rem;">
                        <img src="icons/dave.svg" style="width:22px; opacity:0.9;">
                        Sweep History
                    </h2>

                    <p style="opacity: 0.7; margin-top: -0.5rem; margin-bottom: 1.5rem;">
                        Compare your last four sweeps at a glance
                    </p>

                    <div id="sweepHistoryGrid" class="grid-4-mobile grid-2 tablet-grid-4">
                        
                        <!-- SWEEP CARD TEMPLATE (four of these will be filled by JS) -->
                        <div class="card glass-panel sweep-card" data-index="0">
                            <h3 class="sweep-title">Sweep 1</h3>
                            <div class="sweep-score">--</div>
                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Reverb</span><span class="m-reverb">--</span></div>
                            </div>
                        </div>

                        <div class="card glass-panel sweep-card" data-index="1">
                            <h3 class="sweep-title">Sweep 2</h3>
                            <div class="sweep-score">--</div>
                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Reverb</span><span class="m-reverb">--</span></div>
                            </div>
                        </div>

                        <div class="card glass-panel sweep-card" data-index="2">
                            <h3 class="sweep-title">Sweep 3</h3>
                            <div class="sweep-score">--</div>
                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Reverb</span><span class="m-reverb">--</span></div>
                            </div>
                        </div>

                        <div class="card glass-panel sweep-card" data-index="3">
                            <h3 class="sweep-title">Sweep 4</h3>
                            <div class="sweep-score">--</div>
                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Reverb</span><span class="m-reverb">--</span></div>
                            </div>
                        </div>

                    </div>
                </div>


        </main>
    </div>
    <script type="module">
    import { initSpeakers } from './js/speakers.js';
    window.initSpeakers = initSpeakers;
    initSpeakers();
    </script>

    <script src="js/dashboard.js"></script>

    <script>
        window.rawMetrics = {
            peaks_dips: {
                excellent: ["Spectral Deviation Index: 0.84 dB", "Modal Uniformity Factor: +1.2 dB", "Standing-Wave Suppression: -0.4 dB"],
                good: ["Spectral Deviation Index: 1.8 dB", "Boundary Coupling Error: +2.1 dB", "Modal Uniformity Factor: -1.3 dB"],
                okay: ["Modal Pressure Variance: +4.6 dB", "Low-Band Error Vector: 3.9 dB", "Cancellation Density Score: 2.7"],
                needs_work: ["Modal Instability Index: +8.4 dB", "Boundary Reflection Error: 7.1 dB", "Cancellation Severity: Critical (11.2 dB)"]
            },
            reflections: {
                excellent: ["Reflection Suppression Ratio: 0.6"],
                good: ["Early Bounce Coherence: 1.2"],
                okay: ["Multi-Surface Echo Factor: 2.8"],
                needs_work: ["Hard-Reflective Zone Index: 6.1"]
            },
            bandwidth: {
                excellent: ["Bandwidth Index: 92% usable"],
                good: ["Range Efficiency: 78%"],
                okay: ["Range Compression: 51%"],
                needs_work: ["Severe Band-Loss Detected"]
            },
            balance: {
                excellent: ["Tilt Variance: ±0.4 dB"],
                good: ["Tilt Offset: 1.1 dB"],
                okay: ["Tilt Asymmetry: 3.2 dB"],
                needs_work: ["Extreme Bass/Mid Imbalance"]
            },
            smoothness: {
                excellent: ["Micro-Deviation Index: 0.7 dB"],
                good: ["Micro-Deviation Index: 1.5 dB"],
                okay: ["Micro-Deviation Index: 3.4 dB"],
                needs_work: ["Severe Fine-Grain Variance: 6.2 dB"]
            },
            reverb: {
                excellent: ["Decay Uniformity Score: 0.14s"],
                good: ["Decay Uniformity Score: 0.23s"],
                okay: ["Decay Spread: 0.41s"],
                needs_work: ["Decay Instability: 0.78s"]
            }
        };

        document.getElementById("refreshDashboardBtn").addEventListener("click", async () => {
            console.log("Refreshing dashboard…");

            if (!window.dashboard) {
                console.error("Dashboard not initialised");
                return;
            }

            try {
                // 1. Load new sweep/session data
                await window.dashboard.loadData();

                // 2. Fully redraw dashboard UI
                window.dashboard.updateDashboard();

                updateAllMetricAria();

                // 3. Update nerd metrics
                window.dashboard.updateCompareSessionMetrics();

                // 4. Reset chart to both channels
                window.dashboard.showChannel('both');

                // 5. Optional toast
                window.dashboard.showSuccess("Dashboard refreshed");

            } catch (err) {
                console.error("Refresh failed:", err);
                window.dashboard.showError("Refresh failed");
            }
        });


        function formatTimestamp(isoString) {
            if (!isoString) return "No Data";
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch { return isoString; }
        }

        function getScoreStatus(score) {
            if (score >= 8) return 'Excellent';
            if (score >= 6) return 'Good';
            if (score >= 4) return 'Okay';
            return 'Needs work';
        }

        async function loadNewSession(sessionId) {
            if (!sessionId) { console.error("No session ID provided."); return; }
            const res = await fetch(`/api/session/${sessionId}/load`, { method: 'POST' });
            if (res.ok) location.reload();
            else console.error(`Failed to load session ${sessionId}`);
        }

        // Sweep Navigation — connects Sweep 1–4 buttons to sessionHistory[]
        document.querySelectorAll('#sweepNav .session-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const index = parseInt(btn.dataset.sweep, 10);
                console.log("Sweep clicked:", index);

                // highlight active button
                document.querySelectorAll('#sweepNav .session-btn')
                    .forEach(b => b.classList.remove('session-active'));
                btn.classList.add('session-active');

                // fetch session list
                const listRes = await fetch('/api/sessions/all');
                const list = await listRes.json();
                console.log("Session list:", list);

                if (!list[index]) {
                    console.error("No session at this index");
                    return;
                }

                const sessionId = list[index].id || list[index];
                console.log("Loading session:", sessionId);

                // fetch sweep data
                const sweepRes = await fetch(`/api/session/${sessionId}`);
                const sweepData = await sweepRes.json();
                console.log("Sweep data:", sweepData);

                // ⭐ update the data the dashboard uses ⭐
                window.dashboard.currentData = sweepData;
                window.dashboard.data = sweepData;
                window.dashboard.latestData = sweepData;

                // ⭐ REDRAW THE WHOLE DASHBOARD ⭐
                window.dashboard.updateDashboard();

                // ⭐ RESTORE ACTIVE CHANNEL (left/right/both) ⭐
                const active = document.querySelector(".channel-active")?.dataset.channel || "both";
                window.dashboard.showChannel(active);
            });
        });

        
        
        async function loadSessionMetrics(sessionId) {
            try {
                const res = await fetch(`/api/session/${sessionId}`);
                if (!res.ok) throw new Error(`Failed to load session data for ${sessionId}`);
                const data = await res.json();
                const metricsContainer = document.getElementById('sessionMetrics');

                if (!data.has_analysis) {
                    metricsContainer.innerHTML = '<p class="text-sm text-gray-500">Analysis not run for this sweep.</p>';
                    return;
                }

                function safeNumber(v) {
                    if (v === null || v === undefined) return null;
                    if (Array.isArray(v) && v.length > 0) { const n = Number(v[0]); return isNaN(n) ? null : n; }
                    const n = Number(v); return isNaN(n) ? null : n;
                }

                const overallEl = document.getElementById('sessOverallScore');
                const overallStatusEl = document.getElementById('sessOverallStatus');
                if (data.overall_score != null) {
                    overallEl.textContent = data.overall_score.toFixed(1);
                    overallStatusEl.textContent = getScoreStatus(data.overall_score);
                    applyDynamicColor(overallEl, data.overall_score);
                    applyDynamicColor(overallStatusEl, data.overall_score);
                } else {
                    overallEl.textContent = '--';
                    overallStatusEl.textContent = '--';
                }

                const updateMetric = (id, value) => {
                    const el = document.getElementById(id);
                    if (value != null) {
                        el.textContent = value.toFixed(1);
                        applyDynamicColor(el, value);
                    } else el.textContent = '--';
                };

                updateMetric('sessPeaksDips', data.peaks_dips);
                updateMetric('sessReflections', data.reflections);
                updateMetric('sessBandwidth', data.bandwidth);
                updateMetric('sessBalance', data.balance);
                updateMetric('sessSmoothness', data.smoothness);
                updateMetric('sessReverb', data.reverb);

                const bands = data.band_levels_db || {};
                const sessBass = safeNumber(bands.bass ?? bands.bass_20_200);
                const sessMid = safeNumber(bands.mid ?? bands.mid_200_2k);
                const sessTreble = safeNumber(bands.treble ?? bands.treble_2k_10k);
                const sessAir = safeNumber(bands.air ?? bands.air_10k_20k);

                const updateBand = (id, value) => {
                    const el = document.getElementById(id);
                    if (value !== null) {
                        el.textContent = `${value.toFixed(1)} dB`;
                        if (window.dashboard) dashboard.applySixCardColor(id, value);
                    } else el.textContent = '-- dB';
                };

                updateBand('sessBass', sessBass);
                updateBand('sessMid', sessMid);
                updateBand('sessTreble', sessTreble);
                updateBand('sessAir', sessAir);

                const bassLevel = document.getElementById('bassLevel');
                const midLevel = document.getElementById('midLevel');
                const trebleLevel = document.getElementById('trebleLevel');
                const airLevel = document.getElementById('airLevel');
                const bassBar = document.getElementById('bassBar');
                const midBar = document.getElementById('midBar');
                const trebleBar = document.getElementById('trebleBar');
                const airBar = document.getElementById('airBar');

                bassLevel.textContent = sessBass !== null ? `${sessBass.toFixed(1)} dB` : '-- dB';
                midLevel.textContent = sessMid !== null ? `${sessMid.toFixed(1)} dB` : '-- dB';
                trebleLevel.textContent = sessTreble !== null ? `${sessTreble.toFixed(1)} dB` : '-- dB';
                airLevel.textContent = sessAir !== null ? `${sessAir.toFixed(1)} dB` : '-- dB';

                const barWidth = v => v !== null ? `${(v + 12) * 4}%` : '0%';
                bassBar.style.width = barWidth(sessBass);
                midBar.style.width = barWidth(sessMid);
                trebleBar.style.width = barWidth(sessTreble);
                airBar.style.width = barWidth(sessAir);

                applyMainBand(bassLevel, bassBar, sessBass);
                applyMainBand(midLevel, midBar, sessMid);
                applyMainBand(trebleLevel, trebleBar, sessTreble);
                applyMainBand(airLevel, airBar, sessAir);

            } catch (error) {
                console.error("Error loading session metrics:", error);
                document.getElementById('sessionMetrics').innerHTML = '<p class="text-sm text-red-500">Failed to load detailed metrics.</p>';
            }
        }


        let firstDrawDone = false;
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof MeasurelyDashboard !== 'undefined') window.dashboard = new MeasurelyDashboard();
            //loadSessionExplorer();
            const draw = () => {
                if (firstDrawDone) return;
                const box = document.getElementById('frequencyChart');
                if (!box || box.clientHeight === 0) { requestAnimationFrame(draw); return; }
                firstDrawDone = true;
                if (window.dashboard) window.dashboard.showChannel('both');
            };
            requestAnimationFrame(draw);
        });

        const btn = document.getElementById('mobile-menu-btn');
        const side = document.getElementById('sidebar');
        const over = document.getElementById('sidebar-overlay');
        function toggleMenu() {
            side.classList.toggle("active");
            over.classList.toggle("active");
            document.body.style.overflow = side.classList.contains("active") ? "hidden" : "";
        }
        if (btn) btn.addEventListener('click', toggleMenu);
        if (over) over.addEventListener('click', toggleMenu);

        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    side.classList.remove('active');
                    over.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        });

        setInterval(() => {
            const el = document.getElementById('lastUpdated');
            if (el) el.textContent = new Date().toLocaleTimeString();
        }, 1000);
    </script>
</body>

</html>