<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Measurely ‚Äì Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="icons/dave.svg">
    <link rel="stylesheet" href="measurely.css">

    <script src="js/plotly.min.js"></script>
</head>

<body>

    <div class="app-layout">

        <!-- MOBILE OVERLAY -->
        <div id="sidebar-overlay" aria-hidden="true"
            style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(4px);">
        </div>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="sidebar" aria-label="Primary Navigation">
            <div class="sidebar-logo">
                <img src="icons/mainlogo.svg" alt="" aria-hidden="true" style="height: 46px;">
                <span></span>
            </div>

            <nav aria-label="Main">
                <a href="index.html" class="nav-item active">
                    <img src="icons/dashboard.svg" alt="" aria-hidden="true">
                    Dashboard
                </a>
                <a href="room-setup.html" class="nav-item">
                    <img src="icons/home.svg" alt="" aria-hidden="true">
                    Room Setup
                </a>
            </nav>

            <div style="margin-top: auto;" aria-hidden="true">
                <div class="glass-panel"
                    style="padding: 1rem; border-radius: 12px; display: flex; flex-direction: column; gap: 0.75rem;">

                    <!-- SYSTEM READY -->
                    <div
                        style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--c-text-muted);">
                        <div id="systemReadyDot" class="status-indicator"
                            style="width: 8px; height: 8px; border-radius: 50%; background: var(--c-excellent);">
                        </div>
                        <span id="systemReadyText">System Ready</span>
                    </div>

                    <!-- DAC STATUS -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div id="dacStatusDot" class="status-indicator"
                            style="width: 10px; height: 10px; border-radius: 50%;">
                        </div>
                        <span id="dacStatusText" style="font-size: 0.8rem; color: var(--c-text-muted);">--</span>
                    </div>

                    <!-- MIC STATUS -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div id="usbStatusDot" class="status-indicator"
                            style="width: 10px; height: 10px; border-radius: 50%;">
                        </div>
                        <span id="usbStatusText" style="font-size: 0.8rem; color: var(--c-text-muted);">--</span>
                    </div>

                    <!-- LAST UPDATED -->
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.3); margin-top: 0.5rem;">
                        Last updated: <span id="lastUpdated">Now</span>
                    </div>
                </div>
            </div>

        </aside>

        <div id="sidebar-toggle"
            aria-label="Toggle sidebar"
            title="Toggle sidebar">
        ‚Äπ
        </div>

        <!-- MAIN CONTENT -->
        <main class="main-content">

            <!-- HEADER -->
            <header class="header animate-enter">

                <div class="header-title" 
                    style="display: flex; align-items: center; gap: 1rem; width: 100%;">

                    <!-- LEFT: Title -->
                    <div>
                        <h1>Your Room Results</h1>
                        <p>Acoustic analysis and optimization insights.</p>
                    </div>

                    <!-- RIGHT: Hamburger (forced to far right) -->
                    <button id="mobile-menu-btn" 
                            class="btn btn-secondary" 
                            style="padding: 0.5rem; display: none; margin-left: auto;"
                            aria-label="Toggle navigation" aria-expanded="false">
                        <img src="icons/bars.svg" style="width: 24px;" alt="">
                    </button>

                </div>

                <!-- Buttons Row -->
                <div class="header-actions">

                    <button id="runSweepBtn" class="btn btn-primary">
                        <img src="icons/sweep.svg" style="width: 16px; filter: brightness(100);" alt="">
                        Run Sweep
                    </button>

                    <button id="refreshDashboardBtn" class="btn btn-secondary" aria-label="Refresh Dashboard">
                        <img src="icons/refresh.svg" style="width: 16px;" alt="">
                    </button>

                    <!-- NEW: Cancel Sweep button (hidden until sweeping) -->
                    <button id="cancelSweepBtn" class="btn btn-poor hidden" aria-label="Cancel Sweep">
                        <img src="icons/save.svg" style="width: 16px;" alt="">
                        Cancel Sweep
                    </button>
                </div>


            </header>



            <!-- TOP ROW: SCORE & ACTIONS -->
            <div class="grid-3 animate-enter delay-1">

                <!-- OVERALL SCORE CARD -->
                <div class="card glass-panel"
                    style="grid-column: span 2; padding: 2rem; border-radius: 18px;"
                    role="region"
                    aria-labelledby="overallRoomScoreLabel">

                    <!-- Title -->
                    <h2 id="overallRoomScoreLabel"
                        class="card-title"
                        style="display:flex; align-items:center; gap:0.5rem;
                            margin-bottom:1.25rem; font-size:0.95rem; font-weight:500;
                            text-transform:uppercase; letter-spacing:0.5px; opacity:0.85;">
                        <img src="icons/chart-line.svg" style="width:16px; opacity:0.7;" alt="" aria-hidden="true">
                        Overall Room Score (latest)
                    </h2>

                    <!-- SCORE -->
                    <div class="score-display"
                        style="display:flex; align-items:flex-end; margin-bottom:1.5rem;">
                        <span id="overallScore"
                            class="score-value text-gradient-accent"
                            style="font-size:5.5rem; font-weight:700;"
                            data-color-target="overall">--</span>
                        <span class="score-max"
                            style="opacity:0.5; font-size:1rem; margin-left:0.35rem; transform: translateY(-10px);">
                            /10
                        </span>
                    </div>

                    <!-- SUMMARY -->
                    <p id="overallDavePhrase"
                    class="dave-quote"
                    style="margin:0;
                            max-width: 720px;
                            font-style: italic;
                            font-size: 1rem;
                            line-height: 1.55;
                            color: var(--c-text-main);">
                        ‚ÄúRun a sweep to get started.‚Äù
                    </p>

                    <!-- FOOTER -->
                    <div style="
                        margin-top:1.75rem;
                        padding-top:1rem;
                        border-top:1px solid rgba(255,255,255,0.06);
                        display:flex;
                        justify-content:space-between;
                        align-items:center;
                        gap:1rem;
                        font-size:0.85rem;
                        color:var(--c-text-muted);
                    ">
                        <span style="opacity:0.7;">Based on 6 key acoustic metrics</span>

                        <button id="downloadReportBtn"
                                class="btn btn-secondary"
                                aria-label="Download report">
                            <img src="icons/arrow-down.svg" style="width:14px;" alt="">
                            Download report
                        </button>
                    </div>

                </div>


                <!-- QUICK ACTIONS / INFO -->
                <!-- LIVE LOGS CARD -->
                <div class="card glass-panel" aria-hidden="true">

                    <!-- DAVE LOG BADGE -->
                    <div class="dave-badge"
                        style="display:inline-flex; align-items:center; gap:0.4rem;
                            background:rgba(99,102,241,0.15);
                            padding:0.35rem 0.65rem;
                            border-radius:8px;
                            width:fit-content;
                            font-size:0.78rem;
                            margin-bottom:0.75rem;">
                        <img src="icons/dave.svg" style="width:14px;" alt="">
                        Live Logs
                    </div>

                    <!-- LOG AREA -->
                    <div id="sessionLog"
                        style="display:flex; flex-direction:column; gap:0.5rem;
                            font-size:0.85rem; color:var(--c-text-muted);
                            min-height:40px; border-top:1px solid rgba(255,255,255,0.05);
                            padding-top:0.75rem;">
                        <div style="opacity:0.6;">Logs will appear here once you run a sweep!
                        </div>
                    </div>

                </div>

            </div>

            <!-- METRICS GRID -->
            <div class="grid-3 animate-enter delay-2">

                <!-- Peaks & Dips -->
                <div class="card glass-panel" role="region" aria-labelledby="peaksDipsLabel" aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="peaksDipsLabel" class="card-title" style="margin:0;">Peaks & Dips</h2>
                        <img src="icons/mountain.svg" style="width: 20px;" data-color-icon="peaksDips" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="peaksDipsScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="peaksDips">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Smoothness of bass
                        and lower
                        mids.</p>
                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">Report</span>
                    </div>
                    <span id="peaksDipsDave" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>
                    <!-- Hidden spans for JS compatibility -->
                    <span id="peaksDipsStatus" class="hidden"></span>
                    <span id="peaksDipsStatusText" class="hidden"></span>
                    <span id="peaksDipsRaw" class="hidden"></span>
                    <span id="peaksDipsSummary" class="hidden"></span>
                </div>

                <!-- Reflections -->
                <div class="card glass-panel" 
                     role="region" 
                     aria-labelledby="reflectionsLabel" 
                     aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="reflectionsLabel" class="card-title" style="margin:0;">Reflections</h2>
                        <img src="icons/square-caret-left.svg" style="width: 20px;" data-color-icon="reflections"
                            alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="reflectionsScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="reflections">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Early wall/floor
                        bounce
                        coloring sound.</p>
                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">Report</span>
                    </div>
                    <span id="reflectionsDave" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>
                    <span id="reflectionsStatus" class="hidden"></span>
                    <span id="reflectionsStatusText" class="hidden"></span>
                    <span id="reflectionsRaw" class="hidden"></span>
                </div>

                <!-- Bandwidth -->
                <div class="card glass-panel"
                     role="region"
                     aria-labelledby="bandwidthLabel"
                     aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="bandwidthLabel" class="card-title" style="margin:0;">Bandwidth</h2>
                        <img src="icons/signal.svg" style="width: 20px;" data-color-icon="bandwidth" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="bandwidthScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="bandwidth">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">How wide your
                        system plays
                        (Bass to Air).</p>
                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">Report</span>
                    </div>
                    <span id="bandwidthDave" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>
                    <span id="bandwidthStatus" class="hidden"></span>
                    <span id="bandwidthStatusText" class="hidden"></span>
                    <span id="bandwidthRaw" class="hidden"></span>
                    <span id="bandwidthSummary" class="hidden"></span>
                </div>

                <!-- Balance -->
                <div class="card glass-panel"
                     role="region"
                     aria-labelledby="balanceLabel"
                     aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="balanceLabel" class="card-title" style="margin:0;">Balance</h2>
                        <img src="icons/balance-scale.svg" style="width: 20px;" data-color-icon="balance" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="balanceScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="balance">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Tonal tilt (Warm vs
                        Bright).</p>
                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">Report</span>
                    </div>
                    <span id="balanceDave" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>
                    <span id="balanceStatus" class="hidden"></span>
                    <span id="balanceStatusText" class="hidden"></span>
                    <span id="balanceRaw" class="hidden"></span>
                </div>

                <!-- Smoothness -->
                <div class="card glass-panel"
                     role="region"
                     aria-labelledby="smoothnessLabel"
                     aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="smoothnessLabel" class="card-title" style="margin:0;">Smoothness</h2>
                        <img src="icons/wave-square.svg" style="width: 20px;" data-color-icon="smoothness" alt="">
                    </div>
                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="smoothnessScore" class="score-value" style="font-size: 2.5rem;"
                            data-color-target="smoothness">--</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Fine-grain
                        consistency across
                        spectrum.</p>
                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">Report</span>
                    </div>
                    <span id="smoothnessDave" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>
                    <span id="smoothnessStatus" class="hidden"></span>
                    <span id="smoothnessStatusText" class="hidden"></span>
                    <span id="smoothnessRaw" class="hidden"></span>
                </div>

                <!-- Clarity -->
                <div class="card glass-panel"
                    role="region"
                    aria-labelledby="clarityLabel"
                    aria-label="">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h2 id="clarityLabel" class="card-title" style="margin:0;">
                            Clarity
                        </h2>
                        <img src="icons/clock.svg" style="width: 20px;"
                            data-color-icon="clarity" alt="">
                    </div>

                    <div class="score-display" style="margin-bottom: 1rem;">
                        <span id="clarityScore"
                            class="score-value"
                            style="font-size: 2.5rem;"
                            data-color-target="clarity">--</span>
                    </div>

                    <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">
                        How clearly the direct sound reaches you before reflections interfere.
                    </p>

                    <div class="dave-badge" style="margin-bottom: 0.5rem; display: inline-flex;">
                        <img src="icons/dave.svg" style="width: 16px;" alt="">
                        <span style="font-size: 0.75rem;">Report</span>
                    </div>

                    <span id="clarityDave" class="dave-quote"
                        style="display: block; margin-top: 0; font-size: 0.85rem;">--</span>

                    <!-- Hidden spans for JS compatibility -->
                    <span id="clarityStatus" class="hidden"></span>
                    <span id="clarityStatusText" class="hidden"></span>
                    <span id="clarityRaw" class="hidden"></span>
                </div>


            </div>

            <!-- NERDS CORNER -->
            <div class="card glass-panel animate-enter delay-3" 
                role="region" 
                aria-labelledby="nerdsCornerLabel" 
                aria-label="">
                
                <!-- HEADER -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="background: rgba(255,255,255,0.05); padding: 0.5rem; border-radius: 8px;">
                            <img src="icons/dave.svg" style="width: 24px;" alt="">
                        </div>
                        <div>
                            <h2 id="nerdsCornerLabel" style="margin: 0; font-size: 1.25rem; font-weight: 700;">Nerds Corner</h2>
                            <p style="margin: 0; color: var(--c-text-muted); font-size: 0.9rem;">Deep dive analysis and raw curves.</p>
                        </div>
                    </div>
                </div>

                <!-- CHART -->
                <div class="chart-container">
                    <div id="frequencyChart" 
                        class="chart-responsive" 
                        style="width: 100%; height: 400px;" 
                        role="img"
                        aria-live="polite"
                        aria-label=""
                        aria-describedby="frequencyChartDescription"></div>

                    <p id="frequencyChartDescription" class="hidden" aria-hidden="true"></p>
                </div>

                <!-- SWEEP NAV -->
                <h3 class="card-title" style="display:flex; align-items:center; gap:0.5rem; margin-top:2rem;">
                    <img src="icons/dave.svg" style="width:18px; opacity:0.9;">
                    Sweeps
                </h3>

                <div id="sweepNav" style="display:flex; gap:0.5rem; margin-bottom:1.5rem;">
                    <button class="session-btn session-active" data-sweep="0">Latest</button>
                    <button class="session-btn" data-sweep="1">Previous</button>
                    <button class="session-btn" data-sweep="2">Earlier</button>
                    <button class="session-btn" data-sweep="3">Oldest</button>
                </div>


                <!-- SWEEP HISTORY -->
                <section class="sweep-history-wrapper">

                    <!-- SECTION HEADER -->
                    <h2 style="margin-bottom: 1rem; display:flex; align-items:center; gap:0.5rem;">
                        <img src="icons/dave.svg" style="width:22px; opacity:0.9;">
                        Sweep History
                    </h2>

                    <p style="opacity:0.7; margin-top:-0.5rem; margin-bottom:1.25rem;">
                        Compare your last four sweeps at a glance
                    </p>

                    <!-- AI SWEEP COMPARISON (FULL WIDTH, ABOVE GRID) -->
                    <div id="aiSweepCompareCard" class="ai-compare-card" hidden>

                        <div class="ai-compare-header">
                            <img src="icons/dave.svg" style="width:20px; opacity:0.9;">
                            <h3>Sweep-to-sweep comparison</h3>
                        </div>

                        <p class="ai-compare-text" id="aiSweepCompareText">
                            <!-- AI comparison text injected here -->
                        </p>

                        <div class="ai-compare-meta" id="aiSweepCompareMeta">
                            <!-- e.g. Sweep24 ‚Üí Sweep23 ¬∑ Same room, same system -->
                        </div>

                    </div>


                    <!-- SWEEP GRID -->
                    <div id="sweepHistoryGrid" class="grid-4-mobile grid-2 tablet-grid-4">

                        <!-- SWEEP 1 -->
                        <div class="sweep-card sweep-item" data-index="0">
                            <h3 class="sweep-title">Latest</h3>
                            <div class="sweep-time" style="opacity:0.6;font-size:0.75rem;">‚Äî</div>
                            <div class="sweep-score">--</div>

                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>

                            <div class="sweep-footer">
                                <button class="notes-btn" data-sweep-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this sweep</span>
                                </div>
                            </div>
                        </div>

                        <!-- SWEEP 2 -->
                        <div class="sweep-card sweep-item" data-index="1">
                            <h3 class="sweep-title">Previous</h3>
                            <div class="sweep-time" style="opacity:0.6;font-size:0.75rem;">‚Äî</div>
                            <div class="sweep-score">--</div>

                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>

                            <div class="sweep-footer">
                                <button class="notes-btn" data-sweep-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this sweep</span>
                                </div>
                            </div>
                        </div>

                        <!-- SWEEP 3 -->
                        <div class="sweep-card sweep-item" data-index="2">
                            <h3 class="sweep-title">Earlier</h3>
                            <div class="sweep-time" style="opacity:0.6;font-size:0.75rem;">‚Äî</div>
                            <div class="sweep-score">--</div>

                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>

                            <div class="sweep-footer">
                                <button class="notes-btn" data-sweep-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this sweep</span>
                                </div>
                            </div>
                        </div>

                        <!-- SWEEP 4 -->
                        <div class="sweep-card sweep-item" data-index="3">
                            <h3 class="sweep-title">Oldest</h3>
                            <div class="sweep-time" style="opacity:0.6;font-size:0.75rem;">‚Äî</div>
                            <div class="sweep-score">--</div>

                            <div class="sweep-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>

                            <div class="sweep-footer">
                                <button class="notes-btn" data-sweep-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this sweep</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </section>

            </div>

        </main>
    </div>
    <script type="module">
    import { initSpeakers } from './js/speakers.js';
    window.initSpeakers = initSpeakers;
    initSpeakers();
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.getElementById('sidebar');
        const main = document.querySelector('.main-content');
        const toggle = document.getElementById('sidebar-toggle');
        const chart = document.getElementById('frequencyChart');

        if (!sidebar || !main || !toggle) {
            console.warn('Sidebar toggle: missing element(s)', { sidebar, main, toggle });
            return;
        }

        const applyState = (isCollapsed) => {
            sidebar.classList.toggle('collapsed', isCollapsed);
            main.classList.toggle('sidebar-collapsed', isCollapsed);
            toggle.classList.toggle('collapsed', isCollapsed);
            toggle.textContent = isCollapsed ? '‚Ä∫' : '‚Äπ';
            localStorage.setItem('measurelySidebarCollapsed', String(isCollapsed));

            // Resize Plotly after layout settles
            setTimeout(() => {
                if (window.Plotly && chart) Plotly.Plots.resize(chart);
            }, 300);
        };

        // Restore saved state (desktop only)
        if (window.innerWidth >= 1025) {
            const collapsed = localStorage.getItem('measurelySidebarCollapsed') === 'true';
            applyState(collapsed);
        }

        toggle.addEventListener('click', () => {
            if (window.innerWidth < 1025) return; // desktop only
            const isCollapsed = !sidebar.classList.contains('collapsed');
            applyState(isCollapsed);
        });
    });
    </script>


    <script src="js/dashboard.js"></script>

    <script>


        document.getElementById("refreshDashboardBtn").addEventListener("click", async () => {
            console.log("Refreshing dashboard‚Ä¶");

            if (!window.dashboard) {
                console.error("Dashboard not initialised");
                return;
            }

            try {
                // 1. Load new sweep/session data
                await window.dashboard.loadData();

                // 2. Fully redraw dashboard UI
                window.dashboard.updateDashboard();

                updateAllMetricAria();

                // 3. Update nerd metrics
                window.dashboard.updateCompareSessionMetrics();

                // 4. Reset chart to both channels
                window.dashboard.showChannel('both');

                // 5. Optional toast
                window.dashboard.showSuccess("Dashboard refreshed");

            } catch (err) {
                console.error("Refresh failed:", err);
                window.dashboard.showError("Refresh failed");
            }
        });


        function formatTimestamp(isoString) {
            if (!isoString) return "No Data";
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch { return isoString; }
        }


        // Fully replace SweepNav click logic
        document.querySelectorAll("#sweepNav .session-btn").forEach((btn, index) => {
            btn.addEventListener("click", () => {
                console.log(`üëâ SweepNav clicked - index ${index}`);
                // Use the correct function in dashboard.js
                window.dashboard.loadNthSession(index);
            });
        });
       
        

        let firstDrawDone = false;
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof MeasurelyDashboard !== 'undefined') window.dashboard = new MeasurelyDashboard();
            //loadSessionExplorer();
            const draw = () => {
                if (firstDrawDone) return;
                const box = document.getElementById('frequencyChart');
                if (!box || box.clientHeight === 0) { requestAnimationFrame(draw); return; }
                firstDrawDone = true;
                if (window.dashboard) window.dashboard.showChannel('both');
            };
            requestAnimationFrame(draw);
        });

        const btn = document.getElementById('mobile-menu-btn');
        const side = document.getElementById('sidebar');
        const over = document.getElementById('sidebar-overlay');
        function toggleMenu() {
            side.classList.toggle("active");
            over.classList.toggle("active");
            document.body.style.overflow = side.classList.contains("active") ? "hidden" : "";
        }
        if (btn) btn.addEventListener('click', toggleMenu);
        if (over) over.addEventListener('click', toggleMenu);

        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    side.classList.remove('active');
                    over.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        });

        setInterval(() => {
            const el = document.getElementById('lastUpdated');
            if (el) el.textContent = new Date().toLocaleTimeString();
        }, 1000);
    </script>

<!-- NOTES MODAL (GLOBAL POPUP) -->
<div id="notesModal" class="notes-modal hidden" aria-hidden="true">
    <div class="notes-modal-backdrop"></div>

    <div class="notes-modal-content">
        <div class="notes-modal-header">
            <h3 id="notesModalTitle">Sweep Notes</h3>
            <button class="notes-modal-close" aria-label="Close notes">&times;</button>
        </div>

        <div class="notes-modal-body">
            <textarea id="notesTextarea" 
                      class="notes-textarea" 
                      placeholder="Write your notes here‚Ä¶"></textarea>
        </div>

        <div class="notes-modal-footer">
            <button id="saveNotesBtn" class="btn btn-primary">Save</button>
        </div>
    </div>
</div>

<script>
// ========================
// NOTES MODAL LOGIC
// ========================

let currentSweepIndex = null;

// OPEN modal
function openNotesModal(index) {
    currentSweepIndex = index;

    const modal = document.getElementById("notesModal");
    const textarea = document.getElementById("notesTextarea");

    // Load previous notes
    textarea.value = localStorage.getItem(`sweepNote_${index}`) || "";

    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden", "false");
}

// CLOSE modal
function closeNotesModal() {
    const modal = document.getElementById("notesModal");
    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden", "true");
}

// OPEN BUTTONS (Notes buttons on each sweep card)
document.querySelectorAll("[data-sweep-note]").forEach((btn, i) => {
    btn.addEventListener("click", () => openNotesModal(i));
});

// SAVE button
document.getElementById("saveNotesBtn").addEventListener("click", () => {
    const textarea = document.getElementById("notesTextarea");

    // Save to localStorage
    localStorage.setItem(`sweepNote_${currentSweepIndex}`, textarea.value);

    // Update preview text in the card
    const preview = document.querySelector(
        `.sweep-card[data-index="${currentSweepIndex}"] [data-note-preview]`
    );
    preview.textContent = textarea.value || "‚Äî";

    closeNotesModal();
});

// CLOSE button (the X)
document.querySelector(".notes-modal-close")
    .addEventListener("click", closeNotesModal);

// Backdrop click closes the modal
document.querySelector(".notes-modal-backdrop")
    .addEventListener("click", closeNotesModal);
</script>

</body>

</html>