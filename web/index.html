<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Measurely ‚Äì Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="icons/dave.svg">
    <link rel="stylesheet" href="css/dashboard/index.css">

    <script src="js/plotly.min.js"></script>

    <script src="js/vendor/three/three.min.js"></script>
    <script src="js/vendor/three/OrbitControls.js"></script>

    <!-- PWA / App-like behaviour -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Measurely">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0b1220">


</head>

<body>

    <div class="page">

        <!-- MOBILE OVERLAY -->
        <div id="sidebar-overlay" aria-hidden="true"
            style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(4px);">
        </div>


        <!-- MAIN CONTENT -->
        <main class="main-content">

            <!-- HEADER -->
            <header class="header">
                <div class="header-title">
                    <h1>
                        <img
                            src="icons/largedave.svg"
                            alt=""
                            class="measurely-mark"
                            aria-hidden="true"
                        />
                        Dashboard
                    </h1>
                    <p>What your room is doing to the sound, measured, not guessed.</p>
                </div>
            </header>

            <!-- TOP ROW: SCORE & ACTIONS -->
            <div class="grid-3 animate-enter delay-1">


            <!-- MEASUREMENT ENGINE -->
            <div class="card glass-panel engine-bay engine-compact">

                <!-- HEADER -->
                <div class="engine-header">
                    <div class="engine-meta">
                        <h3 class="card-title">Measurement Engine</h3>
                        <div class="engine-subtitle">
                        </div>
                    </div>
                </div>

                <!-- PRIMARY ACTION -->
                <div class="engine-actions">
                    <button id="runSweepBtn" class="btn btn-primary engine-action is-cta">
                        <img src="icons/arrow-down.svg" alt="">
                        <div class="engine-action-text">
                            <strong>Run Sweep</strong>
                            <span>Measure your room now</span>
                        </div>
                    </button>
                </div>

                <!-- DIVIDER -->
                <div class="engine-divider"></div>

                <!-- CONFIG -->
                <div class="engine-actions">
                <a id="editRoomBtn"
                    class="btn btn-secondary engine-action"
                    href="myroom.html">
                    <img src="icons/home.svg" alt="">
                    <div class="engine-action-text">
                    <strong>Edit My Room</strong>
                    <span>Dimensions, layout & furnishings</span>
                    </div>
                </a>
                </div>

                <!-- DIVIDER -->
                <div class="engine-divider"></div>

                <!-- DEVICE STATUS (MOVED FROM SIDEBAR) -->
                <div class="engine-status">

                    <div class="engine-status-row">
                        <div id="systemReadyDot"
                            class="status-indicator"
                            style="width:8px;height:8px;border-radius:50%;background:var(--c-excellent);">
                        </div>
                        <span id="systemReadyText">System Ready</span>
                    </div>

                    <div class="engine-status-row">
                        <div id="dacStatusDot"
                            class="status-indicator"
                            style="width:10px;height:10px;border-radius:50%;">
                        </div>
                        <span id="dacStatusText">‚Äî</span>
                    </div>

                    <div class="engine-status-row">
                        <div id="usbStatusDot"
                            class="status-indicator"
                            style="width:10px;height:10px;border-radius:50%;">
                        </div>
                        <span id="usbStatusText">‚Äî</span>
                    </div>

                    <div class="engine-status-footer">
                        Last updated: <span id="lastUpdated">Now</span>
                    </div>

                </div>

                <!-- DIVIDER -->
                <div class="engine-divider"></div>

                <!-- FOOTER -->
                <div class="engine-footer">

                    <div class="engine-footer-actions">
                        <button id="viewHistoryBtn" class="btn btn-utility">
                            View sweep history
                        </button>
                    </div>
                </div>

            </div>


                    <div class="card glass-panel overall-score-card"
                        role="region"
                        aria-labelledby="overallRoomScoreLabel">

                        <h2 id="overallRoomScoreLabel" class="card-title overall-score-header">
                            <img src="icons/chart-line.svg" class="card-icon" alt="" aria-hidden="true">
                            Overall Room Score (latest)
                        </h2>


                        <div class="overall-score-value">
                        <span id="overallScore" class="overall-score-number">4.8</span>
                            <span class="overall-score-max">/10</span>
                        </div>
                        <div class="overall-score-bar">
                        <div class="overall-score-fill" style="width: 48%;"></div>
                        </div>
                        <p id="overallDavePhrase" class="dave-quote">
                            ‚ÄúUpload a .Wav to get started.‚Äù
                        </p>

                        <div class="overall-score-footer">

                            <div class="band-legend">
                                Tonal balance by frequency band
                            </div>

                            <div class="band-levels">
                                <div class="band-pill"><span>Bass</span><span id="bandBass">‚Äî dB</span></div>
                                <div class="band-pill"><span>Mid</span><span id="bandMid">‚Äî dB</span></div>
                                <div class="band-pill"><span>Treble</span><span id="bandTreble">‚Äî dB</span></div>
                                <div class="band-pill"><span>Air</span><span id="bandAir">‚Äî dB</span></div>
                            </div>

                        </div>
                    </div>

            </div>


            <section class="analysis-section animate-enter delay-2">
                <header class="section-header">
                    <h2 class="section-title">
                        <img src="icons/chart-line.svg" class="section-icon" alt="">
                        Room Analysis
                    </h2>
                    <p class="section-subtitle">Select a metric to investigate physical causes in your room.</p>
                </header>

                <div class="analysis-engine-container">
                    
                    <aside class="analysis-sidebar-menu">
                        
                        <button class="card glass-panel analysis-card-trigger"
                                data-overlay="sbir">

                            <div class="card-header">
                                <h2 class="card-title">Peaks & Dips</h2>
                                <img src="icons/mountain.svg" class="card-icon" alt="">
                            </div>

                            <div class="score-readout">
                                <span id="peaksDipsScore" class="score-value">--</span>
                                <span class="score-unit">RTX Index</span>
                            </div>

                            <div class="perf-track">
                                <div id="peaksDipsTrack" class="perf-fill"></div>
                            </div>

                            <div id="peaksDipsDave" class="dave-quote-mini">--</div>

                        </button>

                        <button class="card glass-panel analysis-card-trigger" data-overlay="side_reflections">
                            <div class="card-header">
                                <h2 class="card-title">Reflections</h2>
                                <img src="icons/square-caret-left.svg" class="card-icon" alt="">
                            </div>
                            <div class="score-readout">
                                <span id="reflectionsScore" class="score-value">--</span>
                                <span class="score-unit">ms Delay</span>
                            </div>
                            <div class="perf-track">
                                <div id="reflectionsTrack" class="perf-fill"></div>
                            </div>
                            <div id="reflectionsDave" class="dave-quote-mini">--</div>
                        </button>

                        <button class="card glass-panel analysis-card-trigger" data-overlay="bandwidth">
                            <div class="card-header">
                                <h2 class="card-title">Bandwidth</h2>
                                <img src="icons/signal.svg" class="card-icon" alt="">
                            </div>
                            <div class="score-readout">
                                <span id="bandwidthScore" class="score-value">--</span>
                                <span class="score-unit">Hz Range</span>
                            </div>
                            <div class="perf-track">
                                <div id="bandwidthTrack" class="perf-fill"></div>
                            </div>
                            <div id="bandwidthDave" class="dave-quote-mini">--</div>
                        </button>

                        <button class="card glass-panel analysis-card-trigger" data-overlay="balance">
                            <div class="card-header">
                                <h2 class="card-title">Balance</h2>
                                <img src="icons/balance-scale.svg" class="card-icon" alt="">
                            </div>
                            <div class="score-readout">
                                <span id="balanceScore" class="score-value">--</span>
                                <span class="score-unit">Tilt Slope</span>
                            </div>
                            <div class="perf-track">
                                <div id="balanceTrack" class="perf-fill"></div>
                            </div>
                            <div id="balanceDave" class="dave-quote-mini">--</div>
                        </button>

                        <button class="card glass-panel analysis-card-trigger" data-overlay="smoothness">
                            <div class="card-header">
                                <h2 class="card-title">Smoothness</h2>
                                <img src="icons/wave-square.svg" class="card-icon" alt="">
                            </div>
                            <div class="score-readout">
                                <span id="smoothnessScore" class="score-value">--</span>
                                <span class="score-unit">¬± dB Dev</span>
                            </div>
                            <div class="perf-track">
                                <div id="smoothnessTrack" class="perf-fill"></div>
                            </div>
                            <div id="smoothnessDave" class="dave-quote-mini">--</div>
                        </button>

                        <button class="card glass-panel analysis-card-trigger" data-overlay="clarity">
                            <div class="card-header">
                                <h2 class="card-title">Clarity</h2>
                                <img src="icons/clock.svg" class="card-icon" alt="">
                            </div>
                            <div class="score-readout">
                                <span id="clarityScore" class="score-value">--</span>
                                <span class="score-unit">C50 Value</span>
                            </div>
                            <div class="perf-track">
                                <div id="clarityTrack" class="perf-fill"></div>
                            </div>
                            <div id="clarityDave" class="dave-quote-mini">--</div>
                        </button>

                    </aside>

                    <div class="card glass-panel room-diagram-card">
                        <div id="roomInsightText" class="room-insight-text"></div>
                        <div id="dashboardRoomCanvas" class="room-diagram-canvas"></div>
                    </div>

                    </div>
                    </section>


            <!-- NERDS CORNER -->
            <div class="card glass-panel animate-enter delay-3"
                role="region"
                aria-labelledby="nerdsCornerLabel">

                <!-- HEADER -->
                <h2 id="nerdsCornerLabel" class="card-title">
                    Nerds Corner
                </h2>

                <p class="card-description">
                    Deep dive analysis and raw curves.
                </p>

                <!-- uploads NAV (DO NOT MOVE / DO NOT RENAME) -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">

                    <div id="uploadsNav" class="uploads-nav">
                        <button class="btn btn-utility session-btn session-active" data-uploads="0">Latest</button>
                        <button class="btn btn-utility session-btn" data-uploads="1">Previous</button>
                        <button class="btn btn-utility session-btn" data-uploads="2">Earlier</button>
                        <button class="btn btn-utility session-btn" data-uploads="3">Oldest</button>
                    </div>
                </div>

                <!-- CHART -->
                <div class="chart-container">
                    <div id="frequencyChart"
                        class="chart-responsive"
                        style="width: 100%; height: 320px;"
                        role="img"
                        aria-live="polite"
                        aria-describedby="frequencyChartDescription">
                    </div>

                    <p id="frequencyChartDescription"
                    class="hidden"
                    aria-hidden="true"></p>
                </div>

                <!-- uploads HISTORY -->
                <section class="uploads-history-wrapper">

                    <!-- SECTION HEADER -->
                    <h2 class="card-title" style="margin-bottom:0.75rem;">
                        Sweep History
                    </h2>

                    <p class="card-description">
                        Compare your last four sweep at a glance
                    </p>

                    <!-- uploads GRID -->
                    <div id="uploadsHistoryGrid">

                        <!-- uploads 1 -->
                        <div class="uploads-card uploads-item" data-index="0">
                            <h3 class="uploads-title"><span class="uploads-tag">Latest</span></h3>
                            <div class="uploads-filename" title="livingroom_rug_test.wav">
                            livingroom_rug_te‚Ä¶
                            </div>
                            <div class="uploads-time">‚Äî</div>
                            <div class="uploads-score">--</div>

                            <div class="uploads-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>

                            <div class="uploads-footer">
                                <button class="notes-btn" data-uploads-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this uploads</span>
                                </div>
                            </div>
                        </div>

                        <!-- uploads 2 -->
                        <div class="uploads-card uploads-item" data-index="1">
                            <h3 class="uploads-title"><span class="uploads-tag">Previous</span></h3>
                            <div class="uploads-filename" title="livingroom_rug_test.wav">
                            livingroom_no_rug_te‚Ä¶
                            </div>
                            <div class="uploads-time">‚Äî</div>
                            <div class="uploads-score">--</div>

                            <div class="uploads-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>

                            <div class="uploads-footer">
                                <button class="notes-btn" data-uploads-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this uploads</span>
                                </div>
                            </div>
                        </div>

                        <!-- uploads 3 -->
                        <div class="uploads-card uploads-item" data-index="2">
                            <h3 class="uploads-title"><span class="uploads-tag">Earlier</span></h3>
                            <div class="uploads-filename" title="livingroom_rug_test.wav">
                            livingroom_with_sub_te‚Ä¶
                            </div>
                            <div class="uploads-time">‚Äî</div>
                            <div class="uploads-score">--</div>

                            <div class="uploads-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>

                            <div class="uploads-footer">
                                <button class="notes-btn" data-uploads-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this uploads</span>
                                </div>
                            </div>
                        </div>

                        <!-- uploads 4 -->
                        <div class="uploads-card uploads-item" data-index="3">
                            <h3 class="uploads-title"><span class="uploads-tag">Oldest</span></h3>
                            <div class="uploads-filename" title="livingroom_rug_test.wav">
                            livingroom_no_coffee_te‚Ä¶
                            </div>
                            <div class="uploads-time">‚Äî</div>
                            <div class="uploads-score">--</div>

                            <div class="uploads-metrics">
                                <div><span>Peaks & Dips</span><span class="m-peaks">--</span></div>
                                <div><span>Reflections</span><span class="m-reflections">--</span></div>
                                <div><span>Bandwidth</span><span class="m-bandwidth">--</span></div>
                                <div><span>Balance</span><span class="m-balance">--</span></div>
                                <div><span>Smoothness</span><span class="m-smoothness">--</span></div>
                                <div><span>Clarity</span><span class="m-clarity">--</span></div>
                            </div>

                            <div class="uploads-footer">
                                <button class="notes-btn" data-uploads-note>Notes</button>
                                <div class="note-preview empty" data-note-preview>
                                    <span class="note-placeholder">Add notes for this uploads</span>
                                </div>
                            </div>
                        </div>

                     </div>
                    </section>

            </div>

        </main>
    </div>

    <script>
        function toast(msg, type = 'info') {
            const box = document.createElement('div');
            box.style.cssText = `
                position:fixed;
                top:1rem;
                right:1rem;
                padding:0.75rem 1rem;
                border-radius:8px;
                color:white;
                font-size:0.9rem;
                z-index:9999;
                transition:opacity 0.3s;
                background:${type === 'error'
                    ? '#ef4444'
                    : type === 'success'
                        ? '#10b981'
                        : '#3b82f6'};
            `;
            box.textContent = msg;
            document.body.appendChild(box);

            setTimeout(() => { box.style.opacity = '0'; }, 6000);
            setTimeout(() => { box.remove(); }, 8300);

        }
    </script>

    <script src="js/davePhraseEngine.js"></script>

    <script src="js/dashboard.js"></script>

    <script>
    /* REQUIRED GLOBAL CAPS (LOCAL MODE ONLY) */
    window.CAPS = {
        history: true,
        sweep: true,
        uploads: true
    };
    </script>


    <script>
    document.addEventListener("DOMContentLoaded", () => {
        window.dashboard = new MeasurelyDashboard();
    });
    </script>


    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("runSweepBtn");
        if (!btn) return;

        btn.addEventListener("click", () => {
            console.log("üü¢ CLICK: runSweepBtn");

            if (window.dashboard?.runSweep) {
                window.dashboard.runSweep();
            } else {
                console.error("üî¥ dashboard.runSweep not available");
            }
        });
    });
    </script>


    <script>


       function formatTimestamp(isoString) {
            if (!isoString) return "No Data";
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch { return isoString; }
        }
    

        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    side.classList.remove('active');
                    over.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        });

        setInterval(() => {
            const el = document.getElementById('lastUpdated');
            if (el) el.textContent = new Date().toLocaleTimeString();
        }, 1000);
    </script>

<!-- NOTES MODAL (GLOBAL POPUP) -->
<div id="notesModal" class="notes-modal" aria-hidden="true">
    <div class="notes-modal-backdrop"></div>

    <div class="notes-modal-content">
        <div class="notes-modal-header">
            <h3 id="notesModalTitle">uploads Notes</h3>
            <button class="notes-modal-close" aria-label="Close notes">&times;</button>
        </div>

        <div class="notes-modal-body">
            <textarea id="notesTextarea" 
                      class="notes-textarea" 
                      placeholder="Write your notes here‚Ä¶"></textarea>
        </div>

        <div class="notes-modal-footer">
            <button id="saveNotesBtn" class="btn btn-primary">Save</button>
        </div>
    </div>
</div>


<script>

// ========================
// NOTES MODAL LOGIC (SAFE)
// ========================

let currentuploadsIndex = null;

document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("notesModal");
    const textarea = document.getElementById("notesTextarea");
    const saveBtn = document.getElementById("saveNotesBtn");

    if (!modal || !textarea || !saveBtn) {
        console.warn("Notes modal elements missing");
        return;
    }

    // FORCE closed on load
    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden", "true");

    // OPEN modal
    window.openNotesModal = (index) => {
        currentuploadsIndex = index;
        textarea.value = localStorage.getItem(`uploadsNote_${index}`) || "";
        modal.classList.remove("hidden");
        modal.setAttribute("aria-hidden", "false");
    };

    // CLOSE modal
    window.closeNotesModal = () => {
        modal.classList.add("hidden");
        modal.setAttribute("aria-hidden", "true");
    };

    // OPEN buttons
    document.querySelectorAll("[data-uploads-note]").forEach((btn, i) => {
        btn.addEventListener("click", () => openNotesModal(i));
    });

    // SAVE
    saveBtn.addEventListener("click", () => {
        const note = textarea.value || "";
        localStorage.setItem(`uploadsNote_${currentuploadsIndex}`, note);

        const preview = document.querySelector(
            `.uploads-card[data-index="${currentuploadsIndex}"] [data-note-preview]`
        );
        if (preview) preview.textContent = note || "‚Äî";

        closeNotesModal();
    });

    // CLOSE (X buttons)
    modal.querySelectorAll(".notes-modal-close")
        .forEach(btn => btn.addEventListener("click", closeNotesModal));

    // BACKDROP
    modal.querySelectorAll(".notes-modal-backdrop")
        .forEach(el => el.addEventListener("click", closeNotesModal));
});
</script>


<script>

document.addEventListener("DOMContentLoaded", () => {
    // Get the current filename (e.g., 'index.html' or 'room-setup.html')
    const currentPath = window.location.pathname.split("/").pop() || "index.html";
    
    const navItems = document.querySelectorAll(".nav-item");

    navItems.forEach(item => {
        // Remove hardcoded active classes first
        item.classList.remove("active");
        
        // Check if the link's href matches our current page
        if (item.getAttribute("href") === currentPath) {
            item.classList.add("active");
        }
    });
});

</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const historyBtn = document.getElementById("viewHistoryBtn");
    if (!historyBtn) return;

    historyBtn.addEventListener("click", () => {
        window.location.href = "uploads.html";
    });
});
</script>


<script type="module">
  import { initRoom3D } from "./js/room3d.js";

  async function initDashboardRoom() {
    let roomState = null;

    try {
      const res = await fetch("/api/room/latest");
      if (res.ok) {
        roomState = await res.json();
      }
    } catch (e) {
      console.warn("[DashboardRoom] No saved room, skipping render");
      return;
    }

    if (!roomState) return;

    window.room3D = initRoom3D({
    mountId: "dashboardRoomCanvas",
    getRoomData: () => roomState,
    mode: "final"
    });

    // Hard-lock behaviour
    room3D.setStage("furnishings");
  }

  document.addEventListener("DOMContentLoaded", initDashboardRoom);
</script>

<script>
function wireAnalysisCards() {
    const cards = document.querySelectorAll('.analysis-card-trigger');
    if (!cards.length) return;

    function activateCard(card) {
        const overlay = card.dataset.overlay;
        if (!overlay || !window.room3D) return;

        cards.forEach(c => c.classList.remove('active-diagnostic'));
        card.classList.add('active-diagnostic');

        let score = 10;
        const scoreEl = card.querySelector('.score-value');
        if (scoreEl && !isNaN(parseFloat(scoreEl.textContent))) {
            score = parseFloat(scoreEl.textContent);
        }

        console.log("üéØ Focusing issue:", overlay, "score:", score);
        window.room3D.focusIssue(overlay, score);

        updateRoomInsightText(overlay, window.dashboard?.currentData);
    }

    cards.forEach(card => {
        card.addEventListener('click', () => activateCard(card));
    });

    // Auto-select first card AFTER wiring
    const first = document.querySelector('[data-overlay="sbir"]');
    if (first) activateCard(first);
}

/* Wait until the module has created room3D */
const roomReadyInterval = setInterval(() => {
    if (window.room3D && typeof window.room3D.focusIssue === "function") {
        clearInterval(roomReadyInterval);
        console.log("‚úÖ room3D ready ‚Äî wiring analysis UI");
        wireAnalysisCards();
    }
}, 100);
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const cards = document.querySelectorAll('.analysis-card-trigger');

    function activateCard(card) {
        const overlay = card.dataset.overlay;
        if (!overlay) return;

        console.log("üü¢ Room analysis card clicked:", overlay);

        cards.forEach(c => c.classList.remove('active-diagnostic'));
        card.classList.add('active-diagnostic');

        if (!window.room3D) {
            console.warn("room3D not ready yet, retrying‚Ä¶");
            setTimeout(() => activateCard(card), 200);
            return;
        }

        let score = 10;
        const scoreEl = card.querySelector('.score-value');
        if (scoreEl && !isNaN(parseFloat(scoreEl.textContent))) {
            score = parseFloat(scoreEl.textContent);
        }

        room3D.focusIssue(overlay, score);
    }

    cards.forEach(card => {
        card.addEventListener('click', () => activateCard(card));
    });

    const first = document.querySelector('[data-overlay="sbir"]');
    if (first) {
        setTimeout(() => activateCard(first), 600);
    }

});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const cancelBtn = document.getElementById("cancelSweepBtn");
  if (!cancelBtn) return;

  cancelBtn.addEventListener("click", async () => {
    console.warn("üü• Sweep cancelled by user");

    // 1. Tell backend to stop (safe even if nothing running)
    try {
      await fetch("/api/cancel-sweep", { method: "POST" });
    } catch (e) {
      console.warn("Cancel request failed (ignored)", e);
    }

    // 2. Close modal immediately
    const modal = document.getElementById("sweepProgressModal");
    modal?.classList.add("hidden");
    modal?.setAttribute("aria-hidden", "true");

    // 3. Reset dashboard sweep state
    if (window.dashboard) {
      window.dashboard.isSweepRunning = false;
    }

    // 4. HARD IGNORE any partial upload
    window.__IGNORE_LATEST_SWEEP__ = true;
  });
});
</script>


<div id="sweepProgressModal" class="sweep-modal hidden" aria-hidden="true">
  <div class="sweep-modal-backdrop"></div>

  <div class="sweep-modal-content glass-panel">
    <h3 class="sweep-title">Running Measurement</h3>

    <!-- CURRENT STAGE -->
    <div id="sweepStageText" class="sweep-stage">
      Starting sweep‚Ä¶
    </div>

    <!-- PROGRESS BAR -->
    <div class="sweep-progress">
      <div class="sweep-progress-fill" id="sweepProgressFill"></div>
    </div>

    <div class="sweep-percent" id="sweepPercent">0%</div>

    <!-- ANIMATED LOADER LINE -->
    <div class="sweep-loader">
      <div class="sweep-line"></div>
    </div>

    <!-- LIVE ENGINE LOG (RAW DATA STREAM) -->
    <div id="sweepLogPanel" class="sweep-log-panel" aria-live="polite"></div>

    <!-- MINI ANALYSIS PANEL (GEEK MODE) -->
    <div id="sweepMathPanel" class="sweep-math-panel hidden">
      <div class="sweep-math-title">Live Analysis</div>
      <div class="sweep-math-grid">
        <div><span>SNR</span><span id="liveSNR">‚Äî dB</span></div>
        <div><span>IR Peak</span><span id="liveIRPeak">‚Äî</span></div>
        <div><span>Peak Frame</span><span id="livePeakFrame">‚Äî</span></div>
        <div><span>Room Modes</span><span id="liveModes">‚Äî</span></div>
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="sweep-actions">
      <button id="cancelSweepBtn" class="btn btn-danger is-critical">
        Cancel sweep
      </button>
    </div>

  </div>
</div>


</body>

</html>