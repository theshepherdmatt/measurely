<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Measurely – Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="icons/dave.svg">
  <link rel="stylesheet" href="measurely.css">
  <script src="js/plotly.min.js"></script>
</head>

<body>

  <div class="app-layout">

    <!-- MOBILE OVERLAY -->
    <div id="sidebar-overlay" aria-hidden="true"
      style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(4px);">
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-logo">
        <img src="icons/mainlogo.svg" alt="Measurely" style="height: 46px;">
        <span></span>
      </div>

      <nav aria-label="Main">
        <a href="index.html" class="nav-item active">
          <img src="icons/dashboard.svg" alt="">
          Dashboard
        </a>
        <a href="room-setup.html" class="nav-item">
          <img src="icons/home.svg" alt="">
          Room Setup
        </a>
        <a href="tipsandtweaks.html" class="nav-item">
          <img src="icons/lightbulb.svg" alt="">
          Tips & Tweaks
        </a>
      </nav>

      <div style="margin-top: auto;">
        <div class="glass-panel" style="padding: 1rem; border-radius: 12px;">
          <div
            style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--c-text-muted);">
            <div id="systemReadyDot" class="status-indicator"
              style="width: 8px; height: 8px; border-radius: 50%; background: var(--c-excellent);"></div>
            <span id="systemReadyText" aria-live="polite">System Ready</span>
          </div>
          <div style="font-size: 0.75rem; color: rgba(255,255,255,0.3);">
            Last updated: <span id="lastUpdated">Now</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">

      <!-- HEADER -->
      <header class="header animate-enter">
        <div class="header-title" style="display: flex; align-items: center; gap: 1rem;">
          <button id="mobile-menu-btn" class="btn btn-secondary" style="padding: 0.5rem; display: none;"
            aria-label="Toggle navigation" aria-expanded="false">
            <img src="icons/bars.svg" style="width: 24px;" alt="">
          </button>
          <div>
            <h1>Your Room Results</h1>
            <p>Acoustic analysis and optimization insights.</p>
          </div>
        </div>
        <div style="display: flex; gap: 1rem;">
          <button id="runSweepBtn" class="btn btn-primary">
            <img src="icons/sweep.svg" style="width: 18px; filter: brightness(100);" alt="">
            Run Sweep
          </button>
          <button id="refreshDashboardBtn" class="btn btn-secondary" aria-label="Refresh Dashboard">
            <img src="icons/refresh.svg" style="width: 16px;" alt="">
          </button>
        </div>
      </header>

      <!-- TOP ROW: SCORE & ACTIONS -->
      <div class="grid-3 animate-enter delay-1">

        <!-- OVERALL SCORE CARD -->
        <div class="card glass-panel" style="grid-column: span 2; padding: 1.75rem; border-radius: 18px;">

          <!-- Title -->
          <h2 class="card-title"
            style="display:flex; align-items:center; gap:0.5rem; margin-bottom:1rem; font-size:1rem; font-weight:normal;">
            <img src="icons/chart-line.svg" style="width:16px; opacity:0.7;" alt="">
            <span style="text-transform:uppercase; letter-spacing:0.5px;">Overall Room Score</span>
          </h2>

          <!-- SCORE LEFT + DAVE RIGHT -->
          <div style="
            display:flex;
            justify-content:space-between;
            align-items:flex-start;
            gap:2rem;
            flex-wrap:wrap;
          ">

            <!-- SCORE -->
            <div class="score-display" style="display:flex; align-items:flex-end;">
              <span id="overallScore" class="score-value text-gradient-accent"
                style="font-size:5.25rem; font-weight:700;" data-color-target="overall">--</span>
              <span class="score-max" style="opacity:0.5; font-size:1rem; margin-left:0.25rem; transform: translateY(-8px);">/ 10</span>
            </div>

            <!-- DAVE SAYS -->
            <div class="dave-box" style="max-width:260px; text-align:left; display:flex; flex-direction:column;">

              <!-- ICON + TITLE LEFT -->
              <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.4rem; align-self:flex-start;">
                <img src="icons/dave.svg" style="width:24px; opacity:0.9;" alt="">
                <span style="font-weight:700; font-size:0.85rem; letter-spacing:0.5px; color:var(--c-accent);">
                  DAVE SAYS
                </span>
              </div>

              <!-- PHRASE STARTS DIRECTLY UNDER THE ICON -->
              <p id="overallBuddyPhrase"
                style="margin:0; font-style:italic; font-size:0.95rem; line-height:1.45; color:var(--c-text-main);">
                “Run a sweep to get started.”
              </p>

            </div>


          </div>

          <!-- VERDICT -->
          <div style="
            margin-top:1.5rem;
            padding-top:1rem;
            border-top:1px solid rgba(255,255,255,0.06);
            display:flex;
            align-items:center;
            gap:0.75rem;
            font-size:0.95rem;
            color:var(--c-text-main);
          ">
            <span id="overallStatus" class="status-indicator"
              style="width:10px; height:10px; border-radius:50%; background:#6B7280;"></span>

            <span id="overallStatusText" style="font-weight:600;" aria-live="polite">
              Verdict: --
            </span>

            <span style="opacity:0.4;">•</span>

            <span style="opacity:0.6;">Based on 6 key acoustic metrics</span>
          </div>

        </div>



        <!-- QUICK ACTIONS / INFO -->
        <!-- SESSION INFO -->
        <div class="card glass-panel">
          <h2 class="card-title">Session Info</h2>

          <div style="display: flex; flex-direction: column; gap: 1rem;">

            <!-- DEVICE NAME -->
            <div style="display:flex; justify-content: space-between; align-items:center; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.05);">
              <div style="display:flex; align-items:center; gap:0.5rem;">
                <img src="icons/dave.svg" style="width:16px; opacity:0.7;">
                <span style="color: var(--c-text-muted);">Device Name</span>
              </div>
              <span style="font-weight:600; color:var(--c-text-main);">Dave the Hoff</span>
            </div>

            <!-- DAC -->
            <div style="display:flex; justify-content:flex-start; align-items:center; gap:0.5rem;">
              <span style="color: var(--c-text-muted);"></span>

              <div style="display:flex; align-items:center; gap:0.5rem;">
                <div id="dacStatusDot" class="status-indicator"
                    style="width:10px; height:10px; border-radius:50%; background:#6B7280;">
                </div>
                <span id="dacStatusText" style="font-weight:600; color:var(--c-text-main);" aria-live="polite">
                  --
                </span>
              </div>
            </div>

            <!-- MIC -->
            <div style="display:flex; justify-content:flex-start; align-items:center; gap:0.5rem;">
              <span style="color: var(--c-text-muted);"></span>

              <div style="display:flex; align-items:center; gap:0.5rem;">
                <div id="usbStatusDot" class="status-indicator"
                    style="width:10px; height:10px; border-radius:50%; background:#ef4444;">
                </div>
                <span id="usbStatusText" style="font-weight:600; color:var(--c-text-main);" aria-live="polite">
                  --
                </span>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- METRICS GRID -->
      <div class="grid-3 animate-enter delay-2">

        <!-- Peaks & Dips -->
        <div class="card glass-panel">
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <h2 class="card-title" style="margin:0;">Peaks & Dips</h2>
            <img src="icons/mountain.svg" style="width: 20px; opacity: 1;" data-color-icon="peaksDips" alt="">
          </div>
          <div class="score-display" style="margin-bottom: 1rem;">
            <span id="peaksDipsScore" class="score-value" style="font-size: 2.5rem;"
              data-color-target="peaksDips">--</span>
          </div>
          <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Smoothness of bass and lower
            mids.</p>
          <div
            style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.6);">
            <img src="icons/dave.svg" style="width: 16px; opacity: 1;" alt="">
            <span id="peaksDipsBuddy" style="font-style: italic;">--</span>
          </div>
          <!-- Hidden spans for JS compatibility -->
          <span id="peaksDipsStatus" class="hidden"></span>
          <span id="peaksDipsStatusText" class="hidden"></span>
          <span id="peaksDipsRaw" class="hidden"></span>
          <span id="peaksDipsSummary" class="hidden"></span>
        </div>

        <!-- Reflections -->
        <div class="card glass-panel">
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <h2 class="card-title" style="margin:0;">Reflections</h2>
            <img src="icons/square-caret-left.svg" style="width: 20px; opacity: 1;" data-color-icon="reflections"
              alt="">
          </div>
          <div class="score-display" style="margin-bottom: 1rem;">
            <span id="reflectionsScore" class="score-value" style="font-size: 2.5rem;"
              data-color-target="reflections">--</span>
          </div>
          <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Early wall/floor bounce
            coloring sound.</p>
          <div
            style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.6);">
            <img src="icons/dave.svg" style="width: 16px; opacity: 1;" alt="">
            <span id="reflectionsBuddy" style="font-style: italic;">--</span>
          </div>
          <span id="reflectionsStatus" class="hidden"></span>
          <span id="reflectionsStatusText" class="hidden"></span>
          <span id="reflectionsRaw" class="hidden"></span>
        </div>

        <!-- Bandwidth -->
        <div class="card glass-panel">
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <h2 class="card-title" style="margin:0;">Bandwidth</h2>
            <img src="icons/signal.svg" style="width: 20px; opacity: 1;" data-color-icon="bandwidth" alt="">
          </div>
          <div class="score-display" style="margin-bottom: 1rem;">
            <span id="bandwidthScore" class="score-value" style="font-size: 2.5rem;"
              data-color-target="bandwidth">--</span>
          </div>
          <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">How wide your system plays
            (Bass to Air).</p>
          <div
            style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.6);">
            <img src="icons/dave.svg" style="width: 16px; opacity: 1;" alt="">
            <span id="bandwidthBuddy" style="font-style: italic;">--</span>
          </div>
          <span id="bandwidthStatus" class="hidden"></span>
          <span id="bandwidthStatusText" class="hidden"></span>
          <span id="bandwidthRaw" class="hidden"></span>
          <span id="bandwidthSummary" class="hidden"></span>
        </div>

        <!-- Balance -->
        <div class="card glass-panel">
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <h2 class="card-title" style="margin:0;">Balance</h2>
            <img src="icons/balance-scale.svg" style="width: 20px; opacity: 1;" data-color-icon="balance" alt="">
          </div>
          <div class="score-display" style="margin-bottom: 1rem;">
            <span id="balanceScore" class="score-value" style="font-size: 2.5rem;" data-color-target="balance">--</span>
          </div>
          <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Tonal tilt (Warm vs Bright).
          </p>
          <div
            style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.6);">
            <img src="icons/dave.svg" style="width: 16px; opacity: 1;" alt="">
            <span id="balanceBuddy" style="font-style: italic;">--</span>
          </div>
          <span id="balanceStatus" class="hidden"></span>
          <span id="balanceStatusText" class="hidden"></span>
          <span id="balanceRaw" class="hidden"></span>
        </div>

        <!-- Smoothness -->
        <div class="card glass-panel">
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <h2 class="card-title" style="margin:0;">Smoothness</h2>
            <img src="icons/wave-square.svg" style="width: 20px; opacity: 1;" data-color-icon="smoothness" alt="">
          </div>
          <div class="score-display" style="margin-bottom: 1rem;">
            <span id="smoothnessScore" class="score-value" style="font-size: 2.5rem;"
              data-color-target="smoothness">--</span>
          </div>
          <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">Fine-grain consistency across
            spectrum.</p>
          <div
            style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.6);">
            <img src="icons/dave.svg" style="width: 16px; opacity: 1;" alt="">
            <span id="smoothnessBuddy" style="font-style: italic;">--</span>
          </div>
          <span id="smoothnessStatus" class="hidden"></span>
          <span id="smoothnessStatusText" class="hidden"></span>
          <span id="smoothnessRaw" class="hidden"></span>
        </div>

        <!-- Reverb -->
        <div class="card glass-panel">
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <h2 class="card-title" style="margin:0;">Reverb</h2>
            <img src="icons/clock.svg" style="width: 20px; opacity: 1;" data-color-icon="reverb" alt="">
          </div>
          <div class="score-display" style="margin-bottom: 1rem;">
            <span id="reverbScore" class="score-value" style="font-size: 2.5rem;" data-color-target="reverb">--</span>
          </div>
          <p style="font-size: 0.9rem; color: var(--c-text-muted); margin-bottom: 1.5rem;">How long the room holds onto
            sound.</p>
          <div
            style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.6);">
            <img src="icons/dave.svg" style="width: 16px; opacity: 1;" alt="">
            <span id="reverbBuddy" style="font-style: italic;">--</span>
          </div>
          <span id="reverbStatus" class="hidden"></span>
          <span id="reverbStatusText" class="hidden"></span>
          <span id="reverbRaw" class="hidden"></span>
        </div>

      </div>

      <!-- NERDS CORNER -->
      <div class="card glass-panel animate-enter delay-3">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="background: rgba(255,255,255,0.05); padding: 0.5rem; border-radius: 8px;">
              <img src="icons/dave.svg" style="width: 24px; opacity: 0.8;" alt="">
            </div>
            <div>
              <h2 style="margin: 0; font-size: 1.25rem; font-weight: 700;">Nerds Corner</h2>
              <p style="margin: 0; color: var(--c-text-muted); font-size: 0.9rem;">Deep dive analysis and raw curves.
              </p>
            </div>
          </div>

          <div style="background: rgba(0,0,0,0.2); padding: 0.25rem; border-radius: 8px; display: flex; gap: 0.25rem;">
            <button id="leftChannelBtn" data-channel="left" class="btn btn-secondary"
              style="padding: 0.4rem 1rem; font-size: 0.85rem;">Left</button>
            <button id="rightChannelBtn" data-channel="right" class="btn btn-secondary"
              style="padding: 0.4rem 1rem; font-size: 0.85rem;">Right</button>
            <button id="bothChannelsBtn" data-channel="both" class="btn btn-primary"
              style="padding: 0.4rem 1rem; font-size: 0.85rem;">Both</button>
          </div>
        </div>

        <div class="chart-container">
          <div id="frequencyChart" class="chart-responsive" style="width: 100%; height: 400px;" role="img"
            aria-label="Frequency Response Chart"></div>
        </div>

        <!-- Session History Buttons (Hidden by default logic but keeping structure) -->
        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.05);">
          <h3 class="card-title">Session History</h3>
          <div style="display: flex; gap: 0.5rem;">
            <button id="sessionLatestBtn" class="session-btn session-active">Latest</button>
            <button id="sessionPreviousBtn" class="session-btn">Previous</button>
            <button id="sessionLastBtn" class="session-btn">Oldest</button>
          </div>
          <!-- Hidden metrics container for JS -->
          <div id="sessionMetrics" class="hidden">
            <span id="sessOverallScore"></span><span id="sessOverallStatus"></span>
            <span id="sessPeaksDips"></span><span id="sessReflections"></span>
            <span id="sessBandwidth"></span><span id="sessBalance"></span>
            <span id="sessSmoothness"></span><span id="sessReverb"></span>
            <span id="sessBass"></span><span id="sessMid"></span>
            <span id="sessTreble"></span><span id="sessAir"></span>
            <!-- Added missing IDs that might be called -->
            <span id="bassLevel"></span><span id="midLevel"></span><span id="trebleLevel"></span><span
              id="airLevel"></span>
            <div id="bassBar"></div>
            <div id="midBar"></div>
            <div id="trebleBar"></div>
            <div id="airBar"></div>
          </div>
        </div>

      </div>

    </main>
  </div>

  <script src="js/dashboard.js"></script>
  <script>
    window.rawMetrics = {
      peaks_dips: {
        excellent: ["Spectral Deviation Index: 0.84 dB", "Modal Uniformity Factor: +1.2 dB", "Standing-Wave Suppression: -0.4 dB"],
        good: ["Spectral Deviation Index: 1.8 dB", "Boundary Coupling Error: +2.1 dB", "Modal Uniformity Factor: -1.3 dB"],
        okay: ["Modal Pressure Variance: +4.6 dB", "Low-Band Error Vector: 3.9 dB", "Cancellation Density Score: 2.7"],
        needs_work: ["Modal Instability Index: +8.4 dB", "Boundary Reflection Error: 7.1 dB", "Cancellation Severity: Critical (11.2 dB)"]
      },
      reflections: {
        excellent: ["Reflection Suppression Ratio: 0.6"],
        good: ["Early Bounce Coherence: 1.2"],
        okay: ["Multi-Surface Echo Factor: 2.8"],
        needs_work: ["Hard-Reflective Zone Index: 6.1"]
      },
      bandwidth: {
        excellent: ["Bandwidth Index: 92% usable"],
        good: ["Range Efficiency: 78%"],
        okay: ["Range Compression: 51%"],
        needs_work: ["Severe Band-Loss Detected"]
      },
      balance: {
        excellent: ["Tilt Variance: ±0.4 dB"],
        good: ["Tilt Offset: 1.1 dB"],
        okay: ["Tilt Asymmetry: 3.2 dB"],
        needs_work: ["Extreme Bass/Mid Imbalance"]
      },
      smoothness: {
        excellent: ["Micro-Deviation Index: 0.7 dB"],
        good: ["Micro-Deviation Index: 1.5 dB"],
        okay: ["Micro-Deviation Index: 3.4 dB"],
        needs_work: ["Severe Fine-Grain Variance: 6.2 dB"]
      },
      reverb: {
        excellent: ["Decay Uniformity Score: 0.14s"],
        good: ["Decay Uniformity Score: 0.23s"],
        okay: ["Decay Spread: 0.41s"],
        needs_work: ["Decay Instability: 0.78s"]
      }
    };

    document.getElementById("refreshDashboardBtn").addEventListener("click", async () => {
      console.log("Refreshing dashboard…");

      if (!window.dashboard) {
        console.error("Dashboard not initialised");
        return;
      }

      try {
        // 1. Load new sweep/session data
        await window.dashboard.loadData();

        // 2. Fully redraw dashboard UI
        window.dashboard.updateDashboard();

        // 3. Update nerd metrics
        window.dashboard.updateCompareSessionMetrics();

        // 4. Reset chart to both channels
        window.dashboard.showChannel('both');

        // 5. Optional toast
        window.dashboard.showSuccess("Dashboard refreshed");

      } catch (err) {
        console.error("Refresh failed:", err);
        window.dashboard.showError("Refresh failed");
      }
    });


    function formatTimestamp(isoString) {
      if (!isoString) return "No Data";
      try {
        const date = new Date(isoString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } catch { return isoString; }
    }

    function getScoreStatus(score) {
      if (score >= 8) return 'Excellent';
      if (score >= 6) return 'Good';
      if (score >= 4) return 'Okay';
      return 'Needs work';
    }

    async function loadNewSession(sessionId) {
      if (!sessionId) { console.error("No session ID provided."); return; }
      const res = await fetch(`/api/session/${sessionId}/load`, { method: 'POST' });
      if (res.ok) location.reload();
      else console.error(`Failed to load session ${sessionId}`);
    }

    document.querySelectorAll('.session-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.session-btn').forEach(b => b.classList.remove('session-active'));
        btn.classList.add('session-active');
      });
    });

    async function loadSessionMetrics(sessionId) {
      try {
        const res = await fetch(`/api/session/${sessionId}`);
        if (!res.ok) throw new Error(`Failed to load session data for ${sessionId}`);
        const data = await res.json();
        const metricsContainer = document.getElementById('sessionMetrics');

        if (!data.has_analysis) {
          metricsContainer.innerHTML = '<p class="text-sm text-gray-500">Analysis not run for this sweep.</p>';
          return;
        }

        function safeNumber(v) {
          if (v === null || v === undefined) return null;
          if (Array.isArray(v) && v.length > 0) { const n = Number(v[0]); return isNaN(n) ? null : n; }
          const n = Number(v); return isNaN(n) ? null : n;
        }

        const overallEl = document.getElementById('sessOverallScore');
        const overallStatusEl = document.getElementById('sessOverallStatus');
        if (data.overall_score != null) {
          overallEl.textContent = data.overall_score.toFixed(1);
          overallStatusEl.textContent = getScoreStatus(data.overall_score);
          applyDynamicColor(overallEl, data.overall_score);
          applyDynamicColor(overallStatusEl, data.overall_score);
        } else {
          overallEl.textContent = '--';
          overallStatusEl.textContent = '--';
        }

        const updateMetric = (id, value) => {
          const el = document.getElementById(id);
          if (value != null) {
            el.textContent = value.toFixed(1);
            applyDynamicColor(el, value);
          } else el.textContent = '--';
        };

        updateMetric('sessPeaksDips', data.peaks_dips);
        updateMetric('sessReflections', data.reflections);
        updateMetric('sessBandwidth', data.bandwidth);
        updateMetric('sessBalance', data.balance);
        updateMetric('sessSmoothness', data.smoothness);
        updateMetric('sessReverb', data.reverb);

        const bands = data.band_levels_db || {};
        const sessBass = safeNumber(bands.bass ?? bands.bass_20_200);
        const sessMid = safeNumber(bands.mid ?? bands.mid_200_2k);
        const sessTreble = safeNumber(bands.treble ?? bands.treble_2k_10k);
        const sessAir = safeNumber(bands.air ?? bands.air_10k_20k);

        const updateBand = (id, value) => {
          const el = document.getElementById(id);
          if (value !== null) {
            el.textContent = `${value.toFixed(1)} dB`;
            if (window.dashboard) dashboard.applySixCardColor(id, value);
          } else el.textContent = '-- dB';
        };

        updateBand('sessBass', sessBass);
        updateBand('sessMid', sessMid);
        updateBand('sessTreble', sessTreble);
        updateBand('sessAir', sessAir);

        const bassLevel = document.getElementById('bassLevel');
        const midLevel = document.getElementById('midLevel');
        const trebleLevel = document.getElementById('trebleLevel');
        const airLevel = document.getElementById('airLevel');
        const bassBar = document.getElementById('bassBar');
        const midBar = document.getElementById('midBar');
        const trebleBar = document.getElementById('trebleBar');
        const airBar = document.getElementById('airBar');

        bassLevel.textContent = sessBass !== null ? `${sessBass.toFixed(1)} dB` : '-- dB';
        midLevel.textContent = sessMid !== null ? `${sessMid.toFixed(1)} dB` : '-- dB';
        trebleLevel.textContent = sessTreble !== null ? `${sessTreble.toFixed(1)} dB` : '-- dB';
        airLevel.textContent = sessAir !== null ? `${sessAir.toFixed(1)} dB` : '-- dB';

        const barWidth = v => v !== null ? `${(v + 12) * 4}%` : '0%';
        bassBar.style.width = barWidth(sessBass);
        midBar.style.width = barWidth(sessMid);
        trebleBar.style.width = barWidth(sessTreble);
        airBar.style.width = barWidth(sessAir);

        applyMainBand(bassLevel, bassBar, sessBass);
        applyMainBand(midLevel, midBar, sessMid);
        applyMainBand(trebleLevel, trebleBar, sessTreble);
        applyMainBand(airLevel, airBar, sessAir);

      } catch (error) {
        console.error("Error loading session metrics:", error);
        document.getElementById('sessionMetrics').innerHTML = '<p class="text-sm text-red-500">Failed to load detailed metrics.</p>';
      }
    }

    async function loadSessionExplorer() {
      try {
        const res = await fetch('/api/sessions');
        if (!res.ok) throw new Error('Failed to fetch sessions');
        const sessions = await res.json();

        if (sessions.length === 0) {
          document.getElementById('sessionMetrics').innerHTML = '<p class="text-sm text-gray-500">No previous sweeps found. Run a Quick Sweep above!</p>';
          document.querySelectorAll('.session-btn').forEach(btn => btn.disabled = true);
          return;
        }

        const latest = sessions[0];
        const previous = sessions[1] || null;
        const oldest = sessions[sessions.length - 1];

        const latestBtn = document.getElementById('sessionLatestBtn');
        latestBtn.textContent = formatTimestamp(latest.timestamp);
        latestBtn.dataset.sessionId = latest.id;

        const previousBtn = document.getElementById('sessionPreviousBtn');
        if (previous) {
          previousBtn.textContent = formatTimestamp(previous.timestamp);
          previousBtn.dataset.sessionId = previous.id;
          previousBtn.disabled = false;
          previousBtn.addEventListener('click', () => loadNewSession(previous.id));
        } else {
          previousBtn.textContent = 'Previous (N/A)';
          previousBtn.disabled = true;
        }

        const oldestBtn = document.getElementById('sessionLastBtn');
        if (sessions.length > 1 && latest.id !== oldest.id) {
          oldestBtn.textContent = formatTimestamp(oldest.timestamp);
          oldestBtn.dataset.sessionId = oldest.id;
          oldestBtn.disabled = false;
          oldestBtn.addEventListener('click', () => loadNewSession(oldest.id));
        } else {
          oldestBtn.textContent = sessions.length === 1 ? 'Only One Sweep' : 'Oldest (N/A)';
          oldestBtn.disabled = true;
        }

        await loadSessionMetrics('latest');

      } catch (error) {
        console.error("Error loading Session Explorer:", error);
        document.getElementById('sessionMetrics').innerHTML = '<p class="text-sm text-red-500">Error loading sessions.</p>';
      }
    }

    let firstDrawDone = false;
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof MeasurelyDashboard !== 'undefined') window.dashboard = new MeasurelyDashboard();
      loadSessionExplorer();
      const draw = () => {
        if (firstDrawDone) return;
        const box = document.getElementById('frequencyChart');
        if (!box || box.clientHeight === 0) { requestAnimationFrame(draw); return; }
        firstDrawDone = true;
        if (window.dashboard) window.dashboard.showChannel('both');
      };
      requestAnimationFrame(draw);
    });

    const btn = document.getElementById('mobile-menu-btn');
    const side = document.getElementById('sidebar');
    const over = document.getElementById('sidebar-overlay');
    function toggleMenu() {
      side.classList.toggle("active");
      over.classList.toggle("active");
      document.body.style.overflow = side.classList.contains("active") ? "hidden" : "";
    }
    if (btn) btn.addEventListener('click', toggleMenu);
    if (over) over.addEventListener('click', toggleMenu);

    document.querySelectorAll('.nav-item').forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          side.classList.remove('active');
          over.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    });

    setInterval(() => {
      const el = document.getElementById('lastUpdated');
      if (el) el.textContent = new Date().toLocaleTimeString();
    }, 1000);
  </script>
</body>

</html>