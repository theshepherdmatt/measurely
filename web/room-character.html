<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Measurely â€“ Behaviour</title>

    <link rel="icon" type="image/svg+xml" href="icons/dave.svg">
    <link rel="stylesheet" href="measurely.css">
</head>

<body>

<div class="app-layout">

    <div id="sidebar-overlay"
         style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(4px);">
    </div>

    <aside id="sidebar" class="sidebar" aria-label="Primary Navigation">
        <div class="sidebar-logo">
            <img src="icons/mainlogo.svg" alt="" aria-hidden="true" style="height: 46px;">
        </div>

        <nav aria-label="Main">
            <a href="index.html" class="nav-item">
                <img src="icons/home.svg" alt="" aria-hidden="true">
                Home
            </a>
            <a href="room-setup.html" class="nav-item">
                <img src="icons/dashboard.svg" alt="" aria-hidden="true">
                Room Setup
            </a>
            <a href="room-character.html" class="nav-item active">
                <img src="icons/curtains.svg" alt="" aria-hidden="true">
                Room Behaviour
            </a>
        </nav>
    </aside>

    <div id="sidebar-toggle" aria-label="Toggle sidebar" title="Toggle sidebar">â€¹</div>

    <main class="main-content">

        <!-- HEADER -->
        <header class="header animate-enter">
            <div class="header-title" style="display:flex; align-items:center; gap:1rem;">
                <div>
                    <h1>Your Room Behaviour</h1>
                    <p>What your room is actually doing to your speakers, based on measured behaviour.</p>
                </div>

                <button id="mobile-menu-btn"
                        class="btn btn-secondary"
                        style="padding:0.5rem; display:none; margin-left:auto;"
                        aria-label="Toggle navigation">
                    <img src="icons/bars.svg" style="width:24px;" alt="">
                </button>
            </div>
        </header>

        <!-- CONCLUSION -->
        <section class="card glass-panel animate-enter delay-1">
            <h2 class="card-title">The Conclusion</h2>
            <p id="roomVerdict" style="font-size:1.15rem; font-weight:600;">
                Run a sweep to generate your room character.
            </p>
        </section>

        <!-- AT A GLANCE -->
        <section class="card glass-panel animate-enter delay-2">
            <h2 class="card-title">At a Glance</h2>
            <p id="roomHeadline" class="dave-quote">
                This summary will appear once analysis is complete.
            </p>
        </section>

        <!-- MECHANICS -->
        <section class="card glass-panel animate-enter delay-3">
            <h2 class="card-title">How the Room Interacts with the Speaker</h2>
            <ul id="roomNegotiation">
                <li>Awaiting measurement data.</li>
            </ul>
        </section>

        <!-- STRENGTHS -->
        <section class="card glass-panel animate-enter delay-4">
            <h2 class="card-title">Where the Setup Still Performs Well</h2>
            <ul id="roomWinningTraits">
                <li>Awaiting measurement data.</li>
            </ul>
        </section>

        <!-- LISTENING -->
        <section class="card glass-panel animate-enter delay-5">
            <h2 class="card-title">Overall Sound Signature</h2>
            <p id="roomSignature" style="font-style:italic; color:var(--c-text-muted);">
                This will describe how the system is likely to sound in this room.
            </p>
        </section>

        <div class="form-actions">
            <a href="index.html" class="btn btn-secondary">Back to dashboard</a>
        </div>

    </main>
</div>

<script>
/* ===============================
   MOBILE SIDEBAR
================================ */
const btn = document.getElementById('mobile-menu-btn');
const side = document.getElementById('sidebar');
const over = document.getElementById('sidebar-overlay');

function toggleMenu() {
    side.classList.toggle("active");
    over.classList.toggle("active");
    document.body.style.overflow = side.classList.contains("active") ? "hidden" : "";
}

if (btn) btn.addEventListener('click', toggleMenu);
if (over) over.addEventListener('click', toggleMenu);
</script>

<script>
async function loadRoomBehaviour() {
    console.group('ðŸ§  Room Behaviour Loader');

    try {
        /* ===============================
           1. ROOM CHARACTER
        ============================== */
        const charRes = await fetch('/measurements/latest/room_character.json', { cache: 'no-store' });
        if (!charRes.ok) {
            console.warn('âŒ room_character.json not found');
            return;
        }

        const charJson = await charRes.json();
        console.log('room_character.json:', charJson);

        const raw = charJson.character;
        if (!raw || typeof raw !== 'string') {
            console.warn('âŒ character is missing or not a string');
            return;
        }

        /* --------------------------------
           Split main paragraph + bullets
        -------------------------------- */
        const [body, thinkBlock] = raw.split('**Think:**');

        // CONCLUSION
        document.getElementById('roomVerdict').textContent =
            body.trim().split('.').slice(0, 2).join('.') + '.';

        // AT A GLANCE
        document.getElementById('roomHeadline').textContent =
            body.trim();

        // NEGOTIATION (bullets)
        if (thinkBlock) {
            const bullets = thinkBlock
                .split('\n')
                .map(l => l.replace(/^[-â€¢]\s*/, '').trim())
                .filter(Boolean);

            const negotiation = document.getElementById('roomNegotiation');
            negotiation.innerHTML = '';
            bullets.forEach(b => {
                const li = document.createElement('li');
                li.textContent = b;
                negotiation.appendChild(li);
            });

            // WINNING TRAITS (reuse strongest 2â€“3)
            const winning = document.getElementById('roomWinningTraits');
            winning.innerHTML = '';
            bullets.slice(0, 3).forEach(b => {
                const li = document.createElement('li');
                li.textContent = b;
                winning.appendChild(li);
            });
        }

        /* ===============================
           2. CLIENT SUMMARY
        ============================== */
        const clientRes = await fetch('/measurements/latest/room_client_summary.json', { cache: 'no-store' });
        if (clientRes.ok) {
            const clientJson = await clientRes.json();
            if (clientJson.summary) {
                document.getElementById('roomSignature').textContent = clientJson.summary;
            }
        }

        console.log('âœ… Room behaviour injected successfully');

    } catch (err) {
        console.error('ðŸ”¥ Room behaviour load failed:', err);
    }

    console.groupEnd();
}

document.addEventListener('DOMContentLoaded', loadRoomBehaviour);
</script>


</body>
</html>
