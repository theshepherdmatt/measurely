<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Measurely – Tips and Tweaks</title>

<link rel="stylesheet" href="measurely.css" />
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  body { font-family: 'Inter', sans-serif; }
  .toast {
    position:fixed;top:1rem;right:1rem;padding:.75rem 1rem;
    border-radius:.5rem;color:#fff;font-size:.875rem;z-index:50;
    transform:translateX(120%);opacity:0;
    transition:transform .3s, opacity .3s;
  }
  .toast.show { transform:translateX(0);opacity:1; }
  .toast.error   { background:#ef4444; }
  .toast.success { background:#10b981; }
  .toast.info    { background:#3b82f6; }

  .measurely-card {
    background:white;
    border-radius:1rem;
    padding:1.5rem;
    box-shadow:0 4px 16px rgba(0,0,0,0.08);
  }
</style>
</head>

<body class="bg-gray-50">

<!-- Mobile banner -->
<div class="mobile-banner md:hidden fixed top-0 left-0 right-0 h-14 backdrop-blur-sm 
            flex items-center justify-between px-4 z-50">
  <div class="flex items-center space-x-2">
    <img src="buddy-icon-100-white.svg" class="w-10 h-10" alt="Dave">
    <span class="text-white font-semibold text-sm">Measurely</span>
  </div>
  <button id="mobile-menu-btn" class="p-2 rounded-lg text-white hover:bg-white/10 transition">
    <i class="fas fa-bars text-lg"></i>
  </button>
</div>

<!-- Sidebar -->
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<aside id="sidebar" class="sidebar gradient-bg fixed top-0 right-0 h-full w-64 text-white p-6 z-40">
  <div class="sidebar-logo mb-8 flex items-center space-x-3">
    <img src="buddy-icon-100-white.svg" class="w-12 h-12" alt="Measurely Buddy">
    <div>
      <h1 class="text-2xl font-bold">Measurely</h1>
      <p class="text-sm opacity-80">Simple Room Audio</p>
    </div>
  </div>

  <nav class="space-y-2">
    <a href="index.html" class="nav-item"><i class="fas fa-chart-line mr-3"></i>Dashboard</a>
    <a href="room-setup.html" class="nav-item"><i class="fas fa-home mr-3"></i>Room Setup</a>
    <a href="tipsandtweaks.html" class="nav-item active"><i class="fas fa-lightbulb mr-3"></i>Tips and Tweaks</a>
  </nav>
</aside>

<!-- MAIN -->
<div class="main-content md:ml-64 p-8">

  <!-- Header -->
  <div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Tips and Tweaks</h2>
    <p class="text-gray-600">Dave focuses on your three weakest acoustic areas and gives practical, no-nonsense solutions based on real measurements.</p>
  </div>

  <!-- KEY FINDINGS -->
  <div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
      <i class="fas fa-exclamation-triangle mr-2 text-blue-600"></i>
      Dave’s advice
    </h2>
    <div id="priorityCards" class="space-y-4"></div>
  </div>

    <!-- BUDDY DEEP DIVE -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
        <img src="buddy-icon-100.svg" class="w-12 h-12 mr-3 opacity-90" alt="Dave">
        Dave’s Deep Dive
    </h2>
    <div id="buddyDeepDive" class="space-y-4 text-sm text-gray-700"></div>
    </div>


  <!-- INSIGHTS -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

    <!-- FREQUENCY -->
    <div class="measurely-card">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-chart-line mr-2"></i>Frequency Response Insights
      </h3>
      <div id="freqIssues" class="space-y-4 text-sm"></div>
    </div>

    <!-- ROOM BEHAVIOUR -->
    <div class="measurely-card">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-home mr-2"></i>Room Behaviour Summary
      </h3>
      <div id="roomIssues" class="space-y-4 text-sm"></div>
    </div>

  </div>

  <!-- ACTION PLAN -->
  <div class="measurely-card mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">
      <i class="fas fa-tasks mr-2 text-blue-600"></i>Your Action Plan
    </h2>
    <div id="actionPlan" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm"></div>
  </div>

</div>

<div id="toast-container"></div>


<script>
/* -------------------- SIDEBAR --------------------- */
const btn = document.getElementById('mobile-menu-btn');
const side = document.getElementById('sidebar');
const overlay = document.getElementById('sidebar-overlay');

btn.addEventListener('click', () => {
  side.classList.toggle('active');
  overlay.classList.toggle('active');
});
overlay.addEventListener('click', () => {
  side.classList.remove('active');
  overlay.classList.remove('active');
});

/* -------------------- GLOBALS --------------------- */
let Solutions = {};
let data = null;

async function loadSolutions() {
  const r = await fetch('/buddy_phrases.json');
  Solutions = await r.json();
}

async function loadLatest() {
  const r = await fetch('/api/latest');
  data = await r.json();
}

document.addEventListener('DOMContentLoaded', async () => {
  await loadSolutions();
  await loadLatest();
  renderAll();
});

/* -------------------- UTILITIES --------------------- */
function severityFromScore(n) {
  if (n >= 8) return "excellent";
  if (n >= 6) return "good";
  if (n >= 4) return "okay";
  return "needs_work";
}

function pickSolution(cat, sev) {
  const key = `${cat}_solutions`;
  if (!Solutions[key] || !Solutions[key][sev]) return "";
  const arr = Solutions[key][sev];
  return arr[Math.floor(Math.random()*arr.length)];
}

function getWorstThree() {
  const cats = [
    "peaks_dips",
    "reflections",
    "bandwidth",
    "balance",
    "smoothness",
    "reverb"
  ];
  const scored = cats.map(c => ({
    category: c,
    score: data[c]
  }));
  scored.sort((a,b) => a.score - b.score);
  return scored.slice(0,3);
}

/* -------------------- COLOURCARDS --------------------- */

function getColorClassForScore(score) {
  if (score >= 8) {
    return {
      ring: "border-green-500",
      text: "text-green-600",
      dot: "bg-green-500",
      light: "bg-green-50 text-green-800"
    };
  }
  if (score >= 6) {
    return {
      ring: "border-yellow-500",
      text: "text-yellow-600",
      dot: "bg-yellow-500",
      light: "bg-yellow-50 text-yellow-800"
    };
  }
  if (score >= 4) {
    return {
      ring: "border-orange-500",
      text: "text-orange-600",
      dot: "bg-orange-500",
      light: "bg-orange-50 text-orange-800"
    };
  }
  return {
    ring: "border-red-500",
    text: "text-red-600",
    dot: "bg-red-500",
    light: "bg-red-50 text-red-800"
  };
}

/* -------------------- RENDER ALL --------------------- */
function renderAll() {
  renderKeyFindings();
  renderBuddyDeepDive();
  renderFreqInsights();
  renderRoomBehaviour();
  renderActionPlan();
}

/* -------------------- KEY FINDINGS --------------------- */
function renderKeyFindings() {
  const C = document.getElementById('priorityCards');
  const worst = getWorstThree();

  C.innerHTML = worst.map(w => {
    const sev = severityFromScore(w.score);
    const sol = pickSolution(w.category, sev);
    const col = getColorClassForScore(w.score);   // << GET COLOUR

    const name = ({
      peaks_dips: "Peaks & Dips",
      reflections: "Reflections",
      bandwidth: "Bandwidth",
      balance: "Balance",
      smoothness: "Smoothness",
      reverb: "Reverb"
    })[w.category];

    return `
      <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 ${col.ring}">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">${name}</h3>
        <p class="text-gray-700 mb-3">Score: ${w.score.toFixed(1)}</p>

        <div class="flex items-start bg-gray-100 rounded-lg p-3 text-sm text-gray-700">
          <img src="buddy-icon-100.svg" class="w-4 h-4 mr-2 opacity-90 mt-0.5">
          <span class="italic">${sol}</span>
        </div>
      </div>
    `;
  }).join('');
}

/* -------------------- DAVE DEEP DIVE --------------------- */
function renderBuddyDeepDive() {
  const C = document.getElementById('buddyDeepDive');
  const worst = getWorstThree();

  C.innerHTML = worst.map(w => {
    const sev = severityFromScore(w.score);
    const sol = pickSolution(w.category, sev);

    return `
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 leading-relaxed flex items-start">
        <img src="buddy-icon-100.svg" class="w-4 h-4 mr-2 opacity-90 mt-0.5">
        <span class="italic">${sol}</span>
      </div>
    `;
  }).join('');
}

/* -------------------- FREQUENCY INSIGHTS --------------------- */
function renderFreqInsights() {
  const C = document.getElementById('freqIssues');
  const bits = [];

  if (data.peaks_dips < 6) {
    const sev = severityFromScore(data.peaks_dips);
    bits.push({
      tech: "Your frequency response shows peaks or dips caused by room interactions and speaker distances.",
      sol: pickSolution("peaks_dips", sev)
    });
  }

  if (data.bandwidth < 6) {
    const sev = severityFromScore(data.bandwidth);
    bits.push({
      tech: "Bandwidth is limited in places, reducing punch and sparkle across the range.",
      sol: pickSolution("bandwidth", sev)
    });
  }

  if (bits.length === 0) {
    C.innerHTML = `<p class="text-gray-700">Your frequency response looks clean with no major issues.</p>`;
    return;
  }

  C.innerHTML = bits.map(b => `
    <div class="mb-4">
      <p class="text-gray-700">${b.tech}</p>

      <div class="flex items-start bg-gray-100 rounded-lg p-3 text-sm text-gray-700 mt-2">
        <img src="buddy-icon-100.svg" class="w-4 h-4 mr-2 opacity-90 mt-0.5">
        <span class="italic">${b.sol}</span>
      </div>

    </div>
  `).join('');
}

/* -------------------- ROOM BEHAVIOUR --------------------- */
function renderRoomBehaviour() {
  const C = document.getElementById('roomIssues');
  const bits = [];

  if (data.reflections < 6) {
    const sev = severityFromScore(data.reflections);
    bits.push({
      tech: "Reflections are affecting clarity and imaging.",
      sol: pickSolution("reflections", sev)
    });
  }

  if (data.reverb < 6) {
    const sev = severityFromScore(data.reverb);
    bits.push({
      tech: "Room decay characteristics could be improved for a cleaner response.",
      sol: pickSolution("reverb", sev)
    });
  }

  if (bits.length === 0) {
    C.innerHTML = `<p class="text-gray-700">The room behaviour appears well-controlled.</p>`;
    return;
  }

  C.innerHTML = bits.map(b => `
    <div class="mb-4">
      <p class="text-gray-700">${b.tech}</p>

      <div class="flex items-start bg-gray-100 rounded-lg p-3 text-sm text-gray-700 mt-2">
        <img src="buddy-icon-100.svg" class="w-4 h-4 mr-2 opacity-90 mt-0.5">
        <span class="italic">${b.sol}</span>
      </div>

    </div>
  `).join('');
}

/* -------------------- ACTION PLAN --------------------- */
function renderActionPlan() {
  const C = document.getElementById('actionPlan');
  const worst = getWorstThree();

  C.innerHTML = worst.map(w => {
    const sev = severityFromScore(w.score);
    const sol = pickSolution(w.category, sev);

    const name = ({
      peaks_dips: "Peaks & Dips",
      reflections: "Reflections",
      bandwidth: "Bandwidth",
      balance: "Balance",
      smoothness: "Smoothness",
      reverb: "Reverb"
    })[w.category];

    return `
      <div class="bg-gray-100 p-4 rounded-lg">
        <h4 class="font-semibold text-gray-800 mb-2">${name}</h4>

        <div class="flex items-start bg-gray-200 rounded-lg p-3 text-sm text-gray-700">
          <img src="buddy-icon-100.svg" class="w-4 h-4 mr-2 opacity-90 mt-0.5">
          <span class="italic">${sol}</span>
        </div>

      </div>
    `;
  }).join('');
}

</script>
</body>
</html>
