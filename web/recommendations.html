<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Measurely – Recommendations</title>
  <link rel="stylesheet" href="measurely.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .toast {
      position:fixed;top:1rem;right:1rem;padding:.75rem 1rem;border-radius:.5rem;color:#fff;font-size:.875rem;z-index:50;
      transform:translateX(120%);opacity:0;transition:transform .3s, opacity .3s;
    }
    .toast.show { transform:translateX(0);opacity:1; }
    .toast.error   { background:#ef4444; }
    .toast.success { background:#10b981; }
    .toast.info    { background:#3b82f6; }
  </style>
</head>

<body class="bg-gray-50">

<!-- Mobile-only banner -->
<div class="mobile-banner md:hidden fixed top-0 left-0 right-0 h-14 backdrop-blur-sm 
            flex items-center justify-between px-4 z-50">

  <!-- LEFT: Icon + name grouped together -->
  <div class="flex items-center space-x-2">
    <i class="fas fa-microchip text-xl text-white opacity-90"></i>
    <span class="text-white font-semibold text-sm">Measurely</span>
  </div>

  <!-- RIGHT: Menu button -->
  <button id="mobile-menu-btn" class="p-2 rounded-lg text-white hover:bg-white/10 transition">
    <i class="fas fa-bars text-lg"></i>
  </button>

</div>


<div id="sidebar-overlay" class="sidebar-overlay"></div>

<aside id="sidebar" class="sidebar gradient-bg fixed top-0 right-0 h-full w-64 text-white p-6 z-40">
  <div class="mb-8 flex items-center space-x-3">
    <i class="fas fa-microchip text-4xl opacity-90"></i>
    <div>
      <h1 class="text-2xl font-bold">Measurely</h1>
      <p class="text-sm opacity-80">Room Acoustic Analysis</p>
    </div>
  </div>
  <nav class="space-y-2">
    <a href="index.html" class="nav-item"><i class="fas fa-chart-line mr-3"></i>Dashboard</a>
    <a href="recommendations.html" class="nav-item active"><i class="fas fa-lightbulb mr-3"></i>Recommendations</a>
    <a href="room-setup.html" class="nav-item"><i class="fas fa-home mr-3"></i>Room Setup</a>
    <a href="sessions.html" class="nav-item"><i class="fas fa-history mr-3"></i>Sessions</a>
    <a href="settings.html" class="nav-item"><i class="fas fa-cog mr-3"></i>Settings</a>
  </nav>
  <div class="absolute bottom-6 left-6 right-6">
    <div class="bg-white bg-opacity-20 rounded-lg p-4">
      <div class="flex items-center mb-2">
        <div id="deviceStatusIndicator" class="status-indicator status-good pulse-animation"></div>
        <span id="deviceStatusText" class="text-sm">System Ready</span>
      </div>
      <p class="text-xs opacity-80">Last updated: <span id="lastUpdated">Now</span></p>
    </div>
  </div>
</aside>

<!-- =================  MAIN CONTENT  ================= -->
<div class="main-content md:ml-64 p-8">
  <div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Recommendations</h2>
    <p class="text-gray-600">Suggestions to optimise your audio setup based on your measurements</p>
  </div>

  <!-- 1.  PRIORITY  (buddy headline + fixes)  -->
  <div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">
      <i class="fas fa-exclamation-triangle mr-2"></i>Priority Recommendations
    </h2>
    <div id="priorityCards" class="space-y-4"><!-- live --></div>
  </div>

  <!-- 2.  FREQUENCY ISSUES  (per-band delta)  -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-chart-line mr-2"></i>Frequency Response Issues
      </h3>
      <div id="freqIssues" class="space-y-3 text-sm"><!-- live --></div>
      <div class="mt-4 p-3 bg-gray-100 rounded-lg text-sm text-gray-800" id="freqComment"><!-- live --></div>
    </div>

    <!-- 3.  TREATMENT PRIORITY  (ordered list)  -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-home mr-2"></i>Treatment Priority Guide
      </h3>
      <div id="treatmentSteps" class="space-y-4 text-sm"><!-- live --></div>
    </div>
  </div>

  <!-- 4.  ACTION PLAN  (week-by-week)  -->
  <div class="bg-white rounded-2xl shadow-lg p-6">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">
      <i class="fas fa-tasks mr-2"></i>Your Personalised Action Plan
    </h2>
    <div id="actionPlan" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm"><!-- live --></div>
    <div class="mt-4 p-4 bg-green-100 rounded-lg text-sm text-gray-800" id="expectedResult"><!-- live --></div>
  </div>
</div>

<!-- toast container -->
<div id="toast-container"></div>

<script>
/* ----------  Sidebar (same as dashboard) ---------- */
const btn  = document.getElementById('mobile-menu-btn');
const side = document.getElementById('sidebar');
const over = document.getElementById('sidebar-overlay');
function toggleMenu() {
  side.classList.toggle('active'); over.classList.toggle('active');
  document.body.style.overflow = side.classList.contains('active') ? 'hidden' : '';
}
btn.addEventListener('click', toggleMenu); over.addEventListener('click', toggleMenu);
document.querySelectorAll('.nav-item').forEach(link => {
  link.addEventListener('click', () => { if (window.innerWidth <= 768) toggleMenu(); });
});

/* ----------  Toast ---------- */
function toast(msg, type = 'info') {
  const box = document.createElement('div'); box.className = `toast ${type}`; box.textContent = msg;
  document.getElementById('toast-container').appendChild(box);
  setTimeout(() => box.classList.add('show'), 10);
  setTimeout(() => { box.classList.remove('show'); setTimeout(() => box.remove(), 300); }, 3000);
}

/* ----------  Fetch & Render ---------- */
let data = null;
async function load() {
  try {
    const res = await fetch('/api/latest'); if (!res.ok) throw new Error(res.statusText);
    data = await res.json(); if (!data) throw new Error('No data');
    render(); 
  } catch (e) { toast('Could not load recommendations', 'error'); console.error(e); }
}
function render() {
  renderPriorities(); renderFreqIssues(); renderTreatment(); renderActionPlan();
}

/* ----------  1.  PRIORITY  (buddy headline + fixes)  ---------- */
function renderPriorities() {
  const headline = (data.buddy_summary || "").trim() || data.notes?.[0] || "All good";
  const fixes    = data.buddy_actions  || data.simple_fixes || [];
  const combined = [headline, ...fixes];
  const container = document.getElementById('priorityCards');
  if (!combined.length) { container.innerHTML = '<p class="text-gray-600">No specific recommendations at the moment.</p>'; return; }
  container.innerHTML = combined.map((txt,i) => {
    const prio = i<2?'HIGH':i<4?'MEDIUM':'LOW';
    const col  = {HIGH:'red',MEDIUM:'yellow',LOW:'green'}[prio];
    return `<div class="bg-white rounded-2xl shadow-lg p-6 mb-4 border-l-4 border-${col}-500">
              <div class="flex items-start justify-between">
                <div>
                  <div class="flex items-center mb-2"><span class="bg-${col}-500 text-white px-2 py-1 rounded text-xs font-semibold mr-2">${prio}</span>
                    <h3 class="text-lg font-semibold text-gray-800">Improvement suggestion</h3></div>
                  <p class="text-gray-700 mb-2">${txt}</p>
                </div>
                <i class="fas fa-lightbulb text-${col}-500 text-2xl ml-4"></i>
              </div>
            </div>`;
  }).join('');
}

/* ----------  2.  FREQUENCY-BAND ISSUES  ---------- */
function renderFreqIssues() {
  const bands = [
    {name:'20-200 Hz (Bass)',      key:'bass_20_200',   good:[-4,4]},
    {name:'200-2 kHz (Mids)',      key:'mid_200_2k',    good:[-3,3]},
    {name:'2-10 kHz (Treble)',     key:'treble_2k_10k', good:[-2,2]},
    {name:'10-20 kHz (Air)',       key:'air_10k_20k',   good:[-4,4]}
  ];
  const bl = data.band_levels_db || {};
  const issues = document.getElementById('freqIssues');
  issues.innerHTML = bands.map(b => {
    const v = (bl[b.key] ?? 0).toFixed(1);
    const delta = v>0?`+${v} dB`: `${v} dB`;
    const ok = v>=b.good[0] && v<=b.good[1];
    const col = ok?'green':(Math.abs(v)>8?'red':'yellow');
    return `<div class="flex justify-between"><span class="text-gray-700">${b.name}</span><span class="text-${col}-600 font-medium">${delta}</span></div>`;
  }).join('');

  /* friendly blurb */
  const modes = data.modes || [];
  const boomy = modes.some(m => m.type==='peak' && m.freq_hz<120);
  const harsh = modes.some(m => m.type==='peak' && m.freq_hz>2000 && m.freq_hz<8000);
  const dull  = modes.some(m => m.type==='dip' && m.freq_hz>8000);
  let blurb = data.plain_summary || 'Your room response is reasonably flat.';
  if (boomy) blurb += '  A little boom below 120 Hz – pull speakers away from the wall.';
  if (harsh) blurb += '  Some harshness 2–8 kHz – try angling tweeters at ear height.';
  if (dull)  blurb += '  Top-end roll-off – add a rug or curtains to liven highs.';
  document.getElementById('freqComment').innerHTML = `<strong>What this means:</strong> ${blurb}`;
}

/* ----------  3.  TREATMENT PRIORITY  ---------- */
function renderTreatment() {
  const overall = data.overall_score || 0;
  const modes   = data.modes || [];
  const refs    = data.reflections_ms || [];

  let steps = [
    {prio:1, title:'Corner Bass Traps',        desc:'Floor-to-ceiling super-chunks eat low-end modes.',        show: overall < 6 || modes.some(m=>m.freq_hz<120) },
    {prio:2, title:'First-Reflection Panels',  desc:'Kill side-wall and ceiling echoes; widens stereo image.', show: refs.length > 5 },
    {prio:3, title:'Ceiling Cloud',            desc:'Absorber above listening position tames vertical flutter.', show: overall < 7 },
    {prio:4, title:'Rear-Wall Diffusion',      desc:'Scatter reflections behind you to keep room “alive”.',    show: overall >= 7 }
  ].filter(s=>s.show);   // only show relevant steps

  const colours = {1:'red',2:'yellow',3:'green',4:'blue'};
  const container = document.getElementById('treatmentSteps');
  container.innerHTML = steps.map((s,i) => `
    <div class="flex items-start">
      <div class="w-6 h-6 bg-${colours[s.prio]}-500 rounded-full text-white text-xs font-bold flex items-center justify-center mr-3 mt-0.5">${i+1}</div>
      <div><h4 class="font-medium text-gray-800">${s.title}</h4><p class="text-gray-600">${s.desc}</p></div>
    </div>`).join('');
}

/* ----------  4.  ACTION PLAN  (week-by-week)  ---------- */
function renderActionPlan() {
  /* pick plan based on biggest problem */
  const overall = data.overall_score || 0;
  const refs    = (data.reflections_ms || []).length;
  const rt60    = data.rt60_s;
  let weeks = [
    {w:'Week 1', tasks:['Run a sweep','Note biggest problem','Move speakers 20 cm from wall']},
    {w:'Week 2', tasks:['Install corner bass traps','Re-measure','Celebrate lower boom']},
    {w:'Week 3', tasks:['Add first-reflection panels','Check stereo image','Fine-tune toe-in']}
  ];
  if (overall < 5) weeks = [
    {w:'Week 1', tasks:['Install 4× corner traps','Add rug','Re-sweep']},
    {w:'Week 2', tasks:['Treat side walls','Cloud above head','Re-sweep']},
    {w:'Week 3', tasks:['Diffuse rear wall','Final sweep','Mix a song!']}
  ];
  if (refs > 15) weeks[0].tasks.unshift('Add thick rug + curtains');   /* lots of early energy */
  if (rt60 && rt60 > 0.6) weeks[1].tasks.push('Hang ceiling cloud'); /* too live */

  document.getElementById('actionPlan').innerHTML = weeks.map(wk => `
    <div class="bg-gray-100 p-4 rounded-lg">
      <h4 class="font-semibold text-gray-800 mb-2">${wk.w}</h4>
      <ul class="text-gray-700 space-y-1">${wk.tasks.map(t=>`<li>• ${t}</li>`).join('')}</ul>
    </div>`).join('');

  /* expected outcome */
  const gain = Math.min(2.5, (10 - overall) * 0.4);
  document.getElementById('expectedResult').innerHTML =
    `<i class="fas fa-lightbulb mr-2 text-green-600"></i><strong>Expected result:</strong>
     Following this plan should lift your overall score from <strong>${overall.toFixed(1)}</strong>
     to around <strong>${Math.min(10, overall + gain).toFixed(1)}</strong>, giving you a much more accurate mixing environment.`;
}

/* ----------  Clock  ---------- */
setInterval(() => {
  const el = document.getElementById('lastUpdated');
  if (el) el.textContent = new Date().toLocaleTimeString();
}, 1000);

/* ----------  Boot  ---------- */
document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>