<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Measurely – Recommendations</title>
  <link rel="stylesheet" href="measurely.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.0.3/plotly.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .card-sky   { background-color: #f0f9ff; }
    .card-amber { background-color: #fffbeb; }
    .toast {
      position:fixed;top:1rem;right:1rem;padding:.75rem 1rem;border-radius:.5rem;color:#fff;font-size:.875rem;z-index:50;
      transform:translateX(120%);opacity:0;transition:transform .3s, opacity .3s;
    }
    .toast.show { transform:translateX(0);opacity:1; }
    .toast.error   { background:#ef4444; }
    .toast.success { background:#10b981; }
    .toast.info    { background:#3b82f6; }
  </style>
</head>

<body class="bg-gray-50">
<!-- ----------  MOBILE MENU  ---------- -->
<button id="mobile-menu-btn" class="mobile-menu-button fixed top-4 right-4 z-50 p-2 rounded-lg bg-gray-900/80 text-white backdrop-blur-sm">
  <i class="fas fa-bars text-xl"></i>
</button>
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<!-- ----------  SIDEBAR  ---------- -->
<aside id="sidebar" class="sidebar gradient-bg fixed top-0 right-0 h-full w-64 text-white p-6 z-40">
  <div class="mb-8">
    <h1 class="text-2xl font-bold mb-2">Measurely</h1>
    <p class="text-sm opacity-80">Room Acoustic Analysis</p>
  </div>
  <nav class="space-y-2">
    <a href="index.html" class="nav-item"><i class="fas fa-chart-line mr-3"></i>Dashboard</a>
    <a href="analysis.html" class="nav-item"><i class="fas fa-wave-square mr-3"></i>Frequency Analysis</a>
    <a href="recommendations.html" class="nav-item active"><i class="fas fa-lightbulb mr-3"></i>Recommendations</a>
    <a href="room-setup.html" class="nav-item"><i class="fas fa-home mr-3"></i>Room Setup</a>
    <a href="sessions.html" class="nav-item"><i class="fas fa-history mr-3"></i>Sessions</a>
    <a href="settings.html" class="nav-item"><i class="fas fa-cog mr-3"></i>Settings</a>
  </nav>
  <div class="absolute bottom-6 left-6 right-6">
    <div class="bg-white bg-opacity-20 rounded-lg p-4">
      <div class="flex items-center mb-2">
        <div id="deviceStatusIndicator" class="status-indicator status-good pulse-animation"></div>
        <span id="deviceStatusText" class="text-sm">System Ready</span>
      </div>
      <p class="text-xs opacity-80">Last updated: <span id="lastUpdated">Now</span></p>
    </div>
  </div>
</aside>

<!-- ----------  MAIN CONTENT  ---------- -->
<div class="main-content ml-64 p-8">
  <div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">AI-Powered Recommendations</h2>
    <p class="text-gray-600">Smart suggestions to optimise your audio setup based on your measurements</p>
  </div>

  <!-- Live-scored status card -->
  <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-chart-pie mr-2"></i>Current Audio Health Score</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center" id="scoreGrid">
      <!-- filled by JS -->
    </div>
  </div>

  <!-- Priority recommendations (built from live notes/simple_fixes) -->
  <div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Priority Recommendations</h2>
    <div id="priorityCards">
      <!-- filled by JS -->
    </div>
  </div>

  <!-- Detailed frequency issues -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-chart-line mr-2"></i>Frequency Response Issues</h3>
      <div id="freqIssues" class="space-y-3 text-sm">
        <!-- filled by JS -->
      </div>
      <div class="mt-4 p-3 bg-gray-100 rounded-lg text-sm text-gray-800" id="freqComment"></div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-home mr-2"></i>Treatment Priority Guide</h3>
      <div id="treatmentSteps" class="space-y-4 text-sm">
        <!-- filled by JS -->
      </div>
    </div>
  </div>

  <!-- Action plan -->
  <div class="bg-white rounded-2xl shadow-lg p-6">
    <h2 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-tasks mr-2"></i>Your Personalised Action Plan</h2>
    <div id="actionPlan" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
      <!-- filled by JS -->
    </div>
    <div class="mt-4 p-4 bg-green-100 rounded-lg text-sm text-gray-800" id="expectedResult"></div>
  </div>
</div>

<!-- toast container -->
<div id="toast-container"></div>

<script>
/* ----------  Sidebar (same as dashboard) ---------- */
const btn  = document.getElementById('mobile-menu-btn');
const side = document.getElementById('sidebar');
const over = document.getElementById('sidebar-overlay');
function toggleMenu() {
  side.classList.toggle('active'); over.classList.toggle('active');
  document.body.style.overflow = side.classList.contains('active') ? 'hidden' : '';
}
btn.addEventListener('click', toggleMenu); over.addEventListener('click', toggleMenu);
document.querySelectorAll('.nav-item').forEach(link => {
  link.addEventListener('click', () => { if (window.innerWidth <= 768) toggleMenu(); });
});

/* ----------  Toast ---------- */
function toast(msg, type = 'info') {
  const box = document.createElement('div'); box.className = `toast ${type}`; box.textContent = msg;
  document.getElementById('toast-container').appendChild(box);
  setTimeout(() => box.classList.add('show'), 10);
  setTimeout(() => { box.classList.remove('show'); setTimeout(() => box.remove(), 300); }, 3000);
}

/* ----------  Fetch & Render ---------- */
let data = null;
async function load() {
  try {
    const res = await fetch('/api/latest'); if (!res.ok) throw new Error(res.statusText);
    data = await res.json(); if (!data) throw new Error('No data');
    render(); 
  } catch (e) { toast('Could not load recommendations', 'error'); console.error(e); }
}
function render() {
  renderScores(); renderPriorities(); renderFreqIssues(); renderTreatment(); renderActionPlan();
}
function scoreColour(s) { return s>=7?'green':s>=4?'yellow':'red'; }
function scoreWord(s)  { return s>=7?'Good':s>=4?'Fair':'Poor'; }

/* ----------  Top-row score cards ---------- */
function renderScores() {
  const sections = ['overall','bandwidth','balance','smoothness','peaks_dips','reflections','reverb'];
  const grid = document.getElementById('scoreGrid');
  grid.innerHTML = sections.map(k => {
    const v = (data[k]||0).toFixed(1);
    const col = scoreColour(v);
    return `<div class="p-4 bg-${col}-50 rounded-lg">
              <div class="text-2xl font-bold text-${col}-600">${v}</div>
              <div class="text-sm text-gray-600">${k.replace('_',' ')}</div>
            </div>`;
  }).join('');
}

/* ----------  Priority recommendation cards ---------- */
function renderPriorities() {
  const notes = data.analysis_notes||[], fixes = data.simple_fixes||[];
  const combined = [...notes, ...fixes];
  const container = document.getElementById('priorityCards');
  if (!combined.length) { container.innerHTML = '<p class="text-gray-600">No specific recommendations at the moment.</p>'; return; }
  container.innerHTML = combined.map((txt,i) => {
    const prio = i<2?'HIGH':i<4?'MEDIUM':'LOW';
    const col  = {HIGH:'red',MEDIUM:'yellow',LOW:'green'}[prio];
    return `<div class="bg-white rounded-2xl shadow-lg p-6 mb-4 border-l-4 border-${col}-500">
              <div class="flex items-start justify-between">
                <div>
                  <div class="flex items-center mb-2"><span class="bg-${col}-500 text-white px-2 py-1 rounded text-xs font-semibold mr-2">${prio}</span>
                    <h3 class="text-lg font-semibold text-gray-800">Improvement suggestion</h3></div>
                  <p class="text-gray-700 mb-2">${txt}</p>
                </div>
                <i class="fas fa-lightbulb text-${col}-500 text-2xl ml-4"></i>
              </div>
            </div>`;
  }).join('');
}

/* ----------  Frequency-band issues ---------- */
function renderFreqIssues() {
  const bl = data.band_levels_db||{};
  const issues = document.getElementById('freqIssues');
  const bands = [
    {name:'20-80 Hz (Sub-bass)',     key:'bass_20_200',   good:[-4,4]},
    {name:'200-500 Hz (Low mids)',  key:'mid_200_2k',    good:[-3,3]},
    {name:'2-8 kHz (Presence)',     key:'treble_2k_10k', good:[-2,2]},
    {name:'8-20 kHz (Air)',         key:'air_10k_20k',   good:[-4,4]}
  ];
  issues.innerHTML = bands.map(b => {
    const v = (bl[b.key]||0).toFixed(1);
    const delta = v>0?`+${v} dB`: `${v} dB`;
    const ok = v>=b.good[0]&&v<=b.good[1];
    const col = ok?'green':(Math.abs(v)>8?'red':'yellow');
    return `<div class="flex justify-between"><span class="text-gray-700">${b.name}</span><span class="text-${col}-600 font-medium">${delta}</span></div>`;
  }).join('');
  document.getElementById('freqComment').innerHTML =
    `<strong>What this means:</strong> ${data.plain_summary||'Your room response is reasonably flat.'}`;
}

/* ----------  Treatment priority list ---------- */
function renderTreatment() {
  const steps = [
    {prio:1,title:'Corner Bass Traps',        desc:'Install in all four corners, floor to ceiling'},
    {prio:2,title:'First Reflection Points',  desc:'Treat side walls at speaker height'},
    {prio:3,title:'Ceiling Cloud',            desc:'Absorption above listening position'},
    {prio:4,title:'Rear Wall Diffusion',      desc:'Scatter reflections behind you'}
  ];
  const container = document.getElementById('treatmentSteps');
  const colours = {1:'red',2:'yellow',3:'green',4:'blue'};
  container.innerHTML = steps.map(s => `
    <div class="flex items-start">
      <div class="w-6 h-6 bg-${colours[s.prio]}-500 rounded-full text-white text-xs font-bold flex items-center justify-center mr-3 mt-0.5">${s.prio}</div>
      <div><h4 class="font-medium text-gray-800">${s.title}</h4><p class="text-gray-600">${s.desc}</p></div>
    </div>`).join('');
}

/* ----------  Action plan ---------- */
function renderActionPlan() {
  const weeks = [
    {w:'Week 1-2', tasks:['Install corner bass traps','Measure improvements','Adjust speaker positioning']},
    {w:'Week 3-4', tasks:['Add first-reflection panels','Fine-tune speaker angles','Test with reference tracks']},
    {w:'Month 2',  tasks:['Install ceiling treatment','Add rear-wall diffusion','Final optimisation sweep']}
  ];
  document.getElementById('actionPlan').innerHTML = weeks.map(wk => `
    <div class="bg-gray-100 p-4 rounded-lg">
      <h4 class="font-semibold text-gray-800 mb-2">${wk.w}</h4>
      <ul class="text-gray-700 space-y-1">${wk.tasks.map(t=>`<li>• ${t}</li>`).join('')}</ul>
    </div>`).join('');
  document.getElementById('expectedResult').innerHTML =
    `<i class="fas fa-lightbulb mr-2 text-green-600"></i><strong>Expected result:</strong>
     Following this plan should improve your overall score from <strong>${(data.overall||0).toFixed(1)}</strong>
     to around <strong>${Math.min(10,(data.overall||0)+2.5).toFixed(1)}</strong>, giving you a much more accurate mixing environment.`;
}

/* ----------  Clock ---------- */
setInterval(() => {
  const el = document.getElementById('lastUpdated');
  if (el) el.textContent = new Date().toLocaleTimeString();
}, 1000);

/* ----------  Init ---------- */
document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>