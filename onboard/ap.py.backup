#!/usr/bin/env python3
"""
Measurely WiFi Configuration Portal
Serves a captive portal for initial WiFi setup on first boot
"""

import os
import subprocess
import json
import re
import time
from flask import Flask, render_template, request, jsonify, redirect, url_for
import threading

app = Flask(__name__)
app.config['SECRET_KEY'] = 'measurely-wifi-setup-secret-key'

# Configuration
CONFIG_FILE = '/etc/measurely/wifi_config.json'
WPA_SUPPLICANT_CONF = '/etc/wpa_supplicant/wpa_supplicant.conf'
HOSTAPD_CONF = '/etc/hostapd/hostapd.conf'
DNSMASQ_CONF = '/etc/dnsmasq.conf'

class WiFiManager:
    def __init__(self):
        self.interface = self.get_wifi_interface()
        
    def get_wifi_interface(self):
        """Get the WiFi interface name"""
        try:
            result = subprocess.run(['iwconfig'], capture_output=True, text=True)
            for line in result.stdout.split('\n'):
                if 'IEEE 802.11' in line:
                    return line.split()[0]
        except:
            pass
        return 'wlan0'
    
    def scan_networks(self):
        """Scan for available WiFi networks"""
        try:
            # Trigger scan
            subprocess.run(['sudo', 'iwlist', self.interface, 'scan'], 
                         capture_output=True, text=True)
            time.sleep(2)
            
            # Get scan results
            result = subprocess.run(['sudo', 'iwlist', self.interface, 'scan'], 
                                  capture_output=True, text=True)
            
            networks = []
            current_network = {}
            
            for line in result.stdout.split('\n'):
                line = line.strip()
                if 'Cell' in line and 'Address:' in line:
                    if current_network:
                        networks.append(current_network)
                    current_network = {'bssid': line.split('Address: ')[1]}
                elif 'ESSID:' in line:
                    essid = line.split('ESSID:"')[1].split('"')[0]
                    current_network['ssid'] = essid
                elif 'Encryption key:' in line:
                    current_network['encrypted'] = 'on' in line
                elif 'IE: IEEE 802.11i/WPA2' in line:
                    current_network['security'] = 'WPA2'
                elif 'IE: WPA Version 1' in line:
                    current_network['security'] = 'WPA'
                elif 'Encryption key:off' in line:
                    current_network['security'] = 'Open'
                    
            if current_network:
                networks.append(current_network)
                
            # Remove duplicates and sort by signal strength
            seen = set()
            unique_networks = []
            for net in networks:
                if net['ssid'] and net['ssid'] not in seen:
                    seen.add(net['ssid'])
                    unique_networks.append(net)
            
            return unique_networks
            
        except Exception as e:
            print(f"Error scanning networks: {e}")
            return []
    
    def connect_to_network(self, ssid, password):
        """Connect to WiFi network"""
        try:
            # Create wpa_supplicant configuration
            config = f"""country=US
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1

network={{
    ssid="{ssid}"
    psk="{password}"
    key_mgmt=WPA-PSK
}}
"""
            
            # Write configuration
            with open('/tmp/wpa_supplicant.conf', 'w') as f:
                f.write(config)
            
            # Copy to proper location
            subprocess.run(['sudo', 'cp', '/tmp/wpa_supplicant.conf', 
                          WPA_SUPPLICANT_CONF], check=True)
            
            # Restart networking
            subprocess.run(['sudo', 'systemctl', 'restart', 'wpa_supplicant'], 
                         check=True)
            subprocess.run(['sudo', 'systemctl', 'restart', 'dhcpcd'], 
                         check=True)
            
            # Wait for connection
            time.sleep(10)
            
            # Check if connected
            result = subprocess.run(['iwconfig', self.interface], 
                                  capture_output=True, text=True)
            
            if ssid in result.stdout:
                # Save configuration
                self.save_config({'ssid': ssid, 'configured': True})
                return True
                
            return False
            
        except Exception as e:
            print(f"Error connecting to network: {e}")
            return False
    
    def save_config(self, config):
        """Save WiFi configuration"""
        try:
            os.makedirs(os.path.dirname(CONFIG_FILE), exist_ok=True)
            with open(CONFIG_FILE, 'w') as f:
                json.dump(config, f)
        except Exception as e:
            print(f"Error saving config: {e}")
    
    def is_configured(self):
        """Check if WiFi is already configured"""
        try:
            if os.path.exists(CONFIG_FILE):
                with open(CONFIG_FILE, 'r') as f:
                    config = json.load(f)
                    return config.get('configured', False)
        except:
            pass
        return False

wifi_manager = WiFiManager()

@app.route('/')
def index():
    """Main configuration page"""
    return render_template('wifi_setup.html')

@app.route('/scan')
def scan_networks():
    """Scan for available networks"""
    networks = wifi_manager.scan_networks()
    return jsonify({'networks': networks})

@app.route('/connect', methods=['POST'])
def connect():
    """Connect to selected network"""
    data = request.json
    ssid = data.get('ssid')
    password = data.get('password')
    
    if not ssid or not password:
        return jsonify({'success': False, 'error': 'SSID and password required'})
    
    success = wifi_manager.connect_to_network(ssid, password)
    
    if success:
        # Schedule shutdown of AP mode
        def shutdown_ap():
            time.sleep(5)
            subprocess.run(['sudo', 'systemctl', 'stop', 'measurely-ap'])
        
        threading.Thread(target=shutdown_ap).start()
        
        return jsonify({'success': True})
    else:
        return jsonify({'success': False, 'error': 'Failed to connect'})

@app.route('/status')
def status():
    """Check connection status"""
    try:
        result = subprocess.run(['iwconfig', wifi_manager.interface], 
                              capture_output=True, text=True)
        connected = 'ESSID:' in result.stdout and 'off/any' not in result.stdout
        
        return jsonify({
            'connected': connected,
            'status': result.stdout
        })
    except:
        return jsonify({'connected': False})

@app.route('/complete')
def complete():
    """Setup complete page"""
    return render_template('setup_complete.html')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=80, debug=True)